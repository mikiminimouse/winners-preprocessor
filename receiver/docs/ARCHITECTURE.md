# Архитектура компонентов Preprocessing

## Обзор

Этот документ описывает архитектуру активных компонентов в `receiver/`, которые отвечают за синхронизацию данных из удаленной MongoDB и загрузку документов с zakupki.gov.ru.

## Активные компоненты

### 1. receiver/sync_db
**Назначение**: Синхронизация протоколов из удаленной MongoDB в локальную

**Основные функции**:
- Подключение к удаленной MongoDB через VPN с SSL
- Синхронизация коллекции `protocols223.purchaseProtocol`
- Создание уникальных `unit_id` для каждого протокола
- Хранение полной информации протокола с сервисными полями
- Предотвращение дубликатов по `purchaseNoticeNumber` и `source`

**Ключевые классы**:
- `EnhancedSyncService`: Основной сервис синхронизации с улучшенной обработкой ошибок
- `EnhancedSyncResult`: Результат синхронизации с детальной статистикой

### 2. receiver/downloader
**Назначение**: Загрузка документов по URL из записей протоколов

**Основные функции**:
- Проверка доступности zakupki.gov.ru через VPN
- Загрузка документов по URL из синхронизированных протоколов
- Параллельная загрузка файлов с настраиваемым уровнем конкурентности
- Обработка ошибок загрузки с детальной статистикой

**Ключевые классы**:
- `EnhancedProtocolDownloader`: Улучшенный загрузчик с параллельной обработкой
- `DownloadResult`: Результат загрузки с метриками

### 3. receiver/scheduler
**Назначение**: Планирование и автоматический запуск задач

**Основные функции**:
- Запуск синхронизации по расписанию (ежедневно)
- Запуск обработки документов по расписанию
- Интеграция с APScheduler для cron-подобного планирования

**Ключевые классы**:
- `SyncJob`: Задача синхронизации протоколов
- `ProcessingJob`: Задача обработки документов

## Структура директорий

```
receiver/
├── sync_db/          # Компонент синхронизации
├── downloader/       # Компонент загрузки
├── scheduler/        # Компонент планирования
├── cli/              # Интерфейс командной строки
├── core/             # Ядро системы
├── docs/             # Документация
└── tests/            # Тесты
```

## Поток данных

### Этап 1: Синхронизация (sync_db)
```
Удаленная MongoDB (VPN) → Локальная MongoDB → Протоколы с метаданными
```

### Этап 2: Загрузка (downloader)
```
Локальная MongoDB (протоколы) → Загрузка файлов → final_receiver/Data/YYYY-MM-DD/Input/
```

### Этап 3: Обработка (final_receiver/docprep)
```
final_receiver/Data/YYYY-MM-DD/Input/ → final_receiver/docprep → Ready2Docling
```

## Конфигурация

### Переменные среды
```bash
# Удаленная MongoDB (для протоколов)
MONGO_SERVER=192.168.0.46:8635
MONGO_USER=readProtocols223
MONGO_PASSWORD=your_password
MONGO_SSL_CERT=/path/to/certificate.crt
MONGO_PROTOCOLS_DB=protocols223
MONGO_PROTOCOLS_COLLECTION=purchaseProtocol

# Локальная MongoDB (для метаданных)
MONGO_METADATA_SERVER=localhost:27018
LOCAL_MONGO_SERVER=localhost:27018
MONGO_METADATA_USER=admin
MONGO_METADATA_PASSWORD=your_password
MONGO_METADATA_DB=docling_metadata
```

## Интеграция с final_preprocessing

### Поток данных
1. **receiver/sync_db** → Синхронизирует протоколы в локальную MongoDB
2. **receiver/downloader** → Загружает файлы в `final_preprocessing/Data/YYYY-MM-DD/Input/`
3. **final_preprocessing/docprep** → Обрабатывает файлы из Input директории
4. **Результат** → Готовые документы в `final_preprocessing/Data/YYYY-MM-DD/Ready2Docling/`

## CLI Интерфейс

### Основные команды
```bash
# Синхронизация
python -m receiver.sync_db.enhanced_service sync-date --date 2024-01-15
python -m receiver.sync_db.enhanced_service sync-daily

# Загрузка
python -m receiver.downloader.enhanced_service --limit 100

# Проверка здоровья
python -m receiver.sync_db.health_checks --check all
```

## Мониторинг и логирование

### Уровни логирования
- **INFO**: Основные события и операции
- **WARNING**: Предупреждения и некритические ошибки
- **ERROR**: Критические ошибки и сбои
- **DEBUG**: Подробная отладочная информация

### Метрики
- Количество синхронизированных протоколов
- Количество успешно загруженных файлов
- Время выполнения операций
- Количество ошибок по категориям

## Безопасность

### Аутентификация
- Использование SSL/TLS для удаленной MongoDB
- Аутентификация через параметры среды
- Защита учетных данных

### Доступ
- VPN требуется для доступа к удаленной MongoDB
- Локальная MongoDB доступна только через localhost
- Ограничение прав доступа к данным

## Масштабируемость

### Горизонтальное масштабирование
- Настройка уровня параллелизма для загрузки
- Настройка размера батчей для синхронизации
- Ограничение количества одновременных подключений

### Вертикальное масштабирование
- Настройка таймаутов подключения
- Оптимизация использования памяти
- Настройка размеров пула подключений