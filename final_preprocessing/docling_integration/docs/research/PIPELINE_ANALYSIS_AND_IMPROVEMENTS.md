# Полный анализ Pipeline: DocPrep + Docling Integration

**Дата:** 2025-12-24  
**Версия:** 1.0

## Содержание

1. [Архитектура системы](#архитектура-системы)
2. [Компоненты DocPrep](#компоненты-docprep)
3. [Компоненты Docling Integration](#компоненты-docling-integration)
4. [Процесс обработки документов](#процесс-обработки-документов)
5. [Выявленные проблемы](#выявленные-проблемы)
6. [Рекомендации по улучшению](#рекомендации-по-улучшению)
7. [Реализованные улучшения](#реализованные-улучшения)

---

## Архитектура системы

### Общая схема обработки

```
Input → DocPrep → Ready2Docling → Docling Integration → OutputDocling
```

**Этапы:**
1. **DocPrep**: Предобработка документов (классификация, конвертация, нормализация)
2. **Ready2Docling**: Финальная сборка UNIT для обработки Docling
3. **Docling Integration**: Обработка через IBM Docling (семантическое понимание)
4. **OutputDocling**: Экспорт результатов в JSON/Markdown/MongoDB

---

## Компоненты DocPrep

### 1. Core компоненты (`docprep/core/`)

#### 1.1. Config (`config.py`)
**Назначение**: Управление конфигурацией и структурой директорий.

**Функции**:
- Инициализация структуры директорий для даты
- Получение путей для циклов обработки
- Управление базовыми директориями (Input, Processing, Merge, Exceptions, Ready2Docling)

#### 1.2. State Machine (`state_machine.py`)
**Назначение**: Управление переходами состояний UNIT.

**Состояния**:
- `RAW` → `CLASSIFIED_N` → `PENDING_*` → `MERGED_*` → `READY_FOR_DOCLING`
- `EXCEPTION_N` для ошибок обработки

#### 1.3. Manifest (`manifest.py`)
**Назначение**: Хранение метаданных и истории обработки UNIT (manifest v2).

**Структура**:
- Метаданные UNIT (unit_id, protocol_id, protocol_date)
- История обработки (state_trace, operations)
- Информация о файлах (files, detection, classification)
- Routing информация (route, category)

#### 1.4. Contract (`contract.py`)
**Назначение**: Генерация контрактного слоя для Docling (`docprep.contract.json`).

**Функции**:
- Генерация contract из manifest
- Определение route для Docling
- Валидация контракта

#### 1.5. Audit (`audit.py`)
**Назначение**: Логирование операций обработки в `audit.log.jsonl`.

---

### 2. Engine компоненты (`docprep/engine/`)

#### 2.1. Classifier (`classifier.py`)
**Назначение**: Классификация UNIT по типу файлов и категориям.

**Функции**:
- Определение типа файла (MIME, signature, extension)
- Классификация категории (direct, convert, extract, normalize, special, mixed, ambiguous)
- Решение конфликтов между MIME, signature и extension
- Маршрутизация UNIT в соответствующие директории

**Стадии**:
1. Анализ файлов UNIT
2. Определение типа файла (detect_file_type)
3. Классификация категории
4. Решение конфликтов (Decision Engine)
5. Маршрутизация UNIT

#### 2.2. Converter (`converter.py`)
**Назначение**: Конвертация файлов (DOC → DOCX, XLS → XLSX, PPT → PPTX, RTF → DOCX).

**Поддерживаемые форматы**:
- DOC → DOCX
- XLS → XLSX
- PPT → PPTX
- RTF → DOCX

#### 2.3. Extractor (`extractor.py`)
**Назначение**: Извлечение файлов из архивов (ZIP, RAR, 7Z).

**Функции**:
- Распаковка архивов
- Извлечение вложенных архивов
- Обработка поврежденных архивов

#### 2.4. Normalizer (`normalizer.py`)
**Назначение**: Нормализация файлов (переименование, очистка).

**Функции**:
- Нормализация имен файлов
- Очистка метаданных
- Стандартизация форматов

#### 2.5. Merger (`merger.py`)
**Назначение**: Объединение UNIT из Merge директорий в Ready2Docling.

**Функции**:
- Сборка UNIT из Merge_0/Direct, Merge_1, Merge_2, Merge_3
- Сортировка по расширениям (docx/, pdf/text/, pdf/scan/, xlsx/, и т.д.)
- Фильтрация неподдерживаемых форматов
- Генерация `docprep.contract.json`

**Фильтрация**:
- UNIT с `route='mixed'` не попадают в Ready2Docling
- Архивы (ZIP, RAR, 7Z) отфильтровываются
- Бинарные файлы (EXE, DLL, BIN) отфильтровываются

---

### 3. Adapters (`docprep/adapters/`)

#### 3.1. DoclingAdapter (`docling.py`)
**Назначение**: Адаптер для подготовки UNIT к обработке Docling.

**Функции**:
- Построение AST nodes из manifest
- Определение главного файла документа
- Извлечение метаданных для Docling

---

## Компоненты Docling Integration

### 1. Bridge (`bridge_docprep.py`)
**Назначение**: Мост между DocPrep и Docling.

**Функции**:
- Загрузка UNIT из Ready2Docling
- Загрузка `docprep.contract.json`
- Получение главного файла для обработки
- Подготовка данных для Docling

### 2. Config (`config.py`)
**Назначение**: Конфигурация Docling PipelineOptions.

**Функции**:
- Загрузка YAML templates для разных routes
- Построение PipelineOptions из templates
- Маппинг route → InputFormat
- Fallback на legacy hardcoded конфигурацию

**Поддерживаемые routes**:
- `pdf_text`, `pdf_scan`, `pdf_scan_table`
- `docx`, `xlsx`, `pptx`
- `html`, `xml`
- `image_ocr`

### 3. Runner (`runner.py`)
**Назначение**: Запуск Docling DocumentConverter.

**Функции**:
- Инициализация DocumentConverter с PipelineOptions
- Вызов `converter.convert()`
- Обработка ConversionResult

### 4. Pipeline (`pipeline.py`)
**Назначение**: Основной orchestration pipeline.

**Последовательность**:
1. Загрузка UNIT через bridge_docprep
2. Построение Docling options через config
3. Запуск конвертации через runner
4. Экспорт результатов через exporters

**Функции**:
- `process_unit()` - обработка одного UNIT
- `process_directory()` - обработка всех UNIT в директории
- `_quarantine_unit()` - перемещение проблемных UNIT в Quarantine

### 5. Exporters (`exporters/`)

#### 5.1. JSON (`json.py`)
**Назначение**: Экспорт DoclingDocument в JSON.

**Функции**:
- Сериализация DoclingDocument через `model_dump()`
- Добавление метаданных экспорта

#### 5.2. Markdown (`markdown.py`)
**Назначение**: Экспорт DoclingDocument в Markdown с сохранением структуры.

**Функции**:
- Извлечение структурированного контента (body → groups → texts)
- Форматирование заголовков, абзацев, списков, таблиц, изображений
- Сохранение layout документа (отступы, форматирование)

**Структура**:
- `_extract_structured_content()` - извлечение структуры
- `_process_element_recursive()` - рекурсивная обработка иерархии
- `_format_text_element()` - форматирование текстовых элементов
- `_table_to_markdown()` - конвертация таблиц
- `_picture_to_markdown()` - конвертация изображений

#### 5.3. MongoDB (`mongodb.py`)
**Назначение**: Экспорт в MongoDB (если настроен).

---

## Процесс обработки документов

### DocPrep Pipeline

#### Цикл 1
1. **Input** → Классификация → **Processing_1/**
   - Direct файлы → **Merge_0/Direct/**
   - Convert → **Processing_1/Convert/**
   - Extract → **Processing_1/Extract/**
   - Normalize → **Processing_1/Normalize/**
   - Special/Mixed/Ambiguous → **Exceptions_1/**

2. Обработка в Processing_1:
   - Converter → конвертация файлов
   - Extractor → извлечение архивов
   - Normalizer → нормализация

3. Повторная классификация → **Processing_2/** или **Merge_1/**

#### Цикл 2-3
- Аналогично циклу 1, но для повторно обработанных UNIT
- Максимум 3 цикла обработки

#### Финальный Merge
- Сборка из Merge_0/Direct, Merge_1, Merge_2, Merge_3 → **Ready2Docling/**
- Сортировка по расширениям
- Фильтрация неподдерживаемых форматов
- Генерация `docprep.contract.json`

### Docling Integration Pipeline

1. **Ready2Docling** → Загрузка UNIT через bridge_docprep
   - Загрузка `docprep.contract.json`
   - Получение главного файла

2. Построение Docling options:
   - Загрузка YAML template для route
   - Построение PipelineOptions

3. Конвертация через Docling:
   - Инициализация DocumentConverter
   - Вызов `converter.convert()`
   - Получение ConversionResult

4. Экспорт результатов:
   - JSON → `OutputDocling/{extension}/{unit_id}/{unit_id}.json`
   - Markdown → `OutputDocling/{extension}/{unit_id}/{unit_id}.md`
   - MongoDB (если настроен)

---

## Выявленные проблемы

### 1. Проблемы с layout документов

**Проблема**: При экспорте в Markdown теряется структура документа:
- Заголовки не форматируются правильно (нет ##, ###)
- Списки не сохраняют отступы
- Абзацы сливаются в один текст
- Таблицы дублируются (заголовки таблиц выводятся отдельно)

**Причина**:
- Текущая реализация Markdown экспорта не правильно обрабатывает иерархию body → groups → texts
- Не учитываются CREF ссылки для навигации по структуре
- Форматирование применяется только к отдельным текстовым элементам, без учета контекста

### 2. Проблемы с русским языком в PDF

**Проблема**: При извлечении текста из PDF с русским языком могут возникать проблемы с кодировкой и распознаванием символов.

**Причина**:
- По умолчанию Docling использует стандартные настройки для английского языка
- Не настроена поддержка кириллицы и UTF-8
- Для pdf_text не используются специальные настройки для русского языка

### 3. Недостаточная обработка структуры документа

**Проблема**: Markdown экспорт не полностью использует информацию о структуре из DoclingDocument:
- Не обрабатываются groups правильно
- Не учитываются relationships между элементами
- Не сохраняются отступы и вложенность

---

## Рекомендации по улучшению

### 1. Улучшение Markdown экспорта

**Рекомендации**:
1. Правильная обработка иерархии через CREF ссылки
2. Корректное определение уровней заголовков через `level` поле
3. Сохранение отступов для списков через `indent_level`
4. Улучшение форматирования таблиц (убрать дублирование заголовков)
5. Добавление обработки изображений (pictures)

**Приоритет**: Высокий

### 2. Настройка pdf_text для русского языка

**Рекомендации**:
1. Добавить настройки для поддержки UTF-8 и кириллицы в pdf_text.yaml
2. Убедиться, что Docling правильно обрабатывает русский текст
3. Добавить fallback на OCR для проблемных PDF (если текст не извлекается)

**Приоритет**: Средний

### 3. Рефакторинг кода

**Рекомендации**:
1. Улучшить обработку ошибок в pipeline
2. Добавить более детальное логирование
3. Оптимизировать обработку больших документов
4. Добавить валидацию структуры документа перед экспортом

**Приоритет**: Низкий

---

## Реализованные улучшения

### 1. Улучшенный Markdown экспорт ✅

**Реализовано**:
- Новая функция `_extract_structured_content()` для извлечения структуры
- Рекурсивная обработка иерархии через `_process_element_recursive()`
- Форматирование текстовых элементов с учетом label и level
- Улучшенная обработка таблиц и изображений

**Статус**: Реализовано, требует тестирования

### 2. Настройка pdf_text для русского языка ✅

**Реализовано**:
- Обновлен `pipeline_templates/pdf_text.yaml`
- Добавлены настройки для извлечения таблиц
- Добавлены комментарии о поддержке русского языка

**Статус**: Реализовано, требует проверки эффективности

### 3. Фильтрация неподдерживаемых форматов ✅

**Реализовано**:
- Фильтрация архивов в merger.py
- Фильтрация бинарных файлов
- Улучшенная обработка ошибок в bridge_docprep.py

**Статус**: Реализовано и протестировано

---

## Метрики и статистика

### Обработка UNIT (тестовая выборка: 50 UNIT)

- **Всего UNIT**: 50
- **Успешно обработано**: 50 (100%)
- **Ошибок**: 0
- **Время обработки**: ~0.1-0.4 сек на UNIT
- **Форматы**: DOCX (преимущественно)

### Качество экспорта

**Требуется дальнейший анализ**:
- Сохранение структуры документов
- Корректность форматирования заголовков
- Правильность обработки таблиц
- Сохранение отступов и списков

---

## Следующие шаги

1. ✅ Завершить полную обработку всех UNIT из Ready2Docling
2. ⏳ Проанализировать качество экспорта Markdown
3. ⏳ Исправить проблемы с layout (если обнаружены)
4. ⏳ Провести тестирование на различных форматах (PDF, XLSX, HTML)
5. ⏳ Создать финальный отчет с метриками и статистикой

---

## Заключение

Система DocPrep + Docling Integration представляет собой комплексное решение для предобработки и семантического понимания документов. Основные компоненты работают корректно, но требуется доработка Markdown экспорта для полного сохранения структуры документов.

