# Рефакторинг и улучшения Docling Integration

**Дата создания:** 2025-12-24
**Дата обновления:** 2026-01-16
**Версия:** 1.1.0

## Обзор

Данный документ описывает выявленные проблемы, ошибки и рекомендации по рефакторингу компонента Docling Integration.

---

## 1. Критические проблемы

### 1.1. Несуществующие поля в PipelineOptions

**Файл:** `final_preprocessing/docling_integration/config.py`

**Проблема:** Попытка установить поля, которые не существуют в `PipelineOptions`.

**Код с ошибкой:**

```python
# ❌ НЕПРАВИЛЬНО - эти поля не существуют
options.do_caption_mentions = True
options.do_table_of_contents = True
options.do_table_structure = True  # Для не-PDF опций
```

**Локации:**
- Строки 211-212 (pdf_text route)
- Строки 219-220 (pdf_mixed route)
- Строки 223-225 (docx route)
- Строки 229-230 (xlsx route)
- Строки 234-235 (pptx route)
- Строки 239-241 (html route)
- Строки 245-246 (xml route)
- Строка 256 (rtf route)

**Влияние:**
- Эти присваивания либо игнорируются, либо вызывают ошибки
- Могут привести к неожиданному поведению

**Решение:**

```python
# ✅ ПРАВИЛЬНО - удалить эти присваивания
# Для не-PDF опций используем базовые PipelineOptions()
options = PipelineOptions()

# Для PDF опций используем PdfPipelineOptions
options.pdf = PdfPipelineOptions()
options.pdf.do_table_structure = True  # Правильное поле
```

**Приоритет:** Высокий  
**Сложность:** Низкая

### 1.2. Неправильные параметры в YAML templates

**Файл:** `final_preprocessing/docling_integration/pipeline_templates/pdf_text.yaml`

**Проблема:** Использование параметров, которые могут не поддерживаться Docling.

**Код с проблемой:**

```yaml
docling:
  preserve_layout: true  # ❌ Может не поддерживаться
  preserve_formatting: true  # ❌ Может не поддерживаться
```

**Влияние:**
- Эти параметры игнорируются, так как не маппятся в PipelineOptions
- Вводят в заблуждение

**Решение:**
- Удалить эти параметры из YAML templates
- Или проверить официальную документацию Docling и использовать правильные параметры

**Приоритет:** Средний  
**Сложность:** Низкая

---

## 2. Проблемы с обработкой структуры документа

### 2.1. Markdown экспорт не сохраняет layout полностью

**Файл:** `final_preprocessing/docling_integration/exporters/markdown.py`

**Проблема:** Заголовки не форматируются правильно, структура документа теряется.

**Симптомы:**
- Заголовки выводятся как обычный текст (нет `##`, `###`)
- Списки не сохраняют отступы
- Таблицы могут дублироваться

**Причина:**
- Рекурсивная обработка иерархии через CREF ссылки не полностью реализована
- Форматирование применяется без учета контекста структуры

**Текущая реализация:**

```python
def _format_text_element(text_element: Dict[str, Any], indent_level: int = 0) -> str:
    label = text_element.get("label", "text")
    level = text_element.get("level", 0)
    
    if label == "section_header":
        if level > 0:
            header_prefix = "#" * min(level, 6) + " "
            return header_prefix + text
```

**Проблема:** Функция вызывается, но структура body → groups → texts может не обрабатываться правильно.

**Решение:**

1. **Улучшить обработку иерархии:**
   ```python
   def _process_element_recursive(
       element: Dict[str, Any],
       elements_index: Dict[str, Dict[str, Any]],
       markdown_lines: List[str],
       processed_refs: Set[str],
       indent_level: int = 0
   ) -> None:
       # Правильная обработка CREF ссылок
       # Правильное построение иерархии
   ```

2. **Улучшить форматирование заголовков:**
   - Проверять что label действительно "section_header"
   - Использовать level для определения уровня заголовка

**Приоритет:** Высокий  
**Сложность:** Средняя

### 2.2. Недостаточная обработка групп и структуры

**Проблема:** Группы (groups) не обрабатываются правильно для сохранения структуры.

**Решение:**
- Изучить структуру groups в DoclingDocument
- Правильно обрабатывать parent/children отношения
- Сохранять иерархию в Markdown

**Приоритет:** Средний  
**Сложность:** Средняя

---

## 3. Проблемы с поддержкой русского языка

### 3.1. Неправильная настройка для русского языка в PDF

**Файл:** `final_preprocessing/docling_integration/pipeline_templates/pdf_text.yaml`

**Проблема:** Настройки языка в YAML не применяются к Docling.

**Код:**

```yaml
language:
  primary: ru
  fallback: en
  encoding: utf-8
```

**Влияние:**
- Эти параметры не маппятся в PipelineOptions
- Docling может использовать настройки по умолчанию (английский)

**Решение:**

1. **Исследовать API Docling:**
   - Проверить наличие параметров языка в `PdfPipelineOptions`
   - Использовать правильные параметры

2. **Альтернативное решение:**
   - Использовать настройки Tesseract для русского языка (если используется OCR)
   - Проверить конфигурацию моделей layout для поддержки кириллицы

**Приоритет:** Средний  
**Сложность:** Средняя

### 3.2. Проблемы с кодировкой текста

**Проблема:** При экспорте в Markdown могут быть проблемы с кодировкой русского текста.

**Решение:**
- Убедиться что все файлы открываются с `encoding="utf-8"`
- Использовать `ensure_ascii=False` в JSON экспорте (уже используется)

**Приоритет:** Низкий  
**Сложность:** Низкая

---

## 4. Проблемы с производительностью

### 4.1. Последовательная обработка UNIT

**Файл:** `final_preprocessing/docling_integration/pipeline.py`

**Проблема:** Обработка UNIT происходит последовательно, что медленно для больших объемов.

**Текущий код:**

```python
def process_directory(self, ready2docling_dir: Path) -> Dict[str, Any]:
    unit_dirs = list(ready2docling_dir.rglob("UNIT_*"))
    for unit_dir in unit_dirs:
        result = self.process_unit(unit_dir)
        results.append(result)
```

**Решение:**

1. **Многопоточная обработка:**
   ```python
   from concurrent.futures import ThreadPoolExecutor
   
   with ThreadPoolExecutor(max_workers=4) as executor:
       futures = [executor.submit(self.process_unit, unit_dir) for unit_dir in unit_dirs]
       results = [f.result() for f in futures]
   ```

2. **Многопроцессная обработка:**
   ```python
   from multiprocessing import Pool
   
   with Pool(processes=4) as pool:
       results = pool.map(self.process_unit, unit_dirs)
   ```

3. **Batch обработка (если поддерживается Docling):**
   ```python
   # Если Docling поддерживает batch
   documents = converter.convert_batch(file_paths)
   ```

**Приоритет:** Средний  
**Сложность:** Средняя

### 4.2. Отсутствие кэширования

**Проблема:** Повторная обработка одинаковых файлов требует повторного запуска Docling.

**Решение:**
- Добавить кэширование результатов через file hash
- Использовать MongoDB или файловый кэш

**Пример из archive/docling/processor.py:**

```python
file_hash = calculate_file_hash(file_path)
cached_result = get_cached_result(file_hash)
if cached_result:
    return cached_result

# Обработка
document = converter.convert(file_path)
save_to_cache(file_hash, document)
```

**Приоритет:** Низкий  
**Сложность:** Средняя

---

## 5. Проблемы с обработкой ошибок

### 5.1. Общая обработка исключений

**Файл:** `final_preprocessing/docling_integration/runner.py`

**Проблема:** Используется общий `Exception` вместо специфичных исключений Docling.

**Код:**

```python
except Exception as e:
    logger.warning(f"Docling conversion failed: {e}")
```

**Решение:**

```python
from docling.exceptions import ConversionError

try:
    document = converter.convert(file_path)
except ConversionError as e:
    # Специфичная обработка ошибок конвертации
    logger.error(f"Docling conversion error: {e}")
except Exception as e:
    # Общая обработка
    logger.error(f"Unexpected error: {e}")
```

**Приоритет:** Средний  
**Сложность:** Низкая

### 5.2. Недостаточное логирование ошибок

**Проблема:** Не все ошибки логируются с достаточной детализацией.

**Решение:**
- Добавить детальное логирование с контекстом
- Логировать параметры обработки при ошибках

**Приоритет:** Низкий  
**Сложность:** Низкая

---

## 6. Проблемы с импортом Docling

### 6.1. Сложная логика импорта для избежания конфликтов

**Файл:** `final_preprocessing/docling_integration/config.py`, `runner.py`

**Проблема:** Сложная логика манипуляции `sys.path` и `sys.modules` для избежания конфликта имен.

**Код:**

```python
# Сложная логика манипуляции sys.path
site_dirs = []
for site_dir in site.getsitepackages():
    if (Path(site_dir) / 'docling' / '__init__.py').exists():
        if site_dir in sys.path:
            sys.path.remove(site_dir)
        sys.path.insert(0, site_dir)

# Удаление локального модуля из sys.modules
if 'docling' in sys.modules:
    # ... сложная логика
```

**Влияние:**
- Усложняет код
- Может вызвать проблемы при изменении структуры проекта

**Решение:**

1. **Переименовать локальный модуль:**
   - ✅ Уже выполнено: `docling` → `docling_integration`

2. **Упростить импорт:**
   - Удалить сложную логику манипуляции `sys.path`
   - Использовать прямые импорты после переименования

**Приоритет:** Низкий (уже частично решено)  
**Сложность:** Низкая

---

## 7. Проблемы с конфигурацией

### 7.1. Дублирование логики между YAML и legacy конфигурацией

**Файл:** `final_preprocessing/docling_integration/config.py`

**Проблема:** Есть два пути конфигурации (YAML templates и legacy hardcoded), что усложняет поддержку.

**Решение:**
- Постепенно мигрировать все routes на YAML templates
- Удалить legacy конфигурацию после полной миграции

**Приоритет:** Низкий  
**Сложность:** Средняя

### 7.2. Неиспользуемые параметры в YAML

**Проблема:** Некоторые параметры в YAML templates (например, `performance.*`, `language.*`) не применяются.

**Решение:**
- Удалить неиспользуемые параметры
- Или реализовать их применение (если возможно)

**Приоритет:** Низкий  
**Сложность:** Низкая

---

## 8. Рекомендации по рефакторингу

### 8.1. Рефакторинг config.py

**Приоритет 1: Удалить неправильные поля**

```python
# УДАЛИТЬ эти строки из _build_options_legacy:
options.do_caption_mentions = True  # ❌
options.do_table_of_contents = True  # ❌
options.do_table_structure = True  # ❌ (для не-PDF)
```

**Приоритет 2: Упростить импорт**

```python
# Упростить после переименования модуля
from docling.document_converter import DocumentConverter
from docling.datamodel.pipeline_options import PipelineOptions, PdfPipelineOptions
```

### 8.2. Рефакторинг exporters/markdown.py

**Приоритет 1: Улучшить обработку иерархии**

- Правильно обрабатывать CREF ссылки
- Сохранять структуру body → groups → texts
- Правильно форматировать заголовки

**Приоритет 2: Тестирование**

- Добавить тесты для различных типов документов
- Проверить сохранение layout для разных форматов

### 8.3. Рефакторинг pipeline.py

**Приоритет 1: Добавить параллелизацию**

- Многопоточная или многопроцессная обработка
- Batch обработка (если поддерживается)

**Приоритет 2: Улучшить обработку ошибок**

- Специфичные исключения Docling
- Детальное логирование

### 8.4. Рефакторинг bridge_docprep.py

**Статус:** ✅ Код в хорошем состоянии, минимальные улучшения

**Рекомендации:**
- Добавить больше валидации контракта
- Улучшить обработку AST nodes

---

## 9. План рефакторинга

### Фаза 1: Критические исправления (Высокий приоритет) - ✅ ВЫПОЛНЕНО

1. ✅ Удалить неправильные поля из `_build_options_legacy`
2. ✅ Упростить импорт после переименования модуля
3. ✅ Исправить `config.py` - функция `_build_options_from_template()` теперь применяет ВСЕ настройки из YAML
4. ✅ Оптимизировать `pdf_text.yaml` для скорости (отключены layout, tables)
5. ✅ Создать `pdf_text_tables.yaml` для документов с таблицами
6. ✅ Добавить логирование PDF опций в `runner.py`

**Выполнено:** 2026-01-16

### Фаза 1.5: Верификация (ВЫПОЛНЕНО 2026-01-16)

**Результаты тестирования:**

| Формат | Кол-во | Success | Время avg |
|--------|--------|---------|-----------|
| DOCX | 17 | 100% | **0.16 сек** |
| XLSX | 1 | 100% | **0.34 сек** |
| PDF (digital) | 5 | 100% | ~68 сек |
| Image OCR | 3 | 100% | 107 сек |

**Выводы:**
- DOCX/XLSX обрабатываются очень быстро
- PDF время зависит от размера документа (12-200 сек)
- Docling загружает модели при инициализации даже если они отключены

### Фаза 2: Улучшение экспорта (Средний приоритет)

1. ➕ Улучшить Markdown экспорт для сохранения layout
2. ➕ Тестирование экспорта на различных документах
3. ➕ Проверить встроенные методы экспорта Docling

**Оценка времени:** 4-8 часов

### Фаза 3: Оптимизация производительности (Средний приоритет)

1. ➕ Добавить параллелизацию обработки
2. ➕ Рассмотреть batch обработку
3. ➕ Добавить кэширование (опционально)

**Оценка времени:** 4-8 часов

### Фаза 4: Поддержка русского языка (Средний приоритет)

1. ➕ Исследовать API Docling для настроек языка
2. ➕ Правильно настроить поддержку русского языка
3. ➕ Тестирование на русских документах

**Оценка времени:** 2-4 часа

### Фаза 5: Улучшение конфигурации (Низкий приоритет)

1. ➕ Миграция всех routes на YAML templates
2. ➕ Удаление legacy конфигурации
3. ➕ Удаление неиспользуемых параметров

**Оценка времени:** 2-4 часа

### Фаза 6: Интеграция внешних GPU-сервисов Cloud.ru (Следующий этап)

**Цель:** Интеграция внешних сервисов для улучшения качества обработки и масштабирования

**Предварительные условия:**
- Завершена отладка обработки digital документов
- Стабильная работа основного pipeline
- Протестирована обработка всех поддерживаемых форматов

#### 6.1. Интеграция Cloud.ru Granite Docling (VLM)

**Задачи:**
1. Настройка endpoint и API ключей для Cloud.ru ML Foundation
2. Интеграция через VlmPipelineOptions в Docling
3. Конфигурация через environment variables (VLM_ENDPOINT, VLM_MODEL, VLM_API_KEY)
4. Реализация fallback механизма при недоступности сервиса
5. Тестирование интеграции с различными типами документов
6. Мониторинг производительности и качества

**Компоненты для изменения:**
- `config.py` - добавление настройки VLM endpoint для Cloud.ru
- `runner.py` - обработка ошибок при недоступности внешнего сервиса
- YAML templates - добавление опций для использования VLM

**Оценка времени:** 4-8 часов

#### 6.2. Интеграция Cloud.ru PaddleOCR_VLM (OCR)

**Задачи:**
1. Изучение API PaddleOCR_VLM сервиса
2. Создание адаптера для вызова внешнего OCR сервиса
3. Настройка endpoint и API ключей (PADDLEOCR_VLM_ENDPOINT, PADDLEOCR_VLM_API_KEY)
4. Интеграция в pipeline для PDF файлов, требующих OCR
5. Реализация выбора между локальным Tesseract и PaddleOCR_VLM
6. Конфигурация через environment variables и YAML templates
7. Реализация fallback на локальный Tesseract при недоступности сервиса
8. Тестирование на различных PDF документах
9. Оптимизация производительности (batch запросы, кэширование)

**Компоненты для создания/изменения:**
- Новый модуль: `external_services/paddleocr_vlm.py` - адаптер для PaddleOCR_VLM API
- `config.py` - конфигурация для выбора OCR сервиса
- `runner.py` - интеграция вызова внешнего OCR перед Docling обработкой
- YAML templates (pdf_scan.yaml, pdf_scan_table.yaml) - опции для использования PaddleOCR_VLM

**Архитектура:**
```
PDF файл → PaddleOCR_VLM (Cloud.ru GPU) → OCR результат → Docling для структурирования
```

**Оценка времени:** 8-12 часов

#### 6.3. Мониторинг и оптимизация гибридной архитектуры

**Задачи:**
1. Мониторинг использования внешних сервисов
2. Сбор метрик производительности (время ответа, стоимость)
3. Оптимизация выбора между локальными и внешними сервисами
4. Настройка кэширования для снижения вызовов внешних API
5. Alerting при проблемах с внешними сервисами

**Оценка времени:** 4-6 часов

**Общая оценка Фазы 6:** 16-26 часов

---

## 10. Метрики качества

### Текущие метрики

- **Успешность обработки:** 100% (на тестовой выборке)
- **Время обработки:** ~0.1-1.0 сек на UNIT
- **Качество экспорта:** Требует улучшения (layout)

### Целевые метрики

- **Успешность обработки:** >99%
- **Время обработки:** <0.5 сек на UNIT (с параллелизацией)
- **Качество экспорта:** Полное сохранение layout структуры

---

## 11. Заключение

### Критические проблемы - ✅ РЕШЕНО (2026-01-16)

1. ✅ Неправильные поля в PipelineOptions - **ИСПРАВЛЕНО**
2. ✅ YAML настройки не применялись к PDF - **ИСПРАВЛЕНО** в `config.py`
3. ➕ Markdown экспорт не сохраняет layout (средний приоритет)

### Важные улучшения

1. ➕ Параллелизация обработки
2. ➕ Улучшение обработки ошибок
3. ➕ Поддержка русского языка

### Низкоприоритетные улучшения

1. ➕ Кэширование результатов
2. ➕ Миграция на YAML templates
3. ➕ Улучшение логирования

### Следующий этап: Интеграция внешних сервисов

**Фаза 6:** Интеграция Cloud.ru ML Foundation сервисов:
1. ➕ Cloud.ru Granite Docling (VLM) - улучшение понимания документов
2. ➕ Cloud.ru PaddleOCR_VLM (OCR) - GPU-ускоренная OCR обработка
3. ➕ Мониторинг и оптимизация гибридной архитектуры

**Предварительные условия:** Завершена отладка обработки digital документов

---

**Связанные документы:**
- [ARCHITECTURE.md](ARCHITECTURE.md) - архитектура системы
- [COMPONENTS.md](COMPONENTS.md) - описание компонентов
- [BEST_PRACTICES.md](BEST_PRACTICES.md) - лучшие практики
