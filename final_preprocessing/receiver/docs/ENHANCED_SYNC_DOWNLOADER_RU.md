@ENHANCED_SYNC_DOWNLOADER_RU.md (1-271) # Улучшенные компоненты синхронизации и загрузки

## Обзор

Этот документ описывает улучшенные компоненты синхронизации и загрузки для конвейера предварительной обработки. Эти компоненты обеспечивают улучшенную обработку ошибок, комплексные проверки работоспособности, расширенную аналитику и лучшую интеграцию с интерфейсом командной строки.

## Улучшенная служба SyncDB

### Особенности

1. **Улучшенная обработка ошибок**: Комплексная обработка ошибок с подробным ведением журнала и категоризацией
2. **Расширенная статистика**: Подробный сбор метрик, включая распределение URL, типы вложений и время обработки
3. **Улучшенное ведение журнала**: Структурированное ведение журнала с настраиваемыми уровнями
4. **Пакетная обработка**: Эффективная пакетная обработка документов с настраиваемыми размерами пакетов
5. **Управление подключениями**: Надежное управление подключениями с тайм-аутами и повторными попытками

### Основные классы

#### EnhancedSyncService
Основной класс службы для синхронизации протоколов с расширенными возможностями:
- `sync_protocols_for_date()`: Синхронизация протоколов за определенную дату
- `sync_protocols_for_date_range()`: Синхронизация протоколов за диапазон дат
- `sync_daily_updates()`: Ежедневная синхронизация последних протоколов
- `sync_full_collection()`: Полная синхронизация за указанный период

#### EnhancedSyncResult
Расширенный объект результата с подробными метриками:
- Базовые метрики (просмотрено, вставлено, пропущено, ошибки)
- Статистика распределения URL
- Анализ типов вложений
- Статистика времени обработки
- Категоризация ошибок

### Использование

```bash
# Из командной строки
python -m receiver.sync_db.enhanced_service sync-date --date 2024-01-15
python -m receiver.sync_db.enhanced_service sync-range --start-date 2024-01-01 --end-date 2024-01-31
python -m receiver.sync_db.enhanced_service sync-daily
python -m receiver.sync_db.enhanced_service sync-full --days 30
```

## Модуль проверки работоспособности

### Особенности

1. **Комплексный мониторинг работоспособности**: Проверки VPN, удаленной MongoDB, локальной MongoDB и среды
2. **Подробная отчетность**: Структурированные отчеты о проверке работоспособности со значками состояния
3. **Индивидуальные проверки**: Возможность выполнения определенных проверок работоспособности
4. **Общее состояние системы**: Агрегированное состояние работоспособности системы

### Основные функции

- `check_vpn_connectivity()`: Проверка VPN-подключения к zakupki.gov.ru
- `check_remote_mongodb_connectivity()`: Проверка подключения к удаленной MongoDB
- `check_local_mongodb_connectivity()`: Проверка подключения к локальной MongoDB
- `check_environment_variables()`: Проверка необходимых переменных среды
- `run_comprehensive_health_check()`: Выполнение всех проверок работоспособности
- `get_overall_system_health()`: Получение агрегированного состояния работоспособности системы

### Использование

```bash
# Из командной строки
python -m receiver.sync_db.health_checks --check all
python -m receiver.sync_db.health_checks --check vpn
python -m receiver.sync_db.health_checks --check remote-mongo
```

## Модуль аналитики

### Особенности

1. **Отслеживание исторических данных**: Хранение и извлечение исторических данных синхронизации
2. **Анализ тенденций**: Анализ тенденций синхронизации с течением времени
3. **Комплексная отчетность**: Создание подробных отчетов о синхронизации
4. **Экспорт данных**: Экспорт аналитических данных в формат JSON

### Основные классы

#### SyncStatistics
Подробная статистика для сеансов синхронизации:
- Метаданные сеанса и синхронизация времени
- Метрики обработки документов
- Анализ URL и вложений
- Категоризация ошибок

#### HistoricalSyncRecord
Историческая запись сеансов синхронизации:
- Дата и основные метрики
- Продолжительность и тип синхронизации
- Информация о временных метках

#### SyncAnalytics
Служба аналитики для данных синхронизации:
- `store_sync_statistics()`: Хранение статистики синхронизации
- `get_sync_statistics()`: Получение статистики синхронизации
- `get_historical_sync_data()`: Получение исторических данных синхронизации
- `get_sync_trends()`: Анализ тенденций синхронизации
- `generate_sync_report()`: Создание комплексных отчетов
- `export_analytics_to_json()`: Экспорт аналитических данных

### Использование

```bash
# Из командной строки
python -m receiver.sync_db.analytics report --days 30
python -m receiver.sync_db.analytics trends --days 7
python -m receiver.sync_db.analytics history
python -m receiver.sync_db.analytics export --days 30 --output sync_report.json
```

## Улучшенная служба загрузки

### Особенности

1. **Улучшенная обработка ошибок**: Лучшая категоризация и обработка ошибок
2. **Параллельные загрузки**: Эффективная параллельная загрузка файлов
3. **Подробная статистика**: Комплексная статистика загрузки
4. **Улучшенное ведение журнала**: Структурированное ведение журнала с подробной информацией
5. **Отслеживание прогресса**: Отслеживание прогресса загрузки и производительности

### Основные классы

#### EnhancedProtocolDownloader
Улучшенная служба загрузки:
- `_download_single_file()`: Загрузка отдельных файлов с обработкой ошибок
- `_process_single_protocol()`: Обработка отдельных протоколов
- `process_pending_protocols()`: Обработка всех ожидающих протоколов

#### DownloadResult
Расширенный результат загрузки с подробными метриками:
- Базовые метрики загрузки
- Статистика размера файлов и времени
- Распределение типов файлов
- Отслеживание успеха/неудачи по доменам
- Категоризация ошибок

### Использование

```bash
# Из командной строки
python -m receiver.downloader.enhanced_service --limit 100
python -m receiver.downloader.enhanced_service --output-dir /custom/path
```

## Интеграция с интерфейсом командной строки

### Новые функции в меню интерфейса командной строки

1. **Расширенные параметры синхронизации**: Более гибкие параметры синхронизации, включая диапазоны дат и периоды
2. **Интеграция проверки работоспособности**: Встроенная проверка работоспособности системы
3. **Проверка инфраструктуры**: Комплексная проверка инфраструктуры
4. **Улучшенная отчетность**: Лучше отформатированные отчеты и статистика

### Структура меню

```
=== ЗАГРУЗКА И ПОДГОТОВКА ДАННЫХ ===
1. Синхронизация протоколов из MongoDB
2. Скачивание протоколов за дату
3. Проверка доступности файлов в INPUT_DIR

=== СЛУЖЕБНЫЕ ФУНКЦИИ ===
25. Очистка тестовых данных
26. Создание тестовых файлов
27. Проверка инфраструктуры
```

### Примеры использования

#### Параметры синхронизации
```
1. Синхронизация протоколов из MongoDB
   ├── 1. Одна дата
   ├── 2. Диапазон дат
   ├── 3. Начальная дата + количество дней
   ├── 4. Ежедневное обновление
   └── 5. Полная синхронизация
```

#### Проверка инфраструктуры
Пункт меню 27 обеспечивает комплексную проверку инфраструктуры:
- Разрешения каталогов и их существование
- Статус Docker и контейнеров
- Подключение VPN
- Доступное дисковое пространство
- Проверка пакетов Python
- Проверка переменных среды
- Тестирование подключения MongoDB

## Конфигурация

### Переменные среды

Расширенные компоненты используют те же переменные среды, что и исходная система:

```bash
# Удаленная MongoDB (для протоколов)
MONGO_SERVER=192.168.0.46:8635
MONGO_USER=readProtocols223
MONGO_PASSWORD=your_password
MONGO_SSL_CERT=/path/to/certificate.crt
MONGO_PROTOCOLS_DB=protocols223
MONGO_PROTOCOLS_COLLECTION=purchaseProtocol

# Локальная MongoDB (для метаданных)
MONGO_METADATA_SERVER=localhost:27018
LOCAL_MONGO_SERVER=localhost:27018
MONGO_METADATA_USER=admin
MONGO_METADATA_PASSWORD=your_password
MONGO_METADATA_DB=docling_metadata
```

## Установка

Установите необходимые зависимости:

```bash
pip install -r receiver/requirements.txt
```

## Тестирование

Запустите тесты для отдельных компонентов:

```bash
# Тест службы синхронизации
python -m pytest tests/test_sync_service.py

# Тест загрузчика
python -m pytest tests/test_downloader.py

# Тест проверки работоспособности
python -m pytest tests/test_health_checks.py
```

## Устранение неполадок

### Распространенные проблемы

1. **Сбои подключения MongoDB**
   - Убедитесь, что переменные среды установлены правильно
   - Проверьте путь и разрешения SSL-сертификата
   - Убедитесь, что VPN подключен для доступа к удаленной MongoDB

2. **Сбои загрузки**
   - Проверьте доступность zakupki.gov.ru
   - Убедитесь в наличии сетевого подключения
   - Проверьте доступное дисковое пространство

3. **Проблемы с производительностью**
   - Настройте размеры пакетов в конфигурации
   - Настройте параметры параллелизма
   - Отслеживайте системные ресурсы

### Журналы

Проверьте журналы для получения подробной информации об ошибках:
- Расширенные службы ведут журнал в консоли со структурированными сообщениями
- Включите ведение журнала отладки с помощью флага `--verbose`
- Операции MongoDB регистрируются с информацией о времени

## Будущие улучшения

Планируемые улучшения:
1. Веб-панель для мониторинга статуса синхронизации
2. Система оповещения о сбоях и проблемах с производительностью
3. Расширенная аналитика с прогнозирующими возможностями
4. Интеграция с внешними системами мониторинга
5. Автоматические механизмы восстановления для распространенных сбоев
