# Changelog - История изменений DocPrep

## 2025-12-20

### Исправления

#### Конвертация .doc файлов
- **Проблема**: .doc файлы ошибочно конвертировались в .xlsx вместо .docx
- **Решение**: 
  - Исправлена логика определения типа в `file_ops.py` (приоритет расширения для .doc)
  - Исправлен CONVERSION_MAP в `converter.py` (doc → docx вместо doc → xlsx)
  - Добавлен LIBREOFFICE_FORMAT_MAP для корректного маппинга форматов LibreOffice

#### Распределение PDF в Ready2Docling
- **Проблема**: PDF UNIT попадали в корень `pdf/` вместо поддиректорий `pdf/scan`, `pdf/text`, `pdf/mixed`
- **Решение**:
  - Улучшена логика определения PDF по расширениям (включая неправильные расширения типа "гPDF")
  - Все PDF UNIT корректно распределяются в pdf/scan, pdf/text, pdf/mixed, pdf/unknown
  - Убрана возможность попадания PDF UNIT в корень pdf/ директории

#### Рекурсивный поиск файлов
- **Проблема**: 144 UNIT после извлечения архивов были неправильно классифицированы как empty
- **Решение**:
  - `get_unit_files()` теперь использует `rglob("*")` для поиска файлов во вложенных директориях
  - Корректная обработка файлов после извлечения архивов (произвольные имена директорий)

#### Улучшения логики определения типов
- Приоритет расширения файла для .doc перед OLE2 signature проверкой
- Улучшена логика определения PDF по расширениям и именам файлов
- Fallback на расширение файла, если detected_type = "unknown"

### Улучшения

#### Merger
- Рекурсивный поиск файлов во вложенных директориях
- Проверка валидности файлов (не пустые, прошли обработку)
- Исключение mixed/special/ambiguous UNIT из Ready2Docling
- Улучшенная логика определения PDF по расширениям

#### Статистика
- Добавлена детальная статистика по всем циклам обработки
- Улучшена таблица "ИТОГОВЫЕ МЕТРИКИ ОБРАБОТКИ"
- Добавлены объяснения для "unknown" единиц и "Детектирование типов"

### Документация
- Обновлена вся документация с учетом последних изменений
- Создана структура memory bank документации
- Создан индекс документации (INDEX.md)
- Удалены устаревшие отчеты и временные скрипты

## 2025-12-19

### Исправления

#### Обработка unknown UNIT
- Пустые UNIT теперь корректно перемещаются в `Exceptions/Exceptions_1/Ambiguous/`
- Создается manifest для пустых UNIT
- Обновляется state machine

#### Обработка ambiguous файлов
- Сохранение scenario из Decision Engine
- Правильная проверка ambiguous файлов в UNIT
- Корректное распределение в `Ambiguous/` или `Special/`

#### Обработка mixed UNIT
- Определение mixed по типам файлов (не только по категориям)
- Корректное перемещение в `Exceptions/Exceptions_1/Mixed/`

#### Сортировка по расширениям
- Для `extract`: используется исходное расширение архива
- Для `normalize`: используется исходное расширение (если корректное)
- Для `convert`: используется исходное расширение
- Нормализация jpeg → jpg

#### Audit logs
- Audit logs теперь всегда сохраняются в директории UNIT
- Предотвращено создание audit logs в корне проекта

### Добавления

#### Система статистики
- Сбор детальной статистики по входным и выходным данным
- Процентные метрики по расширениям и категориям
- Анализ unknown UNIT (разделение пустых и с файлами)
- Сравнение циклов обработки
- Экспорт статистики в Markdown и JSON

---

*Для получения более детальной информации см. [DEVELOPMENT_LOG.md](./DEVELOPMENT_LOG.md) и [BUGFIX_REPORT.md](./BUGFIX_REPORT.md)*

