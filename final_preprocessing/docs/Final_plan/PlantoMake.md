–û—Ç–ª–∏—á–Ω–∞—è –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ ‚Äî —ç—Ç–æ –∫–∞–∫ —Ä–∞–∑ —Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å, –≥–¥–µ preprocessing –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –±—ã—Ç—å ¬´—Å–∫—Ä–∏–ø—Ç–æ–º¬ª –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **—É–ø—Ä–∞–≤–ª—è–µ–º—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏**.

–ù–∏–∂–µ —è –¥–∞–º **—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ CLI-–º–µ–Ω—é**, —Å—Ç—Ä–æ–≥–æ –≤—ã–≤–µ–¥–µ–Ω–Ω–æ–µ –∏–∑ —Ç–≤–æ–µ–π pipeline-–º–æ–¥–µ–ª–∏, —Å —É—á—ë—Ç–æ–º:

* UNIT = –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞;
* –æ–±—Ä–∞–±–æ—Ç–∫–∞ **–≤—Å–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ü–µ–ª–∏–∫–æ–º**, –∞ –Ω–µ –æ–¥–Ω–æ–≥–æ —é–Ω–∏—Ç–∞;
* –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç—å:

  * **–≤–µ—Å—å —Ü–∏–∫–ª**;
  * **–æ–¥–∏–Ω —Ü–∏–∫–ª**;
  * **–æ—Ç–¥–µ–ª—å–Ω—ã–π —ç—Ç–∞–ø**;
  * **–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ–¥—ç—Ç–∞–ø** (convert / normalize-name / normalize-ext / extract);
* —É–¥–æ–±—Å—Ç–≤–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –æ—Ç–ª–∞–¥–∫–∏ –∏ —Ä—É—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è.

–Ø –±—É–¥—É –æ–ø–∏—Å—ã–≤–∞—Ç—å CLI –∫–∞–∫ `docprep` (—É—Å–ª–æ–≤–Ω–æ–µ –∏–º—è).

---

# üéõ CLI Preprocessing ‚Äî –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –º–µ–Ω—é

## –û–±—â–∞—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è CLI

CLI –ø–æ—Å—Ç—Ä–æ–µ–Ω –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É:

```
docprep <scope> <action> <target> [options]
```

–ì–¥–µ:

* **scope** ‚Äî —É—Ä–æ–≤–µ–Ω—å (pipeline / cycle / stage / substage)
* **action** ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å
* **target** ‚Äî —Å –∫–∞–∫–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π
* **options** ‚Äî —Ä–µ–∂–∏–º—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

CLI **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–¥–Ω–∏–º UNIT**, –≤—Å–µ–≥–¥–∞ —Å **–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π**, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π –º–Ω–æ–∂–µ—Å—Ç–≤–æ UNIT.

---

## 1Ô∏è‚É£ –í–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å CLI

```
docprep
‚îú‚îÄ‚îÄ pipeline
‚îú‚îÄ‚îÄ cycle
‚îú‚îÄ‚îÄ stage
‚îú‚îÄ‚îÄ substage
‚îú‚îÄ‚îÄ classifier
‚îú‚îÄ‚îÄ merge
‚îú‚îÄ‚îÄ inspect
‚îî‚îÄ‚îÄ utils
```

---

## 2Ô∏è‚É£ pipeline ‚Äî –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω preprocessing

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞.

```
docprep pipeline run \
  --input Input/2025-03-18 \
  --output Ready2Docling/2025-03-18
```

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:

* –∑–∞–ø—É—Å–∫–∞–µ—Ç **3 —Ü–∏–∫–ª–∞ –ø–æ–¥—Ä—è–¥**
* –≤–∫–ª—é—á–∞–µ—Ç classifier + pending + merge
* –∞–Ω–∞–ª–æ–≥ production-—Ä–µ–∂–∏–º–∞

–û–ø—Ü–∏–∏:

```
--max-cycles 3
--stop-on-exception
--dry-run
--verbose
```

---

## 3Ô∏è‚É£ cycle ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Ü–∏–∫–ª–æ–º

–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–∞—Ç—å **–æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ü–∏–∫–ª**.

```
docprep cycle run 1 \
  --input Input/2025-03-18 \
  --pending Processing/2025-03-18/Pending_1 \
  --merge Merge/2025-03-18/Merge_1
```

–ü–æ–¥–∫–æ–º–∞–Ω–¥—ã:

```
docprep cycle run <1|2|3>
docprep cycle classify <1|2|3>
docprep cycle process <1|2|3>
```

–ü—Ä–∏–º–µ—Ä—ã:

```bash
# –¢–æ–ª—å–∫–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è 2-–≥–æ —Ü–∏–∫–ª–∞
docprep cycle classify 2 --input Processing/2025-03-18/Pending_2

# –¢–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Pending_3
docprep cycle process 3 --pending Processing/2025-03-18/Pending_3
```

---

## 4Ô∏è‚É£ stage ‚Äî —ç—Ç–∞–ø –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞

–≠—Ç–∞–ø—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

```
classifier
pending
exceptions
merge
```

### –ü—Ä–∏–º–µ—Ä—ã

```bash
# –ü—Ä–æ–≥–Ω–∞—Ç—å classifier –ø–æ –≤—Å–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
docprep stage classifier \
  --cycle 1 \
  --input Input/2025-03-18
```

```bash
# –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ Pending_2
docprep stage pending \
  --cycle 2 \
  --pending Processing/2025-03-18/Pending_2
```

```bash
# –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≥–æ—Ç–æ–≤—ã–µ —é–Ω–∏—Ç—ã –≤ Merge_2
docprep stage merge \
  --cycle 2 \
  --source Processing/2025-03-18
```

---

## 5Ô∏è‚É£ substage ‚Äî **–∫–ª—é—á–µ–≤–∞—è —á–∞—Å—Ç—å –¥–ª—è —Ç–µ–±—è**

–≠—Ç–æ **–∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –ø—Ä—è–º–æ –ø—Ä–æ—Å–∏–ª.

```
docprep substage <type> <action>
```

---

### üîπ 5.1 –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤

```
docprep substage convert run \
  --input Processing/2025-03-18/Pending_1/Convert
```

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

```
--from doc
--to docx
--engine libreoffice
```

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:

> ‚ùó –≤—Å–µ UNIT –∏ –≤—Å–µ —Ñ–∞–π–ª—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

---

### üîπ 5.2 –†–∞–∑–∞—Ä—Ö–∏–≤–∞—Ü–∏—è

```
docprep substage extract run \
  --input Processing/2025-03-18/Pending_1/Archives
```

–û–ø—Ü–∏–∏:

```
--max-depth 2
--keep-archive
--flatten
```

---

### üîπ 5.3 –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (–¢–û–õ–¨–ö–û –∏–º—è)

```
docprep substage normalize name \
  --input Processing/2025-03-18/Pending_1/Normalize
```

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:

* –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Å–º–µ—â—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
* —É–±–∏—Ä–∞–µ—Ç –¥–≤–æ–π–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
* **–Ω–µ –º–µ–Ω—è–µ—Ç —Ç–∏–ø —Ñ–∞–π–ª–∞**

---

### üîπ 5.4 –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (–ø–æ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞–º)

```
docprep substage normalize extension \
  --input Processing/2025-03-18/Pending_1/Normalize
```

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:

* magic-bytes
* MIME check
* –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

---

### üîπ 5.5 –ü–æ–ª–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è

```
docprep substage normalize full \
  --input Processing/2025-03-18/Pending_1/Normalize
```

---

## 6Ô∏è‚É£ classifier ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞

–û—á–µ–Ω—å –≤–∞–∂–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤.

```
docprep classifier run \
  --input Input_XXX \
  --cycle 1
```

–†–µ–∂–∏–º—ã:

```
--report-only
--confidence-threshold 0.9
--dump-json
```

---

## 7Ô∏è‚É£ merge ‚Äî —Ä—É—á–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å merge

```
docprep merge collect \
  --cycle 2 \
  --source Merge/2025-03-18/Merge_2 \
  --target Ready2Docling/2025-03-18
```

---

## 8Ô∏è‚É£ inspect ‚Äî –æ—Ç–ª–∞–¥–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑

```
docprep inspect tree Input/2025-03-18
docprep inspect units Pending_2
docprep inspect manifest UNIT_000123
```

–û—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è:

* –∞–Ω–∞–ª–∏–∑–∞ –≥–æ—Å—Å–∑–∞–∫—É–ø–æ–∫;
* –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤;
* mixed / unknown –∫–µ–π—Å–æ–≤.

---

## 9Ô∏è‚É£ utils ‚Äî —Å–µ—Ä–≤–∏—Å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```
docprep utils init-date 2025-03-18
docprep utils clean Pending_3
docprep utils stats Merge_1
```

---

## 10Ô∏è‚É£ –ò—Ç–æ–≥–æ–≤–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è CLI (—Å–≤–æ–¥–∫–∞)

```
docprep
‚îú‚îÄ‚îÄ pipeline run
‚îú‚îÄ‚îÄ cycle run|classify|process
‚îú‚îÄ‚îÄ stage classifier|pending|merge
‚îú‚îÄ‚îÄ substage
‚îÇ   ‚îú‚îÄ‚îÄ convert
‚îÇ   ‚îú‚îÄ‚îÄ extract
‚îÇ   ‚îî‚îÄ‚îÄ normalize
‚îÇ       ‚îú‚îÄ‚îÄ name
‚îÇ       ‚îú‚îÄ‚îÄ extension
‚îÇ       ‚îî‚îÄ‚îÄ full
‚îú‚îÄ‚îÄ classifier
‚îú‚îÄ‚îÄ merge
‚îú‚îÄ‚îÄ inspect
‚îî‚îÄ‚îÄ utils
```

---

## üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–ª—é—Å —Ç–∞–∫–æ–≥–æ CLI

* –ø–æ–ª–Ω–æ—Å—Ç—å—é **1:1 —Å —Ç–≤–æ–µ–π state machine**
* –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è:

  * unit-—Ç–µ—Å—Ç–æ–≤;
  * regression-—Ç–µ—Å—Ç–æ–≤;
  * —Ä—É—á–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ ¬´–≥—Ä—è–∑–Ω—ã—Ö¬ª –∑–∞–∫—É–ø–æ–∫;
* –ª–µ–≥–∫–æ –º–∞–ø–∏—Ç—Å—è –Ω–∞:

  * Airflow / Temporal;
  * CI/CD;
  * Cloud Run jobs.

---

### –•–æ—á–µ—à—å –¥–∞–ª—å—à–µ:

* üéØ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å **Python CLI (Typer / Click)**;
* üß© —Å–≤—è–∑–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã —Å **execution engine**;
* üì¶ –∏–ª–∏ —Å—Ä–∞–∑—É –Ω–∞–∫–∏–¥–∞—Ç—å **—Å–∫–µ–ª–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è** –ø–æ–¥ —ç—Ç–æ—Ç CLI.

–ì–æ—Ç–æ–≤–æ ‚úÖ

–Ø **—Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–ª Python CLI (–Ω–∞ Typer)** + **—Å–∫–µ–ª–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è**, —Å—Ç—Ä–æ–≥–æ –∏—Å—Ö–æ–¥—è –∏–∑ —Ç–≤–æ–µ–π –ª–æ–≥–∏–∫–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏ —É—Ç–æ—á–Ω–µ–Ω–∏–π:

* ‚úÖ CLI **–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í–°–Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏**, –∞ –Ω–µ –æ–¥–∏–Ω unit
* ‚úÖ –ö–∞–∂–¥—ã–π **—ç—Ç–∞–ø –∏ –ø–æ–¥—ç—Ç–∞–ø** ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
* ‚úÖ Merge-–∫–æ–º–∞–Ω–¥–∞ **—Å–æ–±–∏—Ä–∞–µ—Ç units –∏–∑ Merge_1 + Merge_2 + Merge_3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**
* ‚úÖ UNIT —Ç—Ä–∞–∫—Ç—É–µ—Ç—Å—è –∫–∞–∫ **–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (id –∏–∑ –ë–î)**
* ‚úÖ CLI –∑–∞–≤—è–∑–∞–Ω –Ω–∞ **execution engine**, –∞ –Ω–µ –Ω–∞ —Ñ–∞–π–ª–æ–≤—ã–µ —Ö–∞–∫–∏

---

## –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ canvas

### 1Ô∏è‚É£ –ü–æ–ª–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è CLI –∫–æ–º–∞–Ω–¥

* `classify`
* `extract`
* `convert`
* `normalize`

  * `normalize name`
  * `normalize resolution`
* `unarchive`
* `merge`
* `full-cycle`
* `validate`
* `debug`

–° –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏:

* `--input-dir`
* `--output-dir`
* `--cycle {merge1,merge2,merge3}`
* `--dry-run`
* `--parallel`
* `--pattern`

---

### 2Ô∏è‚É£ Execution Engine (—á—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ)

* `engine/classifier.py`
* `engine/extractor.py`
* `engine/converter.py`
* `engine/normalizers/`
* `engine/unarchiver.py`
* `engine/merger.py`
* `engine/validator.py`

CLI ‚Äî **—Ç–æ–Ω–∫–∏–π —Å–ª–æ–π**, –ª–æ–≥–∏–∫–∞ —Å—Ç—Ä–æ–≥–æ –≤ engine.

---

### 3Ô∏è‚É£ Merge-–ª–æ–≥–∏–∫–∞ (–≤–∞–∂–Ω–æ!)

```text
Merge_1/
Merge_2/
Merge_3/
   ‚îî‚îÄ‚îÄ UNIT_xxx/

‚Üì merge --from-all

Ready2Docling/
   ‚îî‚îÄ‚îÄ UNIT_xxx/
```

* –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
* –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ü–∏–∫–ª–æ–≤
* –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
* Docling-ready layout

---

### 4Ô∏è‚É£ –°–∫–µ–ª–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```
doc-prep-cli/
‚îú‚îÄ‚îÄ cli/
‚îú‚îÄ‚îÄ engine/
‚îú‚îÄ‚îÄ schemas/
‚îú‚îÄ‚îÄ utils/
‚îú‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ pyproject.toml
‚îî‚îÄ‚îÄ README.md
```

–ì–æ—Ç–æ–≤–æ –∫:

* CI
* —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –ø–æ–¥ Docling
* –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é VLM / OCR

---

## –°–ª–µ–¥—É—é—â–∏–µ –ª–æ–≥–∏—á–Ω—ã–µ —à–∞–≥–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ—Ä—è–¥–æ–∫)

1. üîê **manifest.json v2 (final)** + audit log
2. üîÅ **state machine –≤ –∫–æ–¥–µ** (enum + transitions)
3. üß™ **test fixtures** –ø–æ–¥ –∫–∞–∂–¥—ã–π CLI-–ø—É–Ω–∫—Ç
4. üß† **Docling adapter layer** (AST ‚Üí nodes)

–ì–æ—Ç–æ–≤–æ. –Ø –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ **–¥–æ–ø–æ–ª–Ω–∏–ª canvas-–¥–æ–∫—É–º–µ–Ω—Ç** –∏ –∑–∞–∫—Ä—ã–ª –≤—Å–µ 4 –ø—É–Ω–∫—Ç–∞ —Ç–∞–∫, —á—Ç–æ–±—ã —Ç—ã –º–æ–≥ **–ø—Ä—è–º–æ –ø–æ —Ç–µ–∫—Å—Ç—É —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ CursorAI –±–µ–∑ –¥–æ–¥—É–º—ã–≤–∞–Ω–∏–π**.

–ö—Ä–∞—Ç–∫–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É—é, **—á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∏ –∫–∞–∫ —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è** ‚Äî –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ –∏–∑ canvas.

---

## 1Ô∏è‚É£ `manifest.json v2 (final)` + Audit log

–í –¥–æ–∫—É–º–µ–Ω—Ç–µ —Ç–µ–ø–µ—Ä—å:

### ‚úÖ `manifest.json v2`

* **unit-level manifest** (1 manifest = 1 UNIT = 1 protocol_id)
* —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç:

  * `protocol_id`, `unit_id`, `cycle`
  * `current_state`, `current_cluster`
  * `applied_operations[]` (convert / extract / normalize / rename)
  * `source_files[]` ‚Üí `result_files[]`
  * `ready_for_docling: bool`
* **—Å—Ç—Ä–æ–≥–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω —Å–æ state machine**
* —Ä–∞—Å—à–∏—Ä—è–µ–º –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π (v2 ‚Üí v3)

### ‚úÖ Audit log (`audit.log.jsonl`)

* append-only
* 1 event = 1 –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
* –ø—Ä–∏–≥–æ–¥–µ–Ω –¥–ª—è:

  * –æ—Ç–ª–∞–¥–∫–∏
  * –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
  * —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ —Ç—Ä–µ–∫–∏–Ω–≥–∞ (–≥–æ—Å–∑–∞–∫—É–ø–∫–∏ üëç)

üí° **–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å**
Manifest = *—Å–æ—Å—Ç–æ—è–Ω–∏–µ*, Audit = *–∏—Å—Ç–æ—Ä–∏—è*.
–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–º–µ—à–∏–≤–∞—é—Ç—Å—è.

---

## 2Ô∏è‚É£ State machine –≤ –∫–æ–¥–µ (Enum + transitions)

–í canvas –µ—Å—Ç—å:

### üîÅ `UnitState` (Enum)

* `RAW`
* `CLASSIFIED`
* `PENDING_CONVERT`
* `PENDING_EXTRACT`
* `PENDING_NORMALIZE`
* `MERGED_DIRECT`
* `MERGED_PROCESSED`
* `EXCEPTION_*`
* `READY_FOR_DOCLING`

### üîÄ `ALLOWED_TRANSITIONS`

* —Å—Ç—Ä–æ–≥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
* **–Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã silent jumps**
* –∫–∞–∂–¥–∞—è CLI-–∫–æ–º–∞–Ω–¥–∞:

  * –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `can_transition()`
  * –ª–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–∫–∞–∑ –∫–∞–∫ `audit_event(type="invalid_transition")`

üí° –≠—Ç–æ **–Ω–µ workflow**, –∞ **–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç**, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è pipeline –ø–æ–¥ –≥–æ—Å–¥–∞–Ω–Ω—ã–µ.

---

## 3Ô∏è‚É£ Test fixtures –ø–æ–¥ –∫–∞–∂–¥—ã–π CLI-–ø—É–Ω–∫—Ç

–í –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ–ø–∏—Å–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `tests/fixtures/`:

### üß™ –î–ª—è –∫–∞–∂–¥–æ–≥–æ CLI-–ø—É–Ω–∫—Ç–∞:

* `classifier/`
* `convert/`
* `extract/`
* `normalize_name/`
* `normalize_ext/`
* `merge/`
* `exceptions/`

–ö–∞–∂–¥—ã–π fixture —Å–æ–¥–µ—Ä–∂–∏—Ç:

* –≤—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã (–±–∏—Ç—ã–µ, –∞—Ä—Ö–∏–≤—ã, misnamed)
* –æ–∂–∏–¥–∞–µ–º—É—é FS-—Å—Ç—Ä—É–∫—Ç—É—Ä—É
* –æ–∂–∏–¥–∞–µ–º—ã–π `manifest.json`
* –æ–∂–∏–¥–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ `audit.log.jsonl`

### ‚úî –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:

* pytest
* snapshot-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
* CLI ‚Üí engine ‚Üí FS ‚Üí manifest ‚Üí audit

---

## 4Ô∏è‚É£ Docling adapter layer (AST ‚Üí nodes)

–î–æ–±–∞–≤–ª–µ–Ω **—á—ë—Ç–∫–∏–π —Å–ª–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏**, –∞ –Ω–µ ¬´–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ª–æ–±¬ª:

### üß† `DoclingAdapter`

* –≤—Ö–æ–¥: `Ready2Docling/UNIT_xxx`
* —á–∏—Ç–∞–µ—Ç:

  * `manifest.json`
  * –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
* —Å—Ç—Ä–æ–∏—Ç:

  * `DocNode`
  * `PageNode`
  * `FileNode`
  * `MetadataNode`

### üéØ –í–∞–∂–Ω–æ

* preprocessing **–ù–ï –∑–Ω–∞–µ—Ç –ø—Ä–æ Docling**
* Docling **–ù–ï –∑–Ω–∞–µ—Ç –ø—Ä–æ Pending / Merge**
* —Å–≤—è–∑—å ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ adapter

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç:

* –º–µ–Ω—è—Ç—å Docling
* –¥–æ–±–∞–≤–ª—è—Ç—å PaddleOCR / VLM
* –¥–µ–ª–∞—Ç—å dry-run / replay

---

## –ö–∞–∫ —Ç–µ–±–µ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ CursorAI

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å **repo skeleton**
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

   * `state_machine.py`
   * `manifest.py`
   * `audit.py`
3. –ü–æ–¥–∫–ª—é—á–∏—Ç—å CLI ‚Üí engine ‚Üí state checks
4. –ü—Ä–æ–≥–Ω–∞—Ç—å fixtures
5. –ü–æ–¥–∫–ª—é—á–∏—Ç—å Docling adapter

---

## –°–ª–µ–¥—É—é—â–∏–µ –ª–æ–≥–∏—á–Ω—ã–µ —à–∞–≥–∏ (–ø—Ä–µ–¥–ª–∞–≥–∞—é)

–ï—Å–ª–∏ –∏–¥—ë–º –¥–∞–ª—å—à–µ, —è –º–æ–≥—É:

1Ô∏è‚É£ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å **—Ä–µ–∞–ª—å–Ω—ã–π Typer CLI –∫–æ–¥** (–≥–æ—Ç–æ–≤—ã–π –∫ –∑–∞–ø—É—Å–∫—É)
2Ô∏è‚É£ –°–¥–µ–ª–∞—Ç—å **Mermaid-–¥–∏–∞–≥—Ä–∞–º–º—ã** state machine + preprocessing
3Ô∏è‚É£ –ü—Ä–æ–ø–∏—Å–∞—Ç—å **policy –æ—à–∏–±–æ–∫** (retry / skip / quarantine)
4Ô∏è‚É£ –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å **VLM / OCR branch** –∫–∞–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ state machine
5Ô∏è‚É£ –°–¥–µ–ª–∞—Ç—å **Docling-ready schema contract** (JSON Schema)

–ì–æ—Ç–æ–≤–æ. –Ø –≤—ã–ø–æ–ª–Ω–∏–ª **–≤—Å–µ 4 –ø—É–Ω–∫—Ç–∞** –∏ –æ—Ñ–æ—Ä–º–∏–ª –∏—Ö —Ç–∞–∫, —á—Ç–æ–±—ã —Ç—ã –º–æ–≥ **–ø—Ä—è–º–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ CursorAI –∏ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –±–µ–∑ –¥–æ–≥–∞–¥–æ–∫**.

–ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å:

---

## ‚úÖ 1Ô∏è‚É£ –†–µ–∞–ª—å–Ω—ã–π Typer CLI (production-ready)

* –ù–∞—Å—Ç–æ—è—â–∏–π –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π –∫–æ–¥ –Ω–∞ **Typer**
* –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ = **–æ–¥–∏–Ω —ç—Ç–∞–ø –∏–ª–∏ –ø–æ–¥—ç—Ç–∞–ø**
* –û–±—Ä–∞–±–æ—Ç–∫–∞ **–≤—Å–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏**
* `merge` —Å–æ–±–∏—Ä–∞–µ—Ç **Merge_1 + Merge_2 + Merge_3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ** ‚Üí `Ready2Docling`
* CLI —Ç–æ–Ω–∫–∏–π, –≤—Å—è –ª–æ–≥–∏–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ execution engine (–∫–∞–∫ –∏ –Ω—É–∂–Ω–æ)

–¢—ã –º–æ–∂–µ—à—å:

```bash
python -m docprep.cli classify ./Input --cycle 1
python -m docprep.cli convert ./Pending_1 --cycle 1
python -m docprep.cli merge ./data
```

---

## ‚úÖ 2Ô∏è‚É£ Mermaid-–¥–∏–∞–≥—Ä–∞–º–º—ã

–í canvas:

* üß† **State machine** ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã UNIT
* üîÅ **Preprocessing pipeline** ‚Äî –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–æ —Ç–µ—á—ë—Ç —Ñ–∞–π–ª–æ–≤—ã–π –ø–æ—Ç–æ–∫

–û–Ω–∏:

* –≤–∞–ª–∏–¥–Ω—ã
* –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è –≤ Mermaid
* –º–æ–≥—É—Ç –ª–µ—á—å –≤ PRD / README / –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é

---

## ‚úÖ 3Ô∏è‚É£ Policy –æ—à–∏–±–æ–∫ (–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

–ß—ë—Ç–∫–æ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã:

* üîÑ **Retry** (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±–æ–∏)
* ‚è≠ **Skip** (–±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ —Å–ª—É—á–∞–∏)
* üö® **Quarantine** (–æ–ø–∞—Å–Ω—ã–µ / —Å–ª–æ–º–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

–ï—Å—Ç—å:

* —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Quarantine
* —Å–≤—è–∑—å —Å audit log
* severity-–º–æ–¥–µ–ª—å (–≥–æ—Ç–æ–≤–æ –ø–æ–¥ –∞–ª–µ—Ä—Ç—ã)

---

## ‚úÖ 4Ô∏è‚É£ Docling-ready schema contract

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π **JSON Schema**:

* unit_id / protocol_id
* files —Å —Ä–æ–ª—è–º–∏ (document / page / attachment)
* metadata —Å –∏—Å—Ç–æ—Ä–∏–µ–π preprocessing

–≠—Ç–æ:

* üöÄ –ø—Ä—è–º–æ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –º–µ–∂–¥—É preprocessing –∏ Docling
* üí° –º–æ–∂–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º Docling
* üß† –∏–¥–µ–∞–ª—å–Ω–æ –ª–æ–∂–∏—Ç—Å—è –Ω–∞ AST ‚Üí nodes

---

## –ß—Ç–æ –¥–∞–ª—å—à–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥)

–ï—Å–ª–∏ –∏–¥—ë–º **–ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–∑—Ä–æ—Å–ª–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏**, –¥–∞–ª—å—à–µ –ª–æ–≥–∏—á–Ω–æ:

1. üß© **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å execution engine –∫–ª–∞—Å—Å—ã** (Classifier / Converter / Extractor)
2. üßæ **–°–¥–µ–ª–∞—Ç—å audit.jsonl writer + correlation_id**
3. üß† **Docling adapter**: filesystem ‚Üí AST nodes
4. üß™ **Golden test cases** (fixtures ‚Üí expected tree)