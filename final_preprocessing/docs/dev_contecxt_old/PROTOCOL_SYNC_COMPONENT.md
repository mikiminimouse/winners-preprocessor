# КОМПОНЕНТ СИНХРОНИЗАЦИИ ПРОТОКОЛОВ

## Обзор

Компонент синхронизации протоколов - это **первый компонент системы препроцессинга**, отвечающий за извлечение данных о протоколах закупок из удаленной MongoDB через VPN и подготовку их для последующего скачивания документов.

**Текущий статус: ✅ ГОТОВ К ПРОДАКШЕНУ**

## Архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Удаленная      │    │  Protocol Sync   │    │  Локальная      │
│  MongoDB        │◄──►│  Component       │───►│  MongoDB        │
│  192.168.0.46   │    │  router/         │    │  localhost:27017 │
│  protocols223   │    │  protocol_sync.py│    │  docling_       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
        ↑ VPN                    │                       │
        └────────────────────────┘                       │
                                                        ▼
                                                 ┌─────────────────┐
                                                 │  CLI Menu       │
                                                 │  пункт 1        │
                                                 │                 │
                                                 └─────────────────┘
```

## Функциональность

### Основные функции

1. **get_remote_mongo_mcp_client()** - Подключение к удаленной MongoDB (MCP стиль)
2. **get_local_mongo_client()** - Подключение к локальной MongoDB
3. **sync_protocols_for_date()** - Основная функция синхронизации
4. **_extract_urls_from_attachments()** - Извлечение URL из документов
5. **_generate_unit_id()** - Генерация уникальных идентификаторов

### Особенности реализации

- **Прямое VPN подключение**: 192.168.0.46:8635 через OpenVPN туннель
- **Аутентификация**: `authSource=protocols223` для внутреннего доступа
- **SSL/TLS шифрование**: С сертификатом sber2.crt
- **Предотвращение дубликатов**: Проверка по `purchaseNoticeNumber` и `source`
- **Генерация unit_id**: Уникальные идентификаторы в формате `UNIT_<16hex>`
- **Обработка ошибок**: Graceful handling всех типов исключений

## Интеграция в CLI

### Пункт меню 1: "Синхронизация протоколов"

```
=== ЗАГРУЗКА И ПОДГОТОВКА ДАННЫХ ===

1. Синхронизация протоколов из MongoDB
2. Скачивание протоколов через VPN
3. Проверка файлов в INPUT_DIR
```

### Процесс выполнения через CLI

```bash
# Запуск CLI
python3 preprocessing/run_cli.py

# Выбор пункта 1
# Следование инструкциям:
# 1. Выбор даты (вчера/указать вручную)
# 2. Указание лимита протоколов
# 3. Подтверждение запуска
```

### Вывод CLI

```
=== СИНХРОНИЗАЦИЯ ПРОТОКОЛОВ ИЗ УДАЛЁННОЙ MONGODB ===

1. Проверка подключения к удалённой MongoDB...
✓ Подключение к удалённой MongoDB успешно

2. Проверка подключения к локальной MongoDB...
✓ Подключение к локальной MongoDB успешно

3. Выбор даты для синхронизации:
  1. Вчерашний день (по умолчанию)
  2. Указать дату вручную (YYYY-MM-DD)
  Выберите [1-2] или Enter для вчерашнего дня: 1

4. Лимит протоколов для синхронизации (по умолчанию: 200): 500

5. Запуск синхронизации...
   Дата: 2024-12-17
   Лимит: 500

   Запрос протоколов за дату: 2024-12-17

   РЕЗУЛЬТАТ СИНХРОНИЗАЦИИ:
   просмотрено документов: 234
   вставлено новых протоколов: 189
   пропущено (уже были): 45

✓ Синхронизация завершена успешно!
```

## Структура данных

### Входные данные (удаленная MongoDB)

```javascript
{
  "purchaseInfo": {
    "purchaseNoticeNumber": "01234567890123456789"
  },
  "attachments": {
    "document": [{
      "url": "https://zakupki.gov.ru/...",
      "fileName": "protocol.pdf",
      "guid": "guid-uuid",
      "contentUid": "content-uuid",
      "description": "Протокол подведения итогов"
    }]
  },
  "loadDate": ISODate("2024-12-17T10:30:00Z")
}
```

### Выходные данные (локальная MongoDB)

```javascript
{
  // СЛУЖЕБНЫЕ ПОЛЯ ПРЕПРОЦЕССИНГА
  "unit_id": "UNIT_a1b2c3d4e5f6789a",
  "urls": [...],           // Извлеченные URLs из attachments
  "multi_url": false,      // true если >1 URL
  "url_count": 1,          // Количество URLs
  "source": "remote_mongo_direct",
  "status": "pending",
  "created_at": ISODate("2024-12-18T09:15:00Z"),
  "updated_at": ISODate("2024-12-18T09:15:00Z"),

  // ПОЛНЫЕ ДАННЫЕ ПРОТОКОЛА ИЗ MONGODB (~30+ полей)
  "guid": "96044532-5438-4fa7-97bd-16de4b30699e",
  "purchaseInfo": {
    "purchaseNoticeNumber": "32515525370",
    "name": "Название закупки",
    "purchaseMethodCode": "4142",
    // ... все поля purchaseInfo
  },
  "placer": {
    "mainInfo": {
      "fullName": "Название организации заказчика",
      "legalAddress": "Адрес",
      // ... полная информация о заказчике
    }
  },
  "status": "P",
  "type": 419551,
  "typeName": "Протокол подведения итогов",
  "procedureDate": ISODate("..."),
  "procedurePlace": "Адрес проведения",
  "lotApplicationsList": {
    // Полная информация о лотах и заявках
  },
  "publicationDateTime": ISODate("..."),
  "loadDate": ISODate("..."),
  "region": "Moskva",
  // ... ВСЕ остальные поля из оригинального документа
}
```

## Метрики и мониторинг

### Основные метрики

- **scanned**: Количество просмотренных документов в удаленной БД
- **inserted**: Количество новых вставленных протоколов
- **skipped_existing**: Количество пропущенных дубликатов
- **errors_count**: Количество ошибок обработки

### Логирование

- Подробные логи подключения к MongoDB
- Информация о каждом обработанном протоколе
- Предупреждения о дубликатах
- Ошибки с полным traceback

## Конфигурация

### Переменные окружения

```bash
# Удаленная MongoDB (через VPN)
MONGO_SERVER=192.168.0.46:8635
MONGO_USER=readProtocols223
MONGO_PASSWORD=cei8saht8UCh3oka4geegheuwahzoph2
MONGO_SSL_CERT=/root/winners_preprocessor/certs/sber2.crt

# Локальная MongoDB
LOCAL_MONGO_SERVER=localhost:27017
MONGO_METADATA_USER=admin
MONGO_METADATA_PASSWORD=password

# Параметры синхронизации
PROTOCOLS_COUNT_LIMIT=500
```

## Следующие этапы

После успешной синхронизации протоколов система переходит к:

1. **Скачиванию документов** - компонент скачивает PDF файлы по URL из `zakupki.gov.ru`
2. **Нормализации** - приведение документов к единому формату
3. **Обработке Docling** - извлечение текста и метаданных
4. **Классификации** - определение типа документа
5. **Распределению** - разнесение по категориям

## Диагностика проблем

### Распространенные ошибки

1. **"Не удалось подключиться к удалённой MongoDB"**
   - Проверить VPN подключение
   - Проверить SSL сертификат
   - Проверить учетные данные

2. **"Не удалось подключиться к локальной MongoDB"**
   - Проверить запущен ли Docker контейнер
   - Проверить учетные данные локальной БД

3. **Низкая производительность**
   - Увеличить лимит `PROTOCOLS_COUNT_LIMIT`
   - Проверить скорость сети
   - Проверить загрузку MongoDB

### Логи и отладка

```bash
# Просмотр логов
tail -f /root/winners_preprocessor/logs/preprocessing.log

# Тестирование подключений
python3 -c "
from preprocessing.router.protocol_sync import get_remote_mongo_mcp_client, get_local_mongo_client
print('Remote:', bool(get_remote_mongo_mcp_client()))
print('Local:', bool(get_local_mongo_client()))
"
```

## Безопасность

- **Шифрование**: Все подключения используют SSL/TLS
- **Аутентификация**: SCRAM-SHA-1 механизм аутентификации
- **Секреты**: Пароли хранятся в переменных окружения
- **Доступ**: Только чтение из удаленной БД, чтение+запись в локальную
