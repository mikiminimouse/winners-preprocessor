# Документация компонентов системы DocPrep

## Обзор

DocPrep - система предобработки документов перед передачей в Docling pipeline. Система обеспечивает классификацию, конвертацию, извлечение из архивов, нормализацию и финальную сборку документов.

## Структура компонентов

### 1. Core компоненты (`docprep/core/`)

#### 1.1. Config (`config.py`)
**Назначение**: Управление конфигурацией и структурой директорий.

**Основные функции**:
- `init_directory_structure(date)` - инициализация структуры директорий для даты
- `get_cycle_paths(cycle, protocol_date, ...)` - получение путей для цикла обработки
- `DATA_BASE_DIR` - базовая директория для данных

**Структура директорий**:
```
Data/YYYY-MM-DD/
├── Input/              # Входные UNIT
├── Processing/
│   ├── Processing_1/   # Цикл 1
│   │   ├── Convert/
│   │   ├── Extract/
│   │   └── Normalize/
│   ├── Processing_2/   # Цикл 2
│   └── Processing_3/   # Цикл 3
├── Merge/
│   ├── Merge_0/
│   │   └── Direct/     # Прямые файлы (не требуют обработки)
│   ├── Merge_1/        # После цикла 1
│   │   ├── Converted/
│   │   ├── Extracted/
│   │   └── Normalized/
│   ├── Merge_2/        # После цикла 2
│   └── Merge_3/        # После цикла 3
├── Exceptions/
│   ├── Exceptions_1/
│   │   ├── Special/
│   │   ├── Mixed/
│   │   ├── Ambiguous/
│   │   └── Empty/
│   ├── Exceptions_2/
│   └── Exceptions_3/
└── Ready2Docling/      # Финальная сборка
    ├── docx/
    ├── pdf/
    │   ├── scan/
    │   ├── text/
    │   └── mixed/
    └── ...
```

**Использование**:
- Инициализация структуры при начале обработки новой даты
- Получение путей для перемещения UNIT между директориями
- Определение целевых директорий для каждого этапа обработки

---

#### 1.2. State Machine (`state_machine.py`)
**Назначение**: Управление переходами состояний UNIT.

**Состояния**:
- `RAW` - начальное состояние из Input
- `CLASSIFIED_1/2/3` - после классификации в цикле N
- `PENDING_CONVERT/EXTRACT/NORMALIZE` - ожидание обработки
- `MERGED_DIRECT` - готов к merge (direct из цикла 1)
- `MERGED_PROCESSED` - готов к merge (обработанный)
- `EXCEPTION_1/2/3` - ошибка в цикле N
- `READY_FOR_DOCLING` - финальное состояние

**Разрешенные переходы**:
```python
RAW → CLASSIFIED_1, EXCEPTION_1
CLASSIFIED_1 → MERGED_DIRECT, PENDING_*, EXCEPTION_1
PENDING_* → CLASSIFIED_2
CLASSIFIED_2 → MERGED_PROCESSED, PENDING_*, EXCEPTION_2
CLASSIFIED_3 → MERGED_PROCESSED, EXCEPTION_3
MERGED_* → READY_FOR_DOCLING
```

**Использование**:
- Проверка возможности перехода между состояниями
- Валидация переходов при обновлении состояния UNIT
- Отслеживание истории переходов в manifest

---

#### 1.3. Manifest (`manifest.py`)
**Назначение**: Хранение метаданных и истории обработки UNIT.

**Структура manifest v2**:
```json
{
  "schema_version": "2.0",
  "unit_id": "UNIT_xxx",
  "protocol_id": "...",
  "protocol_date": "YYYY-MM-DD",
  "files": [
    {
      "original_name": "...",
      "current_name": "...",
      "detected_type": "...",
      "needs_ocr": true/false,
      "transformations": [...]
    }
  ],
  "processing": {
    "current_cycle": 1,
    "max_cycles": 3,
    "operations": [...]
  },
  "state_machine": {
    "current_state": "CLASSIFIED_1",
    "state_trace": ["RAW", "CLASSIFIED_1"]
  }
}
```

**Использование**:
- Сохранение состояния UNIT после каждой операции
- Отслеживание трансформаций файлов
- Восстановление состояния при повторной обработке

---

#### 1.4. Audit Log (`audit.py`)
**Назначение**: Полное логирование всех операций в JSONL формате.

**Формат записи**:
```json
{
  "timestamp": "ISO8601",
  "unit_id": "UNIT_xxx",
  "event_type": "operation",
  "operation": "classify|convert|extract|normalize|merge",
  "details": {...},
  "state_before": "...",
  "state_after": "..."
}
```

**Использование**:
- Аудит всех операций для отладки
- Анализ ошибок и проблем
- Восстановление истории обработки

---

### 2. Engine компоненты (`docprep/engine/`)

#### 2.1. Classifier (`classifier.py`)
**Назначение**: Классификация файлов и определение маршрута обработки.

**Категории классификации**:
- `direct` - не требует обработки (PDF text, DOCX, XLSX, изображения)
- `convert` - требует конвертации (DOC → DOCX, XLS → XLSX, PPT → PPTX)
- `extract` - архив, требует извлечения (ZIP, RAR, 7Z)
- `normalize` - требует нормализации расширений/имен
- `special` - специальные форматы
- `mixed` - смешанные типы файлов
- `unknown` - неизвестный тип
- `empty` - пустой UNIT

**Процесс классификации**:
1. Сбор файлов из UNIT
2. Определение типа каждого файла через `detect_file_type`
3. Разрешение конфликтов через Decision Engine
4. Определение категории UNIT
5. Перемещение в соответствующую директорию
6. Обновление состояния

**Использование**:
- Первичная классификация из Input (цикл 1)
- Повторная классификация после обработки (циклы 2, 3)
- Определение маршрута обработки для каждого UNIT

---

#### 2.2. Converter (`converter.py`)
**Назначение**: Конвертация файлов через LibreOffice.

**Поддерживаемые конвертации**:
```python
CONVERSION_MAP = {
    "doc": "docx",  # Исправлено: ранее ошибочно конвертировалось в xlsx
    "xls": "xlsx",
    "ppt": "pptx",
    "rtf": "docx",
}

LIBREOFFICE_FORMAT_MAP = {
    "docx": "docx",
    "pdf": "pdf",
    "xlsx": "xlsx",
    "pptx": "pptx",
}
```

**Процесс конвертации**:
1. Поиск файлов для конвертации в UNIT
2. Определение исходного и целевого формата
3. Конвертация через LibreOffice headless (с использованием LIBREOFFICE_FORMAT_MAP)
4. Обновление manifest с информацией о трансформации
5. Перемещение UNIT в Merge_N/Converted
6. Обновление состояния

**Исправления (2025-12-20)**:
- Исправлена логика определения типа .doc файлов (приоритет расширения перед OLE2 signature)
- Исправлен CONVERSION_MAP (doc → docx вместо doc → xlsx)
- Добавлен LIBREOFFICE_FORMAT_MAP для корректного маппинга форматов LibreOffice

**Использование**:
- Конвертация старых Office форматов в современные
- Обработка UNIT из Processing_N/Convert
- Перемещение в Merge_N/Converted после конвертации

---

#### 2.3. Extractor (`extractor.py`)
**Назначение**: Безопасное извлечение архивов.

**Поддерживаемые форматы**:
- ZIP (через zipfile)
- RAR (через rarfile)
- 7Z (через py7zr)

**Ограничения безопасности**:
- Максимальный размер распаковки: 500 MB
- Максимальное количество файлов: 1000
- Максимальная глубина: 10

**Процесс извлечения**:
1. Поиск архивов в UNIT
2. Проверка лимитов безопасности
3. Извлечение файлов
4. Обновление manifest
5. Перемещение UNIT в Merge_N/Extracted
6. Обновление состояния

**Использование**:
- Извлечение архивов из Processing_N/Extract
- Перемещение в Merge_N/Extracted после извлечения
- Повторная классификация извлеченных файлов

---

#### 2.4. Normalizers (`normalizers/`)
**Назначение**: Нормализация имен и расширений файлов.

**Компоненты**:
- `NameNormalizer` - нормализация имен файлов
- `ExtensionNormalizer` - нормализация расширений по сигнатурам

**Процесс нормализации**:
1. Проверка файлов в UNIT
2. Определение правильного расширения по сигнатуре
3. Переименование файлов
4. Обновление manifest
5. Перемещение UNIT в Merge_N/Normalized
6. Обновление состояния

**Использование**:
- Нормализация расширений по magic bytes
- Исправление неправильных расширений
- Обработка UNIT из Processing_N/Normalize

---

#### 2.5. Merger (`merger.py`)
**Назначение**: Финальная сборка UNIT в Ready2Docling.

**Процесс сбора**:
1. Сбор UNIT из всех Merge_N директорий (включая Merge_0/Direct)
2. Дедупликация (приоритет более поздним циклам)
3. Определение типа файлов (с учетом расширений, если detected_type = "unknown")
4. Сортировка по расширениям
5. Специальная обработка PDF (scan/text/mixed на основе needs_ocr из manifest)
6. Копирование файлов в Ready2Docling
7. Обновление состояния на READY_FOR_DOCLING

**Особенности**:
- Рекурсивный поиск файлов во вложенных директориях (после извлечения архивов)
- Правильная сортировка PDF по needs_ocr из manifest или прямой проверке файла
- Определение PDF по расширениям даже при detected_type = "unknown"
- Исключение пустых файлов
- Исключение mixed/special/ambiguous UNIT из Ready2Docling
- Проверка валидности файлов (не пустые, прошли обработку)
 
 Дполнительно нужно реализовать: 
 - Проверка что файлы не пустые и прошли соответствующие этапы обработки: классификации, конвертации, извлечения, нормализации.
 - Проверка units с файлами на что они были перемещены коректно и чисто после всех циклов обработки в Ready2Docling или Exceptions.

**Использование**:
- Финальная сборка после всех циклов обработки
- Подготовка к передаче в Docling pipeline

---

### 3. Utils компоненты (`docprep/utils/`)

#### 3.1. File Operations (`file_ops.py`)
**Назначение**: Определение типа файлов и работа с файлами.

**Основные функции**:
- `detect_file_type(file_path)` - определение типа файла
- `detect_file_type` использует три источника истины:
  1. MIME type
  2. File signature (magic bytes)
  3. File extension

**Decision Engine**:
- Разрешает конфликты между источниками
- Определяет true_type через структурный парсинг
- Классифицирует файлы (direct, convert, extract, normalize, special, unknown)

**Особенности**:
- Детекция PDF с текстовым слоем (needs_ocr)
- Определение OLE2 форматов (doc, xls, ppt)
- Проверка fake документов (архивы с расширением документа)

**Использование**:
- Классификация файлов в Classifier
- Определение типа для конвертации
- Проверка needs_ocr для PDF

---

#### 3.2. Paths (`paths.py`)
**Назначение**: Утилиты для работы с путями и UNIT.

**Основные функции**:
- `get_unit_files(unit_path)` - рекурсивное получение всех файлов из UNIT (включая вложенные директории)
- `sanitize_filename(name)` - санитизация имен файлов
- `determine_unit_extension(unit_path)` - определение расширения UNIT

**Использование**:
- Рекурсивный поиск файлов в UNIT (включая файлы после извлечения архивов)
- Определение расширения для сортировки
- Безопасное именование файлов

**Исправления (2025-12-20)**:
- Реализован рекурсивный поиск файлов через `rglob("*")` вместо фиксированной директории "files"
- Корректная обработка файлов после извлечения архивов с произвольными именами директорий

---

### 4. CLI компоненты (`docprep/cli/`)

#### 4.1. Pipeline (`pipeline.py`)
**Назначение**: Основные команды для запуска pipeline.

**Команды**:
- `run` - запуск полного pipeline
- `cycle` - запуск одного цикла
- `stage` - запуск одного этапа
- `classify` - только классификация
- `merge` - только финальный merge

**Использование**:
- Запуск обработки через CLI
- Тестирование отдельных компонентов

---

## Поток обработки

### Цикл 1:
1. **Input** → Classifier → распределение в:
   - `Merge_0/Direct` (direct файлы)
   - `Processing_1/Convert` (требуют конвертации)
   - `Processing_1/Extract` (архивы)
   - `Processing_1/Normalize` (требуют нормализации)
   - `Exceptions_1/*` (special, mixed, unknown, empty)

2. **Processing_1** → обработка через:
   - Converter → `Merge_1/Converted`
   - Extractor → `Merge_1/Extracted`
   - Normalizer → `Merge_1/Normalized`

### Цикл 2:
1. **Merge_1** → Classifier → распределение в:
   - `Merge_2/*` (direct после обработки)
   - `Processing_2/*` (требуют дальнейшей обработки)
   - `Exceptions_2/*` (проблемные UNIT)

2. **Processing_2** → обработка → `Merge_2/*`

### Цикл 3:
1. **Merge_2** → Classifier → распределение в:
   - `Merge_3/*`
   - `Processing_3/*`
   - `Exceptions_3/*`

2. **Processing_3** → обработка → `Merge_3/*`

### Финальный merge:
- **Все Merge_N** → Merger → `Ready2Docling/`

---

## Конфигурация

### State Machine
Определена в `docprep/core/state_machine.py`:
- `ALLOWED_TRANSITIONS` - разрешенные переходы
- `UnitState` - перечисление состояний

### Conversion Map
Определена в `docprep/engine/converter.py`:
- `CONVERSION_MAP` - маппинг форматов для конвертации
- `LIBREOFFICE_FORMAT_MAP` - маппинг форматов для LibreOffice

### Directory Structure
Определена в `docprep/core/config.py`:
- `init_directory_structure()` - создание структуры
- `get_cycle_paths()` - получение путей для цикла

---

## Утилиты

### File Type Detection
- Использует три источника истины
- Decision Engine для разрешения конфликтов
- Структурный парсинг для сложных случаев

### Manifest Management
- Версионирование (v2)
- Отслеживание трансформаций
- История состояний

### Audit Logging
- JSONL формат
- Полная история операций
- Корреляционные ID для трассировки

---

## Зависимости

### Внешние библиотеки:
- `typer` - CLI интерфейс
- `rich` - форматирование вывода
- `rarfile` - извлечение RAR
- `py7zr` - извлечение 7Z
- `python-magic` - определение MIME типов

### Системные утилиты:
- `libreoffice` - конвертация документов
- `file` - определение типа файлов (fallback)

---

## Тестирование

### Скрипты тестирования:
- `run_final_testing.py` - полное тестирование всех циклов
- `cleanup_test_data.py` - очистка тестовых данных
- `fix_misclassified_units.py` - исправление неправильно классифицированных UNIT
- `analyze_errors.py` - анализ ошибок в manifest и audit logs
- `generate_final_report.py` - генерация финального отчета

---

## Известные проблемы и решения

### Проблема: .doc файлы определяются как xls
**Решение**: Исправлена логика определения типа в `file_ops.py` - добавлена проверка расширения перед определением типа по сигнатуре.

### Проблема: .doc файлы попадают в docx без конвертации
**Решение**: Удален маппинг "doc" → "docx" в `merger.py`, добавлена проверка на конвертацию.

### Проблема: Файлы не находятся во вложенных директориях после извлечения
**Решение**: Реализован рекурсивный поиск файлов в `merger.py` вместо жестко закодированной директории "files".

---

## Рекомендации по использованию

1. **Всегда инициализируйте структуру директорий** перед началом обработки
2. **Используйте copy_mode=True** для тестирования, чтобы не терять исходные данные
3. **Проверяйте audit logs** при возникновении проблем
4. **Анализируйте manifest** для понимания истории обработки UNIT
5. **Используйте скрипты тестирования** для проверки корректности работы

---

*Документация обновлена: 2025-12-20*

