# Отчет об исправлении ошибок сортировки UNIT по расширениям

## Проблемы

### 1. ZIP архив попал в неправильную директорию
**Проблема**: `UNIT_extract_zip` с файлом `archive.zip` попал в `Processing/Processing_1/Extract/doc/` вместо `Extract/zip/`

**Причина**: Для категории `extract` использовался `detected_type` вместо исходного расширения файла. Если ZIP определялся неправильно (например, как "doc"), то UNIT попадал в неправильную директорию.

**Решение**: Изменена логика в `get_extension_subdirectory` для категории `extract` - теперь всегда используется исходное расширение файла (zip, rar, 7z).

### 2. .doc файлы попали в неправильные директории
**Проблема**: 
- `UNIT_a2f8a36ea3c14aec` с файлом `.doc` попал в `Normalize/txt/` вместо `Normalize/doc/`
- `UNIT_3a12b09b4a864ba6` с файлом `.doc` попал в `Normalize/docx/` вместо `Normalize/doc/`

**Причина**: Для категории `normalize` использовался `detected_type` вместо исходного расширения файла. Если файл `.doc` определялся неправильно (например, как "txt" или "docx"), то UNIT попадал в неправильную директорию.

**Решение**: Изменена логика в `get_extension_subdirectory` для категории `normalize` - теперь используется исходное расширение файла, если оно корректное и поддерживается.

### 3. jpeg файлы попали в директорию jpeg вместо jpg
**Проблема**: Файлы с расширением `.jpeg` попадали в `Normalize/jpeg/` вместо `Normalize/jpg/`

**Причина**: Не было нормализации расширения `jpeg` -> `jpg`

**Решение**: Добавлена нормализация расширения `jpeg` -> `jpg` в логике определения расширения.

## Выполненные исправления

### 1. Исправлена логика определения расширения для Extract
**Файл**: `docprep/core/unit_processor.py`

**Изменения**:
- Для категории `extract` теперь всегда используется исходное расширение файла (zip, rar, 7z)
- Проверяется, что расширение действительно является архивом
- Fallback на `detected_type` только если исходное расширение не передано или не является архивом

### 2. Исправлена логика определения расширения для Normalize
**Файл**: `docprep/core/unit_processor.py`

**Изменения**:
- Для категории `normalize` теперь используется исходное расширение файла, если оно корректное и поддерживается
- Проверяется, что расширение поддерживается для normalize
- Fallback на `detected_type` только если исходное расширение не передано или не поддерживается

### 3. Добавлено сохранение original_extension в classification
**Файл**: `docprep/engine/classifier.py`

**Изменения**:
- Добавлено сохранение `original_extension` в classification для каждого файла
- Это позволяет `get_extension_subdirectory` использовать исходное расширение

### 4. Исправлены существующие UNIT
- Перемещено 6 неправильно размещенных UNIT:
  - `UNIT_extract_zip`: `Extract/doc/` → `Extract/zip/`
  - `UNIT_1abe0456e2764bd5`: `Normalize/jpeg/` → `Normalize/jpg/`
  - `UNIT_direct_jpg`: `Normalize/jpeg/` → `Normalize/jpg/`
  - `UNIT_2eab5d43902b4c73`: `Normalize/jpeg/` → `Normalize/jpg/`
  - `UNIT_3a12b09b4a864ba6`: `Normalize/docx/` → `Normalize/doc/`
  - `UNIT_a2f8a36ea3c14aec`: `Normalize/txt/` → `Normalize/doc/`

## Результаты

### Статистика исправлений
- **UNIT исправлено**: 6
- **Ошибок при исправлении**: 0

### Распределение после исправления
- **Extract/zip/**: 57 UNIT (было 56 + 1 исправленный)
- **Extract/doc/**: 0 UNIT (было 1, исправлен)
- **Normalize/doc/**: 2 UNIT (было 0, исправлено 2)
- **Normalize/jpg/**: 3 UNIT (было 0, исправлено 3)
- **Normalize/jpeg/**: 0 UNIT (было 3, исправлено)

## Проверки

✅ ZIP архивы попадают в `Extract/zip/`
✅ RAR архивы попадают в `Extract/rar/`
✅ 7z архивы попадают в `Extract/7z/`
✅ .doc файлы попадают в `Normalize/doc/`
✅ .docx файлы попадают в `Normalize/docx/`
✅ .jpg и .jpeg файлы попадают в `Normalize/jpg/`
✅ Исходное расширение используется для сортировки

## Файлы изменены

1. **docprep/core/unit_processor.py**
   - Исправлена логика `get_extension_subdirectory` для категории `extract`
   - Исправлена логика `get_extension_subdirectory` для категории `normalize`
   - Добавлена проверка корректности расширения

2. **docprep/engine/classifier.py**
   - Добавлено сохранение `original_extension` в classification

## Итоги

✅ **Все проблемы исправлены**
✅ **Логика сортировки по расширениям работает корректно**
✅ **Существующие UNIT исправлены**
✅ **Система готова к использованию**

## Примечания

- Файлы с неправильными именами (например, `Протокол 1чpdf` без точки перед расширением) остаются в текущих директориях, так как их расширение не может быть определено корректно
- Для таких файлов используется `detected_type` как fallback

