# Dockerfile –¥–ª—è LibreOffice —Å headless –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
FROM ubuntu:22.04

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y \
    # LibreOffice –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    libreoffice \
    libreoffice-writer \
    libreoffice-calc \
    libreoffice-impress \
    # X11 –¥–ª—è headless
    xvfb \
    xfonts-base \
    xfonts-75dpi \
    xfonts-100dpi \
    xfonts-scalable \
    # –£—Ç–∏–ª–∏—Ç—ã
    curl \
    wget \
    # Python –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º dconf workaround –¥–ª—è headless —Ä–µ–∂–∏–º–∞
ENV DCONF_PROFILE=/dev/null

# –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ LibreOffice —Å Xvfb
RUN echo '#!/bin/bash\n\
# –ó–∞–ø—É—Å–∫ Xvfb –≤ —Ñ–æ–Ω–µ\n\
Xvfb :99 -screen 0 1024x768x24 -ac > /dev/null 2>&1 &\n\
export DISPLAY=:99\n\
\n\
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ dconf –¥–ª—è headless\n\
export DCONF_PROFILE=/dev/null\n\
\n\
# –ó–∞–ø—É—Å–∫ LibreOffice\n\
exec libreoffice "$@"' > /usr/local/bin/libreoffice-headless

RUN chmod +x /usr/local/bin/libreoffice-headless

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
RUN echo '#!/bin/bash\n\
# –ó–∞–ø—É—Å–∫ Xvfb –µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω\n\
if ! pgrep -f "Xvfb.*:99" > /dev/null; then\n\
    Xvfb :99 -screen 0 1024x768x24 -ac > /dev/null 2>&1 &\n\
    sleep 2\n\
fi\n\
\n\
export DISPLAY=:99\n\
export DCONF_PROFILE=/dev/null\n\
\n\
# –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞\n\
INPUT_FILE="$1"\n\
OUTPUT_DIR="${2:-/tmp}"\n\
\n\
if [ -z "$INPUT_FILE" ]; then\n\
    echo "Usage: $0 <input_file> [output_dir]"\n\
    exit 1\n\
fi\n\
\n\
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é\n\
case "$INPUT_FILE" in\n\
    *.doc|*.docx|*.rtf|*.odt)\n\
        OUTPUT_FORMAT=pdf\n\
        ;;\n\
    *.xls|*.xlsx|*.ods)\n\
        OUTPUT_FORMAT=pdf\n\
        ;;\n\
    *.ppt|*.pptx|*.odp)\n\
        OUTPUT_FORMAT=pdf\n\
        ;;\n\
    *)\n\
        OUTPUT_FORMAT=pdf\n\
        ;;\n\
esac\n\
\n\
# –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é\n\
libreoffice --headless \\\n\
    --convert-to "$OUTPUT_FORMAT" \\\n\
    --outdir "$OUTPUT_DIR" \\\n\
    "$INPUT_FILE" 2>/dev/null\n\
\n\
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n\
BASENAME=$(basename "$INPUT_FILE" | sed 's/\.[^.]*$//')\n\
OUTPUT_FILE="$OUTPUT_DIR/$BASENAME.$OUTPUT_FORMAT"\n\
\n\
if [ -f "$OUTPUT_FILE" ]; then\n\
    echo "SUCCESS: $OUTPUT_FILE"\n\
    exit 0\n\
else\n\
    echo "FAILED: Output file not found"\n\
    exit 1\n\
fi' > /usr/local/bin/convert-document

RUN chmod +x /usr/local/bin/convert-document

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
COPY requirements.txt /app/
RUN pip3 install -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–¥
COPY . /app/

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
RUN mkdir -p /tmp/converted /tmp/input

# –¢–µ—Å—Ç–∏—Ä—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
RUN echo "Testing LibreOffice installation..." && \
    echo "LibreOffice version:" && \
    libreoffice-headless --version | head -1 && \
    echo "Xvfb available:" && \
    which xvfb-run && \
    echo "Conversion script available:" && \
    which convert-document

# –ö–æ–º–∞–Ω–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ç–µ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
CMD ["python3", "-c", "
import subprocess
import sys
from pathlib import Path

print('üß™ Testing LibreOffice headless conversion...')

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
test_doc = Path('/tmp/test.doc')
with open(test_doc, 'w') as f:
    f.write('Test document content')

print(f'üìÑ Created test document: {test_doc}')

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
result = subprocess.run([
    '/usr/local/bin/convert-document',
    str(test_doc),
    '/tmp/converted'
], capture_output=True, text=True, timeout=30)

if result.returncode == 0:
    print('‚úÖ LibreOffice conversion test PASSED')
    print(f'üìÑ Output: {result.stdout.strip()}')
    sys.exit(0)
else:
    print('‚ùå LibreOffice conversion test FAILED')
    print(f'üìÑ Error: {result.stderr.strip()}')
    sys.exit(1)
"]