# DocPrep Backend โ Safe Refactoring Configuration

## ๐ฏ ะขะตะบััะฐั ะทะฐะดะฐัะฐ
ะคะธะฝะฐะปัะฝัะน ัะตัะฐะบัะพัะธะฝะณ backend ะฟะตัะตะด ัะดะฐัะตะน ะฟัะพะตะบัะฐ. ะะฐะฑะพัะฐะตะผ ะฟะพ ะฟะปะฐะฝั ะธะท `.claude/DOCPREP_REFACTORING_PLAN.md`.

## โ๏ธ ะะะะขะะงะะกะะะ ะะะะะะะ ะะะะะะะกะะะกะขะ

### ะัะธะฝัะธะฟ "ะะต ะฝะฐะฒัะตะดะธ"
ะญัะพั ัะตัะฐะบัะพัะธะฝะณ ะดะพะปะถะตะฝ ะฃะะฃะงะจะะขะฌ ะบะพะด, ะฝะต ัะปะพะผะฐะฒ ัััะตััะฒััััั ััะฝะบัะธะพะฝะฐะปัะฝะพััั. ะะฐะถะดะพะต ะธะทะผะตะฝะตะฝะธะต ััะตะฑัะตั ะฒะตัะธัะธะบะฐัะธะธ.

### HITL โ Human in the Loop
**ะะะฏะะะขะะะฌะะ ัะฟัะฐัะธะฒะฐะน ะฟะพะดัะฒะตัะถะดะตะฝะธะต ั ัะตะปะพะฒะตะบะฐ ะฟะตัะตะด:**
- ะฃะดะฐะปะตะฝะธะตะผ ะปัะฑัั ัะฐะนะปะพะฒ ะธะปะธ ััะฝะบัะธะน
- ะะทะผะตะฝะตะฝะธะตะผ ะฟัะฑะปะธัะฝัั API (ัะธะณะฝะฐัััั ััะฝะบัะธะน, ะบะปะฐััะพะฒ)
- ะะพะดะธัะธะบะฐัะธะตะน ะบะพะฝัะธะณััะฐัะธะธ ะฟััะตะน (config.py)
- ะะทะผะตะฝะตะฝะธะตะผ State Machine transitions
- ะัะฑัะผะธ ะธะทะผะตะฝะตะฝะธัะผะธ, ะบะพัะพััะต ะผะพะณัั ะฟะพะฒะปะธััั ะฝะฐ ัััะตััะฒัััะธะต ะดะฐะฝะฝัะต
- ะกะฟะพัะฝัะผะธ ะฐััะธัะตะบัััะฝัะผะธ ัะตัะตะฝะธัะผะธ

**ะคะพัะผะฐั ะทะฐะฟัะพัะฐ HITL:**
```
๐ HITL CHECKPOINT
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะปะฐะฝะธััะตะผะพะต ะดะตะนััะฒะธะต: [ะพะฟะธัะฐะฝะธะต]
ะัะธัะธะฝะฐ: [ะฟะพัะตะผั ััะพ ะฝัะถะฝะพ]
ะะธัะบะธ: [ััะพ ะผะพะถะตั ะฟะพะนัะธ ะฝะต ัะฐะบ]
ะะปััะตัะฝะฐัะธะฒั: [ะดััะณะธะต ะฒะฐัะธะฐะฝัั]
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะัะพะดะพะปะถะธัั? (ะดะฐ/ะฝะตั/ะพะฑััะดะธัั)
```

### TDD โ Test-Driven Development
**ะะพััะดะพะบ ัะฐะฑะพัั ะดะปั ะบะฐะถะดะพะณะพ ะธะทะผะตะฝะตะฝะธั:**
1. ะกะฝะฐัะฐะปะฐ ะฝะฐะฟะธัะธ/ะพะฑะฝะพะฒะธ ัะตััั
2. ะฃะฑะตะดะธัั ััะพ ัะตััั ะฟะฐะดะฐัั (red)
3. ะะตะฐะปะธะทัะน ะธะทะผะตะฝะตะฝะธะต
4. ะฃะฑะตะดะธัั ััะพ ัะตััั ะฟัะพัะพะดัั (green)
5. ะะตัะฐะบัะพัั ะตัะปะธ ะฝัะถะฝะพ (refactor)

### ะัะพะฒะตัะบะฐ ะฟะพัะปะต ะบะฐะถะดะพะณะพ ะธะทะผะตะฝะตะฝะธั
```bash
# ะะฑัะทะฐัะตะปัะฝัะน ัะตะบะปะธัั ะฟะพัะปะต ะบะฐะถะดะพะณะพ ัะฐะนะปะฐ:
python -m py_compile <ัะฐะนะป>           # ะกะธะฝัะฐะบัะธั
pytest tests/ -v --tb=short           # ะขะตััั
grep -rn "ErExtact\|ErNormalaze" .    # ะัะพะฒะตัะบะฐ ะพะฟะตัะฐัะพะบ (ะดะพะปะถะฝะพ ะฑััั ะฟัััะพ)
```

## ๐ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
docprep/
โโโ core/                    # ะฏะดัะพ ัะธััะตะผั โ ะะะะะะฏะขะฌ ะะกะขะะะะะะ
โ   โโโ config.py           # โ๏ธ ะะพะฝัะธะณััะฐัะธั ะฟััะตะน โ ะบัะธัะธัะฝัะน ัะฐะนะป
โ   โโโ state_machine.py    # โ๏ธ State Machine โ ะบัะธัะธัะฝัะน ัะฐะนะป  
โ   โโโ manifest.py         # ะะฐะฝะธัะตัั v2
โ   โโโ audit.py            # Audit logging
โ   โโโ error_policy.py     # ะะพะปะธัะธะบะธ ะพัะธะฑะพะบ
โ   โโโ exceptions.py       # ะัะบะปััะตะฝะธั
โ
โโโ engine/                  # ะะฒะธะถะบะธ ะพะฑัะฐะฑะพัะบะธ
โ   โโโ classifier.py       # ะะปะฐััะธัะธะบะฐัะพั
โ   โโโ converter.py        # ะะพะฝะฒะตััะตั (LibreOffice)
โ   โโโ extractor.py        # ะะฐัะฟะฐะบะพะฒัะธะบ ะฐััะธะฒะพะฒ
โ   โโโ merger.py           # ะะฑัะตะดะธะฝะธัะตะปั
โ   โโโ normalizers/        # ะะพัะผะฐะปะธะทะฐัะพัั
โ
โโโ cli/                     # CLI ะธะฝัะตััะตะนั
โ   โโโ main.py             # ะขะพัะบะฐ ะฒัะพะดะฐ
โ   โโโ stage.py            # ะญัะฐะฟั
โ   โโโ substage.py         # ะะพะดััะฐะฟั
โ   โโโ utils.py            # ะฃัะธะปะธัั CLI
โ
โโโ tests/                   # ะขะตััั
```

## ๐ง ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ััะตะบ
- Python 3.11+
- Typer (CLI framework)
- Pydantic (ะฒะฐะปะธะดะฐัะธั)
- pytest (ัะตััะธัะพะฒะฐะฝะธะต)
- LibreOffice (ะบะพะฝะฒะตััะฐัะธั) โ **ะะะฏะะะขะะะฌะะะฏ ะทะฐะฒะธัะธะผะพััั, ะะ ะดะพะฑะฐะฒะปััั fallback**

## ๐ ะะปะฐะฝ ัะตัะฐะบัะพัะธะฝะณะฐ (ะบัะฐัะบะพะต ัะตะทัะผะต)

**ะคะะะ 1 (๐ด ะัะธัะธัะตัะบะฐั):** ะัะฟัะฐะฒะปะตะฝะธะต ะพะฟะตัะฐัะพะบ
- `ErExtact` โ `ErExtract`
- `ErNormalaze` โ `ErNormalize`

**ะคะะะ 2 (๐ ะััะธัะตะบัััะฐ):**
- ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต
- ะฃะปัััะตะฝะธะต State Machine (StateTransition dataclass)
- ะัะฝะพั magic numbers ะฒ ะบะพะฝััะฐะฝัั
- ะฃะฝะธัะธะบะฐัะธั ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ

**ะคะะะ 3 (๐ก ะัะธััะบะฐ):**
- ะฃะดะฐะปะตะฝะธะต ะดัะฑะปะธััััะตะณะพ ะบะพะดะฐ ะฒ CLI
- ะฃะดะฐะปะตะฝะธะต ะผััะพัะฝัั ัะฐะนะปะพะฒ
- ะกะพะทะดะฐะฝะธะต .gitignore

**ะคะะะ 4 (๐ข ะขะตััั):**
- ะขะตััั ะดะปั State Machine
- ะขะตััั ะดะปั Merger

## ๐ซ ะงัะพ ะะ ะดะตะปะฐัั
- ะะ ะดะพะฑะฐะฒะปััั fallback ะดะปั LibreOffice โ ััะพ ะพะฑัะทะฐัะตะปัะฝะฐั ะทะฐะฒะธัะธะผะพััั
- ะะ ััะพะณะฐัั Web UI (webui_docprep/) โ ััะพ ะพัะดะตะปัะฝะฐั ะธัะตัะฐัะธั
- ะะ ะธะทะผะตะฝััั ัะพัะผะฐั manifest.json ะฑะตะท ัะพััะฐะฝะตะฝะธั ะพะฑัะฐัะฝะพะน ัะพะฒะผะตััะธะผะพััะธ
- ะะ ัะดะฐะปััั ัะฐะนะปั ะฑะตะท ัะฒะฝะพะณะพ ะฟะพะดัะฒะตัะถะดะตะฝะธั HITL
- ะะ ะผะตะฝััั ะฟัะฑะปะธัะฝัะต API ะฑะตะท ะดะพะบัะผะตะฝัะธัะพะฒะฐะฝะธั

## ๐ ะะพะผะฐะฝะดั ะดะปั ะฟัะพะฒะตัะบะธ

```bash
# ะะพะปะฝะฐั ะฟัะพะฒะตัะบะฐ
pytest tests/ -v

# ะัะพะฒะตัะบะฐ ะบะพะฝะบัะตัะฝะพะณะพ ะผะพะดัะปั
pytest tests/test_state_machine.py -v

# ะัะพะฒะตัะบะฐ ะฟะพะบัััะธั
pytest --cov=docprep --cov-report=term-missing tests/

# ะะธะฝัะธะฝะณ
ruff check docprep/

# ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต
black docprep/ --check
isort docprep/ --check

# ะะพะธัะบ ะพะฟะตัะฐัะพะบ
grep -rn "ErExtact\|ErNormalaze" docprep/
```

## ๐ ะะพะฝะฒะตะฝัะธะธ ะบะพะดะฐ
- Type hints ะฒะตะทะดะต
- Docstrings ะฒ Google-style
- ะะฐะบัะธะผะฐะปัะฝะฐั ะดะปะธะฝะฐ ัััะพะบะธ: 100 ัะธะผะฒะพะปะพะฒ
- ะะผะตะฝะพะฒะฐะฝะธะต: snake_case ะดะปั ััะฝะบัะธะน/ะฟะตัะตะผะตะฝะฝัั, PascalCase ะดะปั ะบะปะฐััะพะฒ

## ๐ Workflow ัะตัะฐะบัะพัะธะฝะณะฐ

```
[ะะฝะฐะปะธะท] โ [ะขะตััั] โ [ะะทะผะตะฝะตะฝะธะต] โ [ะัะพะฒะตัะบะฐ] โ [ะะพะผะผะธั]
    โ                                    |
    โโโโโโโโโโโ ะัะปะธ ัะตััั ะฟะฐะดะฐัั โโโโโโโโ
```

ะัะธ ะปัะฑัั ัะพะผะฝะตะฝะธัั โ ัะฟัะฐัะธะฒะฐะน ัะตัะตะท HITL!
