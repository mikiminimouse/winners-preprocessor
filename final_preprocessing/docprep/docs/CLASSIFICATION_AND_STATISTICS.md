# Классификация и Статистика

## Система классификации

### Классификатор (Classifier)

Классификатор определяет категорию обработки для каждого UNIT на основе анализа файлов.

#### Категории обработки

1. **direct** (Прямые файлы)
   - Готовы к обработке без преобразований
   - Форматы: PDF, DOCX, XLSX, PPTX, RTF
   - Направление: Merge_0/Direct/

2. **convert** (Требуют конвертации)
   - Старые форматы Office
   - DOC → DOCX, XLS → XLSX, PPT → PPTX, RTF → DOCX
   - Направление: Processing_N/Convert/

3. **extract** (Архивы)
   - ZIP, RAR, 7Z архивы
   - Направление: Processing_N/Extract/

4. **normalize** (Требуют нормализации)
   - Неправильные расширения
   - Неправильные имена файлов
   - Направление: Processing_N/Normalize/

5. **special** (Специальные файлы)
   - Подписи (.sig, .p7s)
   - Неподдерживаемые форматы
   - Направление: Exceptions/Exceptions_N/Special/

6. **mixed** (Смешанные типы)
   - UNIT с файлами разных категорий
   - Направление: Exceptions/Exceptions_N/Mixed/

7. **unknown** (Неопределенные)
   - Пустые UNIT (без файлов)
   - Неопределенные форматы
   - Направление: Exceptions/Exceptions_N/Ambiguous/

#### Логика классификации

1. **Проверка на пустые UNIT**
   - Если UNIT пустой → `unknown` → Ambiguous

2. **Классификация каждого файла**
   - Использует Decision Engine
   - Определяет тип файла (MIME, signature, extension)
   - Определяет категорию обработки

3. **Определение категории UNIT**
   - Если все файлы одной категории → эта категория
   - Если разные категории → `mixed`
   - Если разные типы (даже при одной категории) → `mixed`

4. **Определение расширения для сортировки**
   - Для `extract`: исходное расширение архива (zip, rar, 7z)
   - Для `convert`: исходное расширение (doc, xls, ppt)
   - Для `normalize`: исходное расширение (если корректное)
   - Для `direct`: расширение файла

5. **Перемещение UNIT**
   - Создание manifest (если отсутствует)
   - Перемещение в целевую директорию
   - Обновление state machine

### Decision Engine

Decision Engine разрешает конфликты между тремя источниками правды:
- MIME Type (python-magic)
- File Signature (magic bytes)
- File Extension

#### Сценарии разрешения

| Сценарий | MIME | Signature | Extension | Результат |
|----------|------|-----------|-----------|-----------|
| 2.1 | ✓ | ✓ | ✓ | `direct` |
| 2.2 | ✓ | ✓ | ✗ | `normalize` |
| 2.3 | ✓ | ✗ | ✓ | `normalize` |
| 2.4 | ✗ | ✓ | ✓ | `ambiguous` |
| 2.5 | ✗ | ✗ | ✗ | `ambiguous` |
| 2.6 | octet-stream | ? | ? | `ambiguous` |
| 2.7 | ? | отсутствует | ? | `ambiguous` |

## Система статистики

### Сбор статистики

Система собирает статистику на нескольких уровнях:

#### 1. Входные данные (Input)

- Общее количество UNIT
- Количество пустых UNIT
- Количество UNIT с файлами
- Распределение по расширениям файлов
- Количество UNIT по расширениям

#### 2. Выходные данные (Output)

- Общее количество классифицированных UNIT
- Распределение по категориям
- Распределение по локациям
- Распределение по route
- Расширения файлов на входе и выходе

#### 3. Процентные метрики

- Процент файлов по расширениям
- Процент UNIT по расширениям
- Процент по категориям (с учетом и без пустых UNIT)
- Процент PDF по route (scan/text)
- Процент по циклам обработки

### CLI команды статистики

#### Показать статистику

```bash
# Базовая статистика
docprep stats show 2025-12-20

# Детальная статистика
docprep stats show 2025-12-20 --detailed

# Сохранить в файл
docprep stats show 2025-12-20 --output report.txt
```

#### Сравнить циклы

```bash
# Сравнить циклы 1 и 2
docprep stats compare 2025-12-20 --cycle1 1 --cycle2 2
```

#### Экспорт статистики

```bash
# Экспорт в Markdown
docprep stats export 2025-12-20 --format markdown --output report.md

# Экспорт в JSON
docprep stats export 2025-12-20 --format json --output report.json
```

### Формат отчета

#### Общая статистика

```
ОБЩАЯ СТАТИСТИКА
--------------------------------------------------------------------------------
Всего UNIT: 2585
Пустых UNIT: 780 (30%)
UNIT с файлами: 1805 (69%)
Классифицировано: 2585
```

#### Распределение по категориям

```
РАСПРЕДЕЛЕНИЕ ПО КАТЕГОРИЯМ (БЕЗ ПУСТЫХ UNIT)
--------------------------------------------------------------------------------
direct           1378 UNIT ( 76.3%)
extract           144 UNIT (  7.9%)
convert           133 UNIT (  7.3%)
mixed             128 UNIT (  7.0%)
normalize          22 UNIT (  1.2%)
unknown             0 UNIT (  0.0%)
```

#### Статистика по расширениям

```
СТАТИСТИКА ПО РАСШИРЕНИЯМ (БЕЗ ПУСТЫХ UNIT)
--------------------------------------------------------------------------------
Расширение      Файлов     UNIT       % файлов   % UNIT
--------------------------------------------------------------------------------
.pdf            1153       1144       62.5%      63.4%
.docx            435        429        23.6%      23.8%
.doc             172        172         9.3%       9.5%
.zip              94         94         5.1%       5.2%
.rar              36         36         1.9%       2.0%
...
```

#### Распределение PDF по route

```
РАСПРЕДЕЛЕНИЕ PDF ПО ROUTE
--------------------------------------------------------------------------------
Всего PDF: 1153
  pdf_scan               631 ( 54.7%)
  pdf_text               392 ( 34.0%)
  mixed                  921 ( 79.8%)
```

### Анализ Unknown UNIT

Система автоматически анализирует причины попадания UNIT в категорию `unknown`:

- **Пустые UNIT**: UNIT без файлов (не могут быть классифицированы)
- **Неопределенные форматы**: Файлы, которые не удалось определить

#### Пример анализа

```
ДЕТАЛЬНЫЙ АНАЛИЗ UNKNOWN UNIT
--------------------------------------------------------------------------------
Всего unknown UNIT: 780
  - Пустых: 780 (100%)
  - С файлами: 0 (0%)
- Процент от общего числа UNIT: 30%
- Процент от UNIT с файлами: 0%

Вывод:
Основная причина большого количества unknown UNIT: 780 из 780 (100%) - это 
пустые UNIT, которые не могут быть классифицированы, так как не содержат файлов.

Если исключить пустые UNIT, то unknown UNIT с файлами составляют только 
0 из 1805 (0%) от всех UNIT с файлами.
```

## Метрики производительности

### Время обработки

- Классификация: ~100-200 UNIT/сек
- Конвертация: ~1-5 UNIT/сек (зависит от размера)
- Извлечение: ~10-50 UNIT/сек (зависит от размера архива)
- Нормализация: ~50-100 UNIT/сек

### Точность классификации

- **Direct файлы**: ~99% точность
- **Convert файлы**: ~98% точность
- **Extract файлы**: ~100% точность
- **Normalize файлы**: ~95% точность
- **Unknown файлы**: 100% (только пустые UNIT)

## Рекомендации по анализу

1. **Всегда исключайте пустые UNIT** при анализе точности классификации
2. **Используйте процентные метрики** для сравнения разных дат
3. **Анализируйте route для PDF** для понимания распределения scan/text
4. **Сравнивайте циклы** для оценки эффективности обработки
5. **Экспортируйте статистику** для долгосрочного анализа

