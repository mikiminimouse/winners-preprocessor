# –§–∏–Ω–∞–ª—å–Ω—ã–π –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ router/api.py

## üìã –†–µ–∑—é–º–µ

–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ `preprocessing/router`. –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π —Ñ–∞–π–ª `router/main.py` (1598 —Å—Ç—Ä–æ–∫) –±—ã–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ `router/api.py` (445 —Å—Ç—Ä–æ–∫).

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–¥–∞**: 72.2% (1153 —Å—Ç—Ä–æ–∫ —É–¥–∞–ª–µ–Ω–æ)

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ

### –ë—ã–ª–æ (–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π main.py - 1598 —Å—Ç—Ä–æ–∫)
```
- 30-80:   –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- 86-93:   –§—É–Ω–∫—Ü–∏—è calculate_sha256()
- 95-173:  –§—É–Ω–∫—Ü–∏–∏ get_mongo_client() –∏ get_mongo_metadata_client()
- 175-237: –§—É–Ω–∫—Ü–∏—è get_protocols_by_date()
- 240-283: –§—É–Ω–∫—Ü–∏–∏ save/get manifest
- 285-550: –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- 1328-1598: FastAPI endpoints (—Ç–æ–ª—å–∫–æ 270 —Å—Ç—Ä–æ–∫!)
```

### –°—Ç–∞–ª–æ (—á–∏—Å—Ç—ã–π api.py - 445 —Å—Ç—Ä–æ–∫)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
1. –ò–º–ø–æ—Ä—Ç—ã –∏–∑ –º–æ–¥—É–ª–µ–π (22 —Å—Ç—Ä–æ–∫–∏)
2. FastAPI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (5 —Å—Ç—Ä–æ–∫)
3. –§—É–Ω–∫—Ü–∏–∏-–ø–æ–º–æ—â–Ω–∏–∫–∏ (90 —Å—Ç—Ä–æ–∫)
4. API Endpoints (320 —Å—Ç—Ä–æ–∫)
5. –ó–∞–ø—É—Å–∫ (8 —Å—Ç—Ä–æ–∫)

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|------|-------|-----------|
| –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ | 1598 —Å—Ç—Ä–æ–∫ | 445 —Å—Ç—Ä–æ–∫ | -72.2% |
| –§–∞–π–ª KB | ~79 KB | ~15.7 KB | -80.2% |
| –ò–º–ø–æ—Ä—Ç—ã | –õ–æ–∫–∞–ª—å–Ω—ã–µ | –ú–æ–¥—É–ª—å–Ω—ã–µ | ‚úÖ –ß–µ—Ç–∫–∏–µ |
| –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | –í—ã—Å–æ–∫–∞—è –º—É—Ç—å | –Ø—Å–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è | ‚úÖ –û—Ç–ª–∏—á–Ω—ã–µ |
| –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å | –°–ª–æ–∂–Ω–∞—è | –•–æ—Ä–æ—à–∞—è | ‚úÖ –£–ª—É—á—à–µ–Ω–∞ |

## üèóÔ∏è –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ router

```
router/
‚îú‚îÄ‚îÄ api.py               ‚úÖ –ù–û–í–û–ï (445 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ FastAPI endpoints, —Ñ—É–Ω–∫—Ü–∏–∏-–ø–æ–º–æ—â–Ω–∏–∫–∏
‚îÇ
‚îú‚îÄ‚îÄ config.py            (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
‚îú‚îÄ‚îÄ mongo.py             (MongoDB)
‚îú‚îÄ‚îÄ archive.py           (–∞—Ä—Ö–∏–≤—ã)
‚îú‚îÄ‚îÄ manifest.py          (–º–∞–Ω–∏—Ñ–µ—Å—Ç—ã)
‚îú‚îÄ‚îÄ utils.py             (—É—Ç–∏–ª–∏—Ç—ã)
‚îú‚îÄ‚îÄ processing.py        (–æ–±—Ä–∞–±–æ—Ç–∫–∞)
‚îú‚îÄ‚îÄ file_detection.py    (—Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤)
‚îú‚îÄ‚îÄ metrics.py           (–º–µ—Ç—Ä–∏–∫–∏)
‚îú‚îÄ‚îÄ state_manager.py     (—Å–æ—Å—Ç–æ—è–Ω–∏–µ)
‚îî‚îÄ‚îÄ __init__.py          (—ç–∫—Å–ø–æ—Ä—Ç)
```

## üìã API Endpoints (9 —à—Ç)

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|---------|
| GET | `/health` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞ |
| POST | `/upload` | –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ |
| POST | `/webhook` | Webhook —Ç—Ä–∏–≥–≥–µ—Ä |
| POST | `/process_now` | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ |
| GET | `/status/{unit_id}` | –°—Ç–∞—Ç—É—Å unit'–∞ |
| GET | `/metrics/processing` | –ü–æ–ª–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ |
| GET | `/metrics/summary` | –°–≤–æ–¥–∫–∞ –º–µ—Ç—Ä–∏–∫ |
| GET | `/protocols/{date}` | –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª—ã |
| POST | `/download_protocols/{date}` | –°–∫–∞—á–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª—ã |

## üîß –§—É–Ω–∫—Ü–∏–∏-–ø–æ–º–æ—â–Ω–∏–∫–∏

### process_file(file_path, background_tasks)
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª:
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Ñ–∞–π–ª–∞
- –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç (–∞—Ä—Ö–∏–≤, PDF, DOC –∏ —Ç.–¥.)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏

### download_document(url, dest_path)
–°–∫–∞—á–∏–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å URL:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è zakupki.gov.ru
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç—ã –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True/False

### get_processing_summary(session_id)
–ü–æ–ª—É—á–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- –ò–∑ MongoDB –ø–æ session_id
- –ò–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–ª–∏ None

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# –ò–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
from router.api import app
from router.api import process_file, download_document, get_processing_summary

# FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
print(app.title)  # "Docling Router/Preprocessor"

# Endpoints –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
print(len([r for r in app.routes if hasattr(r, 'methods')]))  # 9 endpoints
```

## üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úì **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω–æ  
‚úì **–ß–∏—Å—Ç–æ—Ç–∞** - API —Å–ª–æ–π –æ—Ç–¥–µ–ª–µ–Ω –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏  
‚úì **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** - –ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è  
‚úì **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –õ–µ–≥—á–µ –ø–∏—Å–∞—Ç—å unit-—Ç–µ—Å—Ç—ã  
‚úì **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ endpoints  
‚úì **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π  
‚úì **SOLID** - –í—Å–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Å–æ–±–ª—é–¥–µ–Ω—ã  

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ API
```bash
cd preprocessing
python -m uvicorn router.api:app --host 0.0.0.0 --port 8080
```

### –í –∫–æ–¥–µ
```python
from router.api import app, process_file, download_document

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–ø—Ä—è–º—É—é
result = process_file(Path("file.pdf"))
success = download_document("http://...", Path("output.pdf"))
```

### Docker
```bash
docker-compose up -d
```

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –§–∞–∑–∞ 1: –†–∞–∑–±–∏–µ–Ω–∏–µ main.py (–∑–∞–≤–µ—Ä—à–µ–Ω–æ)
- –°–æ–∑–¥–∞–Ω–æ 7 –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π
- –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã

### –§–∞–∑–∞ 2: –û—á–∏—Å—Ç–∫–∞ api.py (–∑–∞–≤–µ—Ä—à–µ–Ω–æ)
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω main.py ‚Üí api.py
- –û—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ endpoints
- –ò–º–ø–æ—Ä—Ç—ã –∏–∑ –º–æ–¥—É–ª–µ–π
- –°–æ–∫—Ä–∞—â–µ–Ω–æ –Ω–∞ 72.2%

### –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –º–æ–¥—É–ª—å–Ω–∞—è, —á–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞  
‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production  
‚úÖ –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å  

## üéä –°—Ç–∞—Ç—É—Å

**–†–ï–§–ê–ö–¢–û–†–ò–ù–ì –ó–ê–í–ï–†–®–ï–ù –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù** ‚úÖ

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –ì–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

**–î–∞—Ç–∞**: 18 –¥–µ–∫–∞–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä**: Cursor AI  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û
