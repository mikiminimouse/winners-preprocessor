# Тестирование Qwen3-VL-8B для распознавания разметки документов

## Статус

✅ **Скрипт создан и готов к использованию**  
⚠️ **Проблема с авторизацией API (401 Unauthorized)**

## Созданный скрипт

**Файл:** `test_qwen3_vision_ocr.py`

### Функциональность:

1. ✅ Подключение к Qwen3-VL-8B через API key
2. ✅ Отправка изображений в формате base64
3. ✅ Распознавание разметки документа (аналогично Docling OCR)
4. ✅ Извлечение структуры: текст, таблицы, layout, metadata
5. ✅ Сохранение результатов в формате Docling

### Формат результатов (Docling):

```json
{
  "file": "filename.jpg",
  "route": "image_ocr",
  "detected_type": "image",
  "needs_ocr": true,
  "status": "processed",
  "processing_method": "qwen3-vl-8b-instruct",
  "text": "извлеченный текст",
  "tables": [...],
  "layout": {
    "pages": [...],
    "sections": [...],
    "blocks": [...]
  },
  "metadata": {...},
  "metrics": {...}
}
```

## Проблема с авторизацией

При попытке подключения возникает ошибка:

```
EvolutionAuthError: Неверные учетные данные: 401 Client Error: Unauthorized
```

### Возможные причины:

1. **API key неправильный или истек** - проверьте в Cloud.ru
2. **API key не имеет доступа к ML Inference endpoint** - нужны права доступа
3. **Неправильный формат ключа** - текущий формат: `key_id.secret`

### Проверьте:

- ✅ API key активен в Cloud.ru
- ✅ API key имеет права доступа к ML Inference
- ✅ Endpoint доступен: `https://92ad3238-81c6-4396-a02a-fb9cef99bce3.modelrun.inference.cloud.ru/v1`
- ✅ Inference instance запущен

## Использование

### После исправления авторизации:

```bash
python3 test_qwen3_vision_ocr.py
```

Скрипт:
1. Найдет изображения в `normalized/UNIT_*/files/`
2. Обработает первое найденное изображение
3. Извлечет разметку документа через Qwen3-VL-8B
4. Сохранит результаты в `output_qwen3_vision/`

## Промпт для распознавания

Скрипт использует промпт, который просит модель извлечь:

- **text** - полный текст с сохранением структуры
- **tables** - все таблицы с данными и координатами
- **layout** - структура документа (страницы, блоки, секции)
- **metadata** - метаданные (заголовок, автор, дата)

Формат результата полностью совместим с Docling OCR pipeline.

## Структура Docling OCR

Скрипт извлекает данные в формате, аналогичном Docling:

### Text Extraction
- Полный текст документа
- Сохранение структуры (заголовки, параграфы, списки)

### Table Extraction
- Массив таблиц
- Каждая таблица: rows (массив строк), bbox (координаты)

### Layout Analysis
- **pages** - информация о страницах
- **blocks** - текстовые блоки с типами и координатами
- **sections** - секции документа

### Metadata
- Заголовок, автор, дата, количество страниц

## Готовность

✅ Скрипт полностью готов  
✅ Формат результатов совместим с Docling  
✅ Обработка изображений реализована  
⏳ Требуется исправление авторизации API

После решения проблемы с авторизацией скрипт сразу заработает и начнет обрабатывать изображения для распознавания разметки документов.

