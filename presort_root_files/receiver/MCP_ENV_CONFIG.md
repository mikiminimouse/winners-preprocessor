# Конфигурация переменных окружения для MCP HTTP Server

## Обзор

Для корректной работы `mcp_http_server.py` и получения протоколов закупок по дате необходимо настроить следующие переменные окружения в файле `.env`.

## Переменные окружения для получения протоколов (get_protocols_by_date_223)

### 1. mongoServer
**Описание:** Адреса хостов MongoDB (шардированный кластер)  
**Тип:** Строка  
**Формат:** `host1:port1,host2:port2,host3:port3` или `host:port`  
**Пример:** `mongo1.example.com:27017,mongo2.example.com:27017,mongo3.example.com:27017`  
**Обязательно:** Да  
**Использование:** Формирование строки подключения к MongoDB кластеру

```bash
mongoServer=mongo1.example.com:27017,mongo2.example.com:27017,mongo3.example.com:27017
```

### 2. readAllUser
**Описание:** Имя пользователя для чтения данных из MongoDB  
**Тип:** Строка  
**Пример:** `readonly_user`  
**Обязательно:** Да  
**Использование:** Аутентификация при подключении к MongoDB (authSource=admin)

```bash
readAllUser=readonly_user
```

### 3. readAllPassword
**Описание:** Пароль для пользователя MongoDB с правами чтения  
**Тип:** Строка (секрет)  
**Пример:** `SecurePassword123!`  
**Обязательно:** Да  
**Безопасность:** ⚠️ КРИТИЧЕСКИ ВАЖНО - хранить в .env, не коммитить в git  
**Использование:** Аутентификация при подключении к MongoDB

```bash
readAllPassword=SecurePassword123!
```

### 4. sslCertPath
**Описание:** Путь к SSL сертификату для TLS подключения к MongoDB  
**Тип:** Строка (путь к файлу)  
**Пример:** `/etc/ssl/certs/mongodb-ca.pem` или `./certs/mongodb-ca.pem`  
**Обязательно:** Да  
**Использование:** Валидация SSL сертификата при TLS подключении (tlsCAFile)

```bash
sslCertPath=/etc/ssl/certs/mongodb-ca.pem
```

**Важно:** 
- Файл должен существовать и быть доступен для чтения
- Если используете Docker, сертификат должен быть смонтирован в контейнер
- Путь может быть абсолютным или относительным от рабочей директории

### 5. protocolsCountLimit
**Описание:** Максимальное количество протоколов, возвращаемых за один запрос  
**Тип:** Целое число  
**По умолчанию:** `100`  
**Обязательно:** Нет (если не указано, используется 100)  
**Использование:** Ограничение результатов запроса `.limit()` в MongoDB

```bash
protocolsCountLimit=100
```

**Рекомендации:**
- Для тестирования: `100`
- Для продакшена: `500-1000` (зависит от размера документов)
- Учитывайте время обработки и память при увеличении лимита

## Переменные окружения для других инструментов

### 6. MULTITENDER_API_KEY
**Описание:** API ключ для доступа к multitender.ru API  
**Тип:** Строка (секрет)  
**Обязательно:** Нет (только если используется инструмент `demo44_purchase`)  
**Использование:** Аутентификация при запросах к внешнему API

```bash
MULTITENDER_API_KEY=your-api-key-here
```

## Структура данных, возвращаемых get_protocols_by_date_223

После получения протоколов по дате, функция возвращает структуру:

```json
{
  "purchaseNoticeNumber1": {
    "url": "https://example.com/document1.pdf",
    "fileName": "document1.pdf"
  },
  "purchaseNoticeNumber2": [
    {
      "url": "https://example.com/document2.pdf",
      "fileName": "document2.pdf"
    },
    {
      "url": "https://example.com/document3.pdf",
      "fileName": "document3.pdf"
    }
  ]
}
```

**Формат:**
- Ключ: `purchaseNoticeNumber` (номер закупки)
- Значение: 
  - Если один документ: объект с `url` и `fileName`
  - Если несколько документов: массив объектов с `url` и `fileName`

## Пример полного .env файла

```bash
# ============================================
# MongoDB подключение для протоколов закупок
# ============================================
mongoServer=mongo1.example.com:27017,mongo2.example.com:27017,mongo3.example.com:27017
readAllUser=readonly_user
readAllPassword=SecurePassword123!
sslCertPath=/etc/ssl/certs/mongodb-ca.pem
protocolsCountLimit=100

# ============================================
# Внешние API (опционально)
# ============================================
MULTITENDER_API_KEY=your-api-key-here

# ============================================
# Другие настройки проекта
# ============================================
WEBHOOK_SECRET=change-me-secret
SCHEDULE_CRON=*/15 * * * *
POSTGRES_PASSWORD=change-me-password
MAX_UNPACK_SIZE_MB=500
MAX_FILES_IN_ARCHIVE=1000
```

## Проверка конфигурации

### Шаги для проверки:

1. **Проверка наличия всех обязательных переменных:**
```python
# Код проверяет наличие всех переменных:
if not all([mongo_hosts, username, password, ssl_cert_path]):
    raise HTTPException(status_code=500, detail="Не все необходимые параметры найдены в .env файле")
```

2. **Проверка подключения к MongoDB:**
```python
# Сервер автоматически проверяет подключение:
client.admin.command('ping')
```

3. **Тестовый запрос:**
```bash
curl -X POST "http://localhost:8000/tools/call" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "get_protocols_by_date_223",
    "arguments": {
      "date": "2025-01-17"
    }
  }'
```

## Безопасность

### ⚠️ Критически важно:

1. **Никогда не коммитьте .env файл в git**
   - Убедитесь, что `.env` в `.gitignore`
   - Используйте `.env.example` для шаблона

2. **Права доступа к .env файлу:**
```bash
chmod 600 .env  # Только владелец может читать/писать
```

3. **SSL сертификат:**
   - Храните сертификат в безопасном месте
   - Используйте абсолютные пути в продакшене
   - Проверьте права доступа к файлу сертификата

4. **Пароли:**
   - Используйте сложные пароли
   - Регулярно ротируйте пароли
   - Рассмотрите использование секретов (Docker secrets, Kubernetes secrets)

## Интеграция с пайплайном обработки документов

После получения протоколов через MCP сервер, данные используются для:

1. **Извлечение URL документов** из ответа
2. **Скачивание документов** по URL
3. **Обработка документов** через Docling пайплайн:
   - Загрузка в `input/` директорию
   - Обработка через router
   - OCR и извлечение текста
   - Сохранение результатов в `output/`

### Пример потока данных:

```
MCP Server → get_protocols_by_date_223("2025-01-17")
    ↓
Получение JSON с URL документов
    ↓
Извлечение URL: ["https://example.com/doc1.pdf", ...]
    ↓
Скачивание документов → input/
    ↓
Router → Классификация и предобработка
    ↓
Docling → OCR и извлечение текста
    ↓
Output → Обработанные документы
```

## Troubleshooting

### Ошибка: "Не все необходимые параметры найдены в .env файле"
**Причина:** Отсутствует одна или несколько обязательных переменных  
**Решение:** Проверьте наличие всех переменных: `mongoServer`, `readAllUser`, `readAllPassword`, `sslCertPath`

### Ошибка: "MongoDB error: ..."
**Причина:** Проблемы с подключением к MongoDB  
**Решение:** 
- Проверьте доступность хостов MongoDB
- Проверьте правильность учетных данных
- Проверьте путь к SSL сертификату
- Проверьте сетевые настройки (firewall, security groups)

### Ошибка: "Connection error: ..."
**Причина:** Общая ошибка подключения  
**Решение:**
- Проверьте формат `mongoServer` (host:port)
- Проверьте, что SSL сертификат существует и доступен
- Проверьте логи MongoDB для деталей

### Ошибка: "Неверный формат даты"
**Причина:** Неправильный формат даты в запросе  
**Решение:** Используйте формат `YYYY-MM-DD` (например, `2025-01-17`)

