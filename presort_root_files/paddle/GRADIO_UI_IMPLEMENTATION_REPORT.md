# Реализация Gradio Web UI для PaddleOCR-VL сервиса

## Обзор

Реализован веб-интерфейс на Gradio для PaddleOCR-VL сервиса, аналогичный официальному демо на HuggingFace:
https://huggingface.co/spaces/PaddlePaddle/PaddleOCR-VL_Online_Demo

## Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                    Docker Container                         │
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐  │
│  │   FastAPI   │    │   Gradio    │    │  PaddleOCR-VL   │  │
│  │   Port:     │    │   Port:     │    │   (Shared)      │  │
│  │   8081      │    │   7860      │    │  Models         │  │
│  │             │    │             │    │                 │  │
│  │ - OCR API   │    │ - Web UI    │    │ - Layout        │  │
│  │ - File mgmt │    │ - Demo      │    │   Detection     │  │
│  │ - S3 upload │    │ - Settings  │    │ - OCR           │  │
│  └─────────────┘    └─────────────┘    │   Recognition   │  │
│                    └─────────────────┘  │                 │  │
│                                         └─────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## Реализованные компоненты

### 1. Gradio приложение (`gradio_app.py`)
- Интерфейс загрузки изображений (PNG, JPG, JPEG)
- Панель настроек формата вывода (Markdown, JSON, оба)
- Дополнительные опции обработки: Enable chart parsing, Enable document unwarping, Enable orientation classification
- Интеграция с PaddleOCR-VL функциями
- Отображение результатов в пяти вкладках: Markdown, JSON, Markdown Preview, Visualization, Markdown Source
- **Визуализация layout-элементов** с цветовой дифференциацией и порядком чтения
- Корпоративное брендирование без ссылки на оригинал HuggingFace

### 2. Корпоративное брендирование (`assets/company.css`)
- Стилизация интерфейса под корпоративный стиль
- Цветовая схема с синими оттенками
- Адаптивный дизайн элементов

### 3. Dockerfile
- Установка Gradio и зависимостей
- Копирование файлов UI
- Открытие портов 8081 и 7860
- Совместимость с офлайн-образом PaddleOCR-VL

### 4. Скрипты запуска
- `start.sh` - основной скрипт запуска с поддержкой GPU
- `start_local.sh` - скрипт для локального тестирования без GPU
- `start_dual.sh` - скрипт для одновременной работы обоих сервисов
- Поддержка автоматического определения режима работы по переменной `PORT`

### 5. Health Check Script
- `health_check.sh` - скрипт для проверки здоровья сервиса
- Поддержка различных утилит для проверки портов
- Работает даже при отсутствии сетевых утилит

## Функциональность

### Загрузка документов
- Поддержка форматов: PNG, JPG, JPEG
- Drag & drop интерфейс
- Валидация типов файлов

### Обработка через PaddleOCR-VL
- Использование официального API: `process_with_paddleocr()`
- Сохранение результатов: `save_results_locally()`
- Поддержка русского и английского языков
- Распознавание сложных структур (таблицы, заголовки)

### Форматы вывода
- **Markdown**: Структурированный текст с сохранением иерархии
- **JSON**: Полные данные в формате JSON
- **Оба**: Одновременный вывод в обоих форматах

### Брендирование
- Заголовок с названием компании
- Корпоративная цветовая схема
- Стилизованные элементы интерфейса
- Футер с контактной информацией

## Технические детали

### Интеграция
- Прямой вызов функций из `server.py`
- Совместное использование моделей PaddleOCR-VL
- Минимальная задержка обработки

### Безопасность
- Валидация загружаемых файлов
- Ограничение размера изображений
- Логирование действий пользователей

### Производительность
- Кэширование результатов
- Асинхронная обработка
- Индикаторы прогресса

## Health Check

### Health Check Script (`health_check.sh`)
- Проверяет активность процесса Gradio
- Проверяет доступность порта 7860 различными способами
- Возвращает код 0 при успехе, ненулевой код при ошибке
- Работает в ограниченных условиях без сетевых утилит

### Использование в Cloud.ru ML Inference
- **Путь до команды**: `/app/health_check.sh`
- **Тип пробы**: `exec`
- **Readiness и Liveness probes**: одинаковая конфигурация

## Режимы работы

### Dual Mode (по умолчанию)
- **Описание**: Одновременная работа FastAPI и Gradio UI
- **Порты**: 8081 (FastAPI) и 7860 (Gradio UI)
- **Преимущества**: Поддержка обоих интерфейсов в одном контейнере

### Server Mode
- **Описание**: Только FastAPI сервер
- **Порт**: 8081
- **Использование**: Когда нужен только API

### UI Mode
- **Описание**: Только Gradio Web UI
- **Порт**: 7860
- **Использование**: Когда нужен только веб-интерфейс

### Автоматический режим по PORT
- Если установлена переменная окружения `PORT=8081` - запускается Server Mode
- Если установлена переменная окружения `PORT=7860` - запускается UI Mode
- Если переменная PORT не установлена - запускается Dual Mode

## Порты и доступ

- **8081**: FastAPI REST API
- **7860**: Gradio Web UI

## Тестирование

Все компоненты протестированы:
- ✅ Импорт модулей
- ✅ Структура файлов
- ✅ Синтаксис приложения
- ✅ Dockerfile
- ✅ Скрипты запуска
- ✅ Health check скрипт
- ✅ Локальное тестирование без GPU
- ✅ Доступность Web UI (200 OK)
- ✅ Работа health check (код 0)
- ✅ Одновременная работа обоих сервисов

## Готовность к деплою

✅ Готово к сборке Docker образа и деплою на Cloud.ru ML Inference

## Следующие шаги

1. Деплой на ML Inference

2. **ВАЖНО**: Включить Serverless режим для порта 7860

3. Настроить health check probes в Cloud.ru ML Inference

4. Тестирование через веб-интерфейс и API

## Особенности реализации

- Сохранена совместимость с существующим FastAPI API
- Добавлено только веб-интерфейс без изменения логики OCR
- Поддержка офлайн-образа с предзагруженными моделями
- Корректная обработка сигналов завершения
- Поддержка автоматического определения режима работы по переменной `PORT`
- Упрощенная конфигурация запуска Gradio для надежной работы
- Надежный механизм health check для использования в Cloud.ru ML Inference
- Поддержка локального тестирования без GPU для слабых машин
- Поддержка трех режимов работы: Dual, Server, UI
- Поддержка одновременной работы обоих сервисов в Dual Mode
- Улучшенная логика определения режимов работы в новом скрипте `start_enhanced.sh`
- Расширенный интерфейс Web UI с дополнительными опциями обработки
- Пять вкладок для отображения результатов: Markdown, JSON, Markdown Preview, Visualization, Markdown Source
- **Визуализация layout-элементов** с цветовой дифференциацией и порядком чтения
- Удалена ссылка на оригинал HuggingFace для конфиденциальности