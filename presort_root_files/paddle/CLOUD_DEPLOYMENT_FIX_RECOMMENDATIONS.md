# Рекомендации по исправлению проблем развертывания в Cloud.ru ML Inference

## Анализ текущей ситуации

На основе анализа логов и кода скрипта запуска `start_enhanced.sh` выявлена причина проблем с доступностью сервисов:

1. **Переменная окружения PORT=7860** активирует режим `ui`, при котором запускается только Gradio Web UI
2. **Gradio настроен правильно** на прослушивание `0.0.0.0:7860`
3. **FastAPI не запущен** потому что режим `ui` не включает его запуск

## Конкретные рекомендации по исправлению

### Вариант 1: Запуск обоих сервисов (рекомендуется)

**Изменить переменную окружения в Cloud.ru ML Inference:**
```
PORT=dual
```

Это активирует режим `dual`, при котором:
- FastAPI запустится на порту 8081
- Gradio UI запустится на порту 7860
- Оба сервиса будут доступны одновременно

### Вариант 2: Запуск только FastAPI

**Изменить переменную окружения в Cloud.ru ML Inference:**
```
PORT=8081
```

Это активирует режим `server`, при котором:
- Запустится только FastAPI на порту 8081
- Gradio UI не будет запущен

### Вариант 3: Запуск по умолчанию (оба сервиса)

**Удалить переменную окружения PORT** или оставить её пустой:
```
PORT=
```

Это активирует режим `dual` по умолчанию, так как в скрипте указано:
```bash
# Если MODE все еще не установлен, используем значение по умолчанию
if [ -z "$MODE" ]; then
    MODE="dual"  # По умолчанию запускаем оба сервиса
fi
```

## Проверка корректности настроек после изменений

### 1. Логи запуска
После применения изменений в логах должно появиться:
```
============================================
PaddleOCR-VL Service (Enhanced Mode)
============================================
Режим: dual
```

Или для режима server:
```
============================================
PaddleOCR-VL Service (Enhanced Mode)
============================================
Режим: server
```

### 2. Проверка доступности сервисов

#### Для режима dual:
- FastAPI должен быть доступен по адресу:
  `https://c4045c32-f994-4e90-a471-ec8789ddb974-8081.modelrun.inference.cloud.ru/`
  
- Gradio UI должен быть доступен по адресу:
  `https://c4045c32-f994-4e90-a471-ec8789ddb974-7860.modelrun.inference.cloud.ru/`

#### Для режима server:
- FastAPI должен быть доступен по адресу:
  `https://c4045c32-f994-4e90-a471-ec8789ddb974-8081.modelrun.inference.cloud.ru/`

### 3. Проверка сетевой конфигурации Cloud.ru

Убедиться, что в настройках "Дополнительные порты" включена опция "Serverless" для порта 7860, если используется Gradio UI.

## Дополнительные рекомендации

### Переменные окружения для оптимальной работы:
```
PORT=dual                           # Режим запуска
DISABLE_MODEL_SOURCE_CHECK=True     # Отключение проверки подключения к хостерам моделей
COMPANY_NAME=Multitender           # Название компании для брендирования
LOG_LEVEL=INFO                     # Уровень логирования (INFO вместо DEBUG для продакшена)
```

### Health check настройки:
Для Cloud.ru ML Inference использовать:
- **Readiness probe**: `exec` с командой `/app/health_check.sh`
- **Liveness probe**: `exec` с командой `/app/health_check.sh`

Эти настройки обеспечат корректную проверку состояния обоих сервисов.

## Ожидаемый результат

После применения рекомендаций:
1. **FastAPI будет полностью функционален** на порту 8081
2. **Gradio UI будет доступен** на порту 7860 (если используется режим dual)
3. **Оба сервиса будут стабильно работать** без конфликтов
4. **Все endpoint'ы будут доступны** согласно документации

## Тестирование после исправлений

После внесения изменений рекомендуется выполнить следующие проверки:

1. **Проверка главного endpoint'а FastAPI**:
   ```bash
   curl -s https://c4045c32-f994-4e90-a471-ec8789ddb974-8081.modelrun.inference.cloud.ru/
   ```

2. **Проверка health endpoint'а**:
   ```bash
   curl -s https://c4045c32-f994-4e90-a471-ec8789ddb974-8081.modelrun.inference.cloud.ru/health
   ```

3. **Проверка доступности Gradio UI** (для режима dual):
   Открыть в браузере:
   `https://c4045c32-f994-4e90-a471-ec8789ddb974-7860.modelrun.inference.cloud.ru/`
