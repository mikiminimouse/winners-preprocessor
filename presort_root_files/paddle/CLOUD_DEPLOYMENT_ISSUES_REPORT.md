# Отчет о проблемах развертывания в Cloud.ru ML Inference

## Обнаруженные проблемы

### 1. Неправильный режим запуска сервиса

**Проблема**: Из логов видно, что сервис запущен в режиме `ui`, а не в режиме `server` или `dual`.

**Доказательства из логов**:
```
[16.12.2025, 10:18:25] INFO: Режим: ui
[16.12.2025, 10:18:25] INFO: PORT: 7860 (для одиночных режимов)
[16.12.2025, 10:18:25] INFO: Запуск Gradio Web UI на порту 7860...
```

**Последствия**:
- FastAPI сервис на порту 8081 не запущен вообще
- Только Gradio UI работает на порту 7860

### 2. Неправильная настройка сетевого интерфейса

**Проблема**: Gradio UI настроен на прослушивание только локального адреса `127.0.0.1`.

**Доказательства из логов**:
```
[16.12.2025, 10:21:48] INFO: * Running on local URL: http://127.0.0.1:7860
```

**Последствия**:
- Gradio UI недоступен извне контейнера
- Внешние запросы к `https://c4045c32-f994-4e90-a471-ec8789ddb974-7860.modelrun.inference.cloud.ru/` не достигают сервиса

### 3. Отсутствие доступа к FastAPI

**Проблема**: Сервис FastAPI на порту 8081 не запущен.

**Доказательства**:
- В логах отсутствуют записи о запуске FastAPI
- Нет сообщений типа "Запуск FastAPI handler на порту 8081..."

## Рекомендации по исправлению

### 1. Изменить режим запуска

**Вариант A: Только FastAPI (рекомендуется для API интеграции)**
- Установить переменную окружения: `PORT=8081`
- Это активирует режим `server` с запуском только FastAPI

**Вариант B: Оба сервиса (для комплексного тестирования)**
- Установить переменную окружения: `PORT=dual`
- Это активирует режим `dual` с запуском обоих сервисов

### 2. Исправить настройки Gradio

**Необходимые изменения в `gradio_app.py`**:
Убедиться, что в вызове `demo.launch()` указан параметр:
```python
demo.launch(
    server_name="0.0.0.0",
    server_port=7860,
    share=False,
    quiet=False
)
```

### 3. Проверить конфигурацию Cloud.ru ML Inference

**Сетевые настройки**:
- Убедиться, что оба порта (8081 и 7860) правильно проброшены
- Проверить, что для порта 7860 включена настройка "Serverless" если требуется

**Переменные окружения**:
```
PORT=8081  # или PORT=dual для двойного режима
DISABLE_MODEL_SOURCE_CHECK=True  # для ускорения запуска
COMPANY_NAME=Multitender  # или другое название компании
```

## Ожидаемый результат после исправлений

### При режиме server (PORT=8081):
- FastAPI будет доступен по адресу: `https://c4045c32-f994-4e90-a471-ec8789ddb974-8081.modelrun.inference.cloud.ru/`
- Endpointы:
  - `/` - информация о сервисе
  - `/health` - проверка состояния
  - `/ocr` - OCR обработка изображений
  - `/docs` - документация API

### При режиме dual (PORT=dual):
- FastAPI будет доступен по адресу: `https://c4045c32-f994-4e90-a471-ec8789ddb974-8081.modelrun.inference.cloud.ru/`
- Gradio UI будет доступен по адресу: `https://c4045c32-f994-4e90-a471-ec8789ddb974-7860.modelrun.inference.cloud.ru/`

## Дополнительные рекомендации

1. **Мониторинг логов**: После внесения изменений внимательно следить за логами запуска
2. **Health checks**: Убедиться, что health check скрипты работают корректно для обоих сервисов
3. **Тестирование**: Провести полное тестирование функциональности после исправлений
