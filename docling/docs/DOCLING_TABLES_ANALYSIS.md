# Анализ трансформации таблиц в Markdown через Docling

## Обзор процесса

Docling обрабатывает документы с таблицами из различных форматов и преобразует их в Markdown. Процесс включает:
1. **Извлечение таблиц** из исходного формата
2. **Нормализация структуры** таблиц
3. **Преобразование в Markdown** формат

## Поддерживаемые форматы

### 1. PDF (с текстовым слоем) - `pdf_text`

**Метод обработки:**
- **Docling (приоритет):** Использует `DocumentConverter` с `do_table_structure=True`
- **Fallback:** `pdfplumber` для извлечения таблиц

**Код:**
```python
# Docling метод
result = self.converter.convert(str(self.file_path))
doc_json = result.document.export_to_dict()

for item in doc_json.get("content", []):
    if item.get("type") == "table":
        tables.append(item)

# Fallback метод (pdfplumber)
with pdfplumber.open(str(self.file_path)) as pdf:
    for page in pdf.pages:
        page_tables = page.extract_tables()
        if page_tables:
            tables.extend(page_tables)
```

**Структура таблицы:**
- Docling возвращает объекты с типом `"table"` из JSON структуры документа
- pdfplumber возвращает списки списков (массив строк, каждая строка - массив ячеек)

**Пример:**
```python
# pdfplumber формат
[
    [["Заголовок 1", "Заголовок 2"], ["Данные 1", "Данные 2"]],
    ...
]
```

### 2. PDF (сканированный, требует OCR) - `pdf_scan`

**Метод обработки:**
- **Docling:** OCR + Table Structure Detection
- **Fallback:** `pytesseract` (OCR) + `pdfplumber` (таблицы)

**Особенности:**
- Для больших файлов (>50MB) таблицы извлекаются только из первых 50 страниц
- OCR может влиять на точность извлечения таблиц

**Код:**
```python
# OCR через Docling
result = self.converter.convert(str(self.file_path))
# Таблицы извлекаются аналогично pdf_text

# Fallback: OCR + таблицы
images = convert_from_path(str(self.file_path), dpi=dpi)
# ... OCR обработка ...
# Затем извлечение таблиц через pdfplumber
```

### 3. DOCX - `docx`

**Метод обработки:**
- **Docling (приоритет):** Использует встроенную обработку DOCX
- **Fallback:** `python-docx` библиотека

**Код:**
```python
# Docling метод
result = self.converter.convert(str(self.file_path))
doc_json = result.document.export_to_dict()

for item in doc_json.get("content", []):
    if item.get("type") == "table":
        tables.append(item)

# Fallback метод (python-docx)
doc = Document(str(self.file_path))
for table in doc.tables:
    table_data = []
    for row in table.rows:
        row_data = [cell.text.strip() for cell in row.cells]
        table_data.append(row_data)
    tables.append(table_data)
```

**Структура таблицы:**
- `python-docx` возвращает список списков (каждая строка - список ячеек)
- Ячейки содержат текст с удаленными пробелами в начале/конце

**Пример:**
```python
[
    ["Колонка 1", "Колонка 2", "Колонка 3"],
    ["Значение 1", "Значение 2", "Значение 3"],
    ...
]
```

### 4. HTML - `html_text`

**Метод обработки:**
- **BeautifulSoup** для парсинга HTML

**Код:**
```python
soup = BeautifulSoup(html_content, "html.parser")
tables = []

for table in soup.find_all("table"):
    table_data = []
    for row in table.find_all("tr"):
        row_data = [cell.get_text(strip=True) for cell in row.find_all(["td", "th"])]
        if row_data:
            table_data.append(row_data)
    if table_data:
        tables.append(table_data)
```

**Структура таблицы:**
- Список списков, где каждая строка (`<tr>`) преобразуется в список ячеек
- Поддерживаются как `<td>`, так и `<th>` элементы
- Текст извлекается с удалением пробелов (`strip=True`)

### 5. JPEG/Изображения

**Метод обработки:**
- **OCR** через `pytesseract` или Docling OCR
- Таблицы извлекаются после OCR обработки

**Особенности:**
- Требуется OCR для получения текста
- Структура таблиц может быть менее точной из-за OCR ошибок

## Преобразование в Markdown

### Процесс преобразования

Код из `_save_results()`:

```python
if result.get("tables"):
    md_content += "\n\n## Tables\n\n"
    for i, table in enumerate(result["tables"], 1):
        md_content += f"### Table {i}\n\n"
        if isinstance(table, list):
            # Таблица в виде списка списков
            for row in table:
                md_content += "| " + " | ".join(str(cell) for cell in row) + " |\n"
                if row == table[0]:
                    # Добавляем разделитель после первой строки (заголовок)
                    md_content += "|" + "|".join([" --- "] * len(row)) + "|\n"
        md_content += "\n"
```

### Формат Markdown таблиц

**Структура:**
```markdown
## Tables

### Table 1

| Колонка 1 | Колонка 2 | Колонка 3 |
| --- | --- | --- |
| Значение 1 | Значение 2 | Значение 3 |
| Значение 4 | Значение 5 | Значение 6 |
```

**Особенности:**
1. Каждая таблица получает заголовок `### Table N`
2. Первая строка автоматически считается заголовком
3. После первой строки добавляется разделитель `| --- |`
4. Все ячейки экранируются через `str()` для безопасного преобразования
5. Пустые ячейки остаются пустыми

### Обработка разных структур таблиц

#### 1. Список списков (fallback методы)
```python
table = [
    ["Header 1", "Header 2"],
    ["Data 1", "Data 2"]
]
# Преобразуется напрямую в Markdown
```

#### 2. Объекты Docling (при наличии)
```python
# Если Docling возвращает объекты с типом "table"
# Они должны быть предварительно преобразованы в список списков
# В текущей реализации это делается автоматически
```

## Примеры из реальных файлов

### DOCX файл
**Исходный формат:** DOCX с таблицей участников закупки

**Извлеченная структура:**
```python
[
    ["", "Публичное акционерное общество\n«Россети Центр и Приволжье»\n..."],
    ["ПРОТОКОЛ", "очно-заочного заседания Закупочной комиссии\n..."]
]
```

**Markdown результат:**
```markdown
### Table 1

|  | Публичное акционерное общество
«Россети Центр и Приволжье»

Филиал ПАО «Россети Центр и Приволжье» - 
«Мариэнерго» |
| --- | --- |
| ПРОТОКОЛ
очно-заочного заседания Закупочной комиссии 
по подведению итогов закупочной процедуры | ... |
```

### PDF файл
**Исходный формат:** PDF с таблицей результатов

**Извлеченная структура:**
- Через pdfplumber: список списков с данными
- Может содержать пустые ячейки или многострочный текст

**Markdown результат:**
- Аналогично DOCX, но может иметь больше форматирования из-за особенностей PDF

## Ограничения и особенности

### 1. Форматирование
- **Потеря форматирования:** Жирный текст, курсив, цвета не сохраняются
- **Многострочный текст:** Сохраняется как есть, может нарушать структуру таблицы
- **Объединенные ячейки:** Не поддерживаются напрямую, могут отображаться как пустые

### 2. Точность извлечения
- **PDF (текст):** Высокая точность при наличии текстового слоя
- **PDF (OCR):** Может быть менее точным, зависит от качества скана
- **DOCX:** Очень высокая точность, структура сохраняется
- **HTML:** Зависит от качества HTML разметки

### 3. Производительность
- **Большие файлы:** Для PDF >50MB таблицы извлекаются только из первых 50 страниц
- **OCR:** Медленнее для сканированных документов
- **Параллельная обработка:** Поддерживается для нескольких файлов

## Метрики и статистика

В процессе обработки собираются метрики:
```python
self.metrics["file_stats"]["tables_extracted"] = len(tables)
```

Эти метрики сохраняются в:
- JSON файл результата
- MongoDB (если настроено)
- Метрики обработки

## Рекомендации

### Для улучшения качества таблиц:

1. **PDF с текстом:**
   - Используйте Docling для лучшего качества
   - Проверяйте структуру таблиц в JSON перед преобразованием

2. **PDF сканы:**
   - Улучшайте качество сканов перед OCR
   - Используйте более высокий DPI (300 вместо 200)

3. **DOCX:**
   - Уже имеет высокое качество извлечения
   - Проверяйте форматирование в исходном документе

4. **HTML:**
   - Убедитесь в валидности HTML
   - Проверяйте вложенные таблицы

## Заключение

Docling успешно трансформирует таблицы из различных форматов в Markdown:
- ✅ **PDF (текст):** Отличное качество через Docling или pdfplumber
- ✅ **PDF (OCR):** Хорошее качество при качественных сканах
- ✅ **DOCX:** Отличное качество через python-docx
- ✅ **HTML:** Хорошее качество через BeautifulSoup
- ⚠️ **JPEG/Изображения:** Требует OCR, качество зависит от изображения

Все таблицы нормализуются в единый формат (список списков) и преобразуются в стандартный Markdown формат с разделителями.

