# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫ CLI

**–î–∞—Ç–∞:** 2025-01-17  
**–í–µ—Ä—Å–∏—è:** 2.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ —Ñ–∞–π–ª–æ–≤ –≤ INPUT_DIR ‚ùå ‚Üí ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ñ—É–Ω–∫—Ü–∏–∏ `handle_check_input_files()` –≤—ã–≤–æ–¥–∏–ª–æ—Å—å `.1f` –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
print(".1f")

# –°—Ç–∞–ª–æ:
print(f"  {i}. {file_path.name} ({size_mb:.1f} MB)")
```

**–§–∞–π–ª:** `preprocessing/cli.py:382`

---

### 2. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ MongoDB –≤ –ª–æ–≥–∞—Ö ‚ùå ‚Üí ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB –≤—ã–≤–æ–¥–∏–ª–∞—Å—å –ø–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞, —á—Ç–æ –∑–∞—Å–æ—Ä—è–ª–æ –ª–æ–≥–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `_mongo_metadata_error_shown` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ —Å —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

**–§–∞–π–ª:** `preprocessing/router/mongo.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –î–æ–±–∞–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥
_mongo_metadata_error_shown = False

# –í —Ñ—É–Ω–∫—Ü–∏–∏ get_mongo_metadata_client():
if not _mongo_metadata_error_shown:
    error_msg = str(e)
    if len(error_msg) > 200:
        error_msg = error_msg[:200] + "..."
    print(f"‚ö†Ô∏è  MongoDB metadata –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {error_msg}")
    print("üí° –ú–µ—Ç—Ä–∏–∫–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ")
    _mongo_metadata_error_shown = True
```

---

### 3. –¢—Ä–æ–π–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è —Ñ–∞–π–ª–æ–≤ ‚ùå ‚Üí ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `detect_file_type` –≤—ã–∑—ã–≤–∞–ª–∞—Å—å 3 —Ä–∞–∑–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞:
1. –í `process_file()` 
2. –í `distribute_unit_by_new_structure()` 
3. –í `classify_file()` (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `distribute_unit_by_new_structure()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ –∏–∑ `file_info`
- –ï—Å–ª–∏ –≤ `file_info` —É–∂–µ –µ—Å—Ç—å `detected_type` –∏ `mime_type`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–§–∞–π–ª:** `preprocessing/router/unit_distribution_new.py:84-99`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–∏–ø
if "detected_type" in file_info and "mime_type" in file_info:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–∏–ø
    detection_result = {
        "detected_type": file_info.get("detected_type"),
        "mime_type": file_info.get("mime_type"),
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    }
else:
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–Ω–æ–≤–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    detection_result = detect_file_type(file_path)
```

---

### 4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç —Ñ–∞–π–ª–æ–≤ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ ‚ùå ‚Üí ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ PENDING –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å "0 —Ñ–∞–π–ª–æ–≤" –¥–ª—è units, —Ö–æ—Ç—è —Ñ–∞–π–ª—ã –±—ã–ª–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã.

**–ü—Ä–∏—á–∏–Ω–∞:** –§—É–Ω–∫—Ü–∏—è `get_unit_statistics()` –∏—Å–∫–∞–ª–∞ —Ñ–∞–π–ª—ã —Ç–æ–ª—å–∫–æ –≤ `unit_dir / "files"`, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –º–æ–≥–ª–∞ –±—ã—Ç—å –¥—Ä—É–≥–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `unit_dir / "false_ext_unknown" / "files"`).

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ò–∑–º–µ–Ω–µ–Ω –ø–æ–∏—Å–∫ units –Ω–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π (`rglob` –≤–º–µ—Å—Ç–æ `iterdir`)
- –ò–∑–º–µ–Ω–µ–Ω –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `files`
- –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –Ω–∞–ø—Ä—è–º—É—é –≤ unit –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–∫—Ä–æ–º–µ metadata.json)

**–§–∞–π–ª:** `preprocessing/router/unit_distribution_new.py:290-303`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ units
units = []
for item in category_dir.rglob("UNIT_*"):
    if item.is_dir() and item.name.startswith("UNIT_"):
        parent_has_unit = any(p.name.startswith("UNIT_") for p in item.parents if p != category_dir)
        if not parent_has_unit:
            units.append(item)

# –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ files
files_dirs = list(unit_dir.rglob("files"))
if files_dirs:
    files_dir = files_dirs[0]
    files = [f for f in files_dir.iterdir() if f.is_file()]
    stats[category]["files"] += len(files)
else:
    # Fallback: —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é –≤ unit'–µ
    files = [f for f in unit_dir.iterdir() if f.is_file() and f.name != "metadata.json"]
    stats[category]["files"] += len(files)
```

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚ùå –í—ã–≤–æ–¥–∏–ª–æ—Å—å `.1f` –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
- ‚ùå –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ MongoDB –≤ –ª–æ–≥–∞—Ö (10+ —Ä–∞–∑)
- ‚ùå –¢—Ä–æ–π–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ (–Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ)
- ‚ùå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ "0 —Ñ–∞–π–ª–æ–≤" –¥–ª—è units

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–≤–æ–¥ –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤ –∏ —Ä–∞–∑–º–µ—Ä–æ–≤
- ‚úÖ –û—à–∏–±–∫–∏ MongoDB –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- ‚úÖ –î–µ—Ç–µ–∫—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à)
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤

### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ PENDING –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
direct: 20 units, 10 —Ñ–∞–π–ª–æ–≤
normalize: 2 units, 1 —Ñ–∞–π–ª–æ–≤
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ MongoDB:**
   - –°–æ–∫—Ä–∞—â–µ–Ω—ã –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö (>200 —Å–∏–º–≤–æ–ª–æ–≤)
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ fallback

2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - –£–º–µ–Ω—å—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤ `detect_file_type` —Å 3 –¥–æ 1-2 —Ä–∞–∑ –Ω–∞ —Ñ–∞–π–ª
   - –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ units –∏ —Ñ–∞–π–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

3. **–£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –ª–æ–≥–æ–≤:**
   - –£–±—Ä–∞–Ω—ã –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –æ—à–∏–±–∫–∏
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã:
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å —Ñ–∞–π–ª–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ units —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –í—ã–≤–æ–¥ —Ñ–∞–π–ª–æ–≤ –≤ INPUT_DIR –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ –û—à–∏–±–∫–∏ MongoDB –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

---

**–í—ã–≤–æ–¥:** –í—Å–µ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. CLI —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

