# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–∞–π–ø–ª–∞–π–Ω–∞ Preprocessor + Docling

## üìã –û–±—â–∞—è —Å—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã –ø–∞–π–ø–ª–∞–π–Ω–∞

### 1. Preprocessor (Router) Pipeline

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

```
–í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª ‚Üí detect_file_type() ‚Üí –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
  ‚Üì
–ï—Å–ª–∏ –∞—Ä—Ö–∏–≤ ‚Üí safe_extract_archive() ‚Üí –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
  ‚Üì
–ï—Å–ª–∏ DOC ‚Üí LibreOffice ‚Üí –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ DOCX
  ‚Üì
–°–æ–∑–¥–∞–Ω–∏–µ Unit ‚Üí create_manifest() ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ MongoDB/JSON
  ‚Üì
trigger_docling() ‚Üí –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Docling API
```

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `detect_file_type()` - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —á–µ—Ä–µ–∑ magic bytes –∏ mimetype
- `safe_extract_archive()` - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç zip bomb
- `create_manifest()` - —Å–æ–∑–¥–∞–µ—Ç manifest.json –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
- `process_file()` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞

### 2. Docling Pipeline

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

```
–ü–æ–ª—É—á–µ–Ω–∏–µ Unit ‚Üí –ß—Ç–µ–Ω–∏–µ manifest ‚Üí –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ route
  ‚Üì
Route: pdf_scan ‚Üí _process_pdf_ocr() ‚Üí Docling OCR
Route: pdf_text ‚Üí _process_pdf_text() ‚Üí Text Extraction
Route: docx ‚Üí _process_docx() ‚Üí Text Extraction
Route: image ‚Üí (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û) ‚Üí –î–æ–ª–∂–µ–Ω –±—ã—Ç—å OCR
Route: mixed ‚Üí (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û) ‚Üí –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  ‚Üì
Layout Analysis ‚Üí _extract_layout() ‚Üí –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  ‚Üì
Table Extraction ‚Üí (–≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ Docling) ‚Üí –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
  ‚Üì
_save_results() ‚Üí –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON/Markdown
```

---

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### A. Preprocessor (router/main.py)

#### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:

1. **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤** (`detect_file_type()`):
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç magic bytes + mimetype –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–µ–π–∫–æ–≤—ã–µ DOC (–∞—Ä—Ö–∏–≤—ã, HTML)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç PDF text layer —á–µ—Ä–µ–∑ pypdf

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞** (`safe_extract_archive()`):
   - –ó–∞—â–∏—Ç–∞ –æ—Ç zip bomb (MAX_UNPACK_SIZE_MB, MAX_FILES_IN_ARCHIVE)
   - –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ZIP, RAR, 7z

3. **–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ MongoDB
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞:

1. **PDF text layer detection (—Å—Ç—Ä–æ–∫–∏ 616-623)**:
   ```python
   for page in reader.pages[:3]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   ```
   **–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã—Ö PDF, –≥–¥–µ —Ç–µ–∫—Å—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 4-–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   
   **–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (JPEG/PNG)**:
   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è (`detected_type = "image"`), –Ω–æ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ route –¥–ª—è –Ω–∏—Ö
   - –í manifest –æ–Ω–∏ –ø–æ–ª—É—á–∞—é—Ç `needs_ocr=true`, –Ω–æ Docling –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö –Ω–∞–ø—Ä—è–º—É—é
   
   **–ü—Ä–æ–±–ª–µ–º–∞:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Docling OCR, –Ω–æ —Å–µ–π—á–∞—Å –Ω–µ—Ç route `image_ocr`

3. **Mixed route –æ–±—Ä–∞–±–æ—Ç–∫–∞**:
   - –í `create_manifest()` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `route = "mixed"` –¥–ª—è –∞—Ä—Ö–∏–≤–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ —Ñ–∞–π–ª–æ–≤
   - –ù–æ –≤ Docling –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ mixed route
   
   **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, DOCX + JPEG)

4. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è DOC ‚Üí DOCX**:
   - LibreOffice —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
   - –í `process_file()` –µ—Å—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 1204-1232), –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–Ω–∞–¥–µ–∂–Ω–æ
   
   **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ DOCX –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ –º–æ–º–µ–Ω—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Docling

5. **Manifest —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**:
   - Manifest —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ MongoDB, –Ω–æ –µ—Å—Ç—å fallback –Ω–∞ JSON
   - –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É MongoDB –∏ JSON —Ñ–∞–π–ª–∞–º–∏
   
   **–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### B. Docling Pipeline (docling/processor.py)

#### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Docling OCR**:
   - –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `docling-core` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Docling OCR (—Å—Ç—Ä–æ–∫–∞ 335-360)
   - Fallback –Ω–∞ pytesseract –µ—Å–ª–∏ Docling –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**:
   - –ö—ç—à –ø–æ SHA256 —Ö–µ—à—É —Ñ–∞–π–ª–∞
   - TTL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏
   - –≠–∫–æ–Ω–æ–º–∏—Ç —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤**:
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Ñ–∞–π–ª–æ–≤ > 50MB
   - –ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

4. **–ú–µ—Ç—Ä–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏**:
   - –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º, —Ç–∞–±–ª–∏—Ü–∞–º
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ MongoDB

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞:

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Docling Converter** (—Å—Ç—Ä–æ–∫–∏ 199-213):
   ```python
   if DOCLING_AVAILABLE:
       try:
           self.converter = DocumentConverter(
               format_options={
                   InputFormat.PDF: PdfPipelineOptions(
                       do_ocr=file_info.get("needs_ocr", False),
                       do_table_structure=True
                   )
               }
           )
   ```
   **–ü—Ä–æ–±–ª–µ–º–∞:** Converter —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–æ `do_ocr` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ `file_info`. –ï—Å–ª–∏ —Ñ–∞–π–ª —Ç—Ä–µ–±—É–µ—Ç OCR, –Ω–æ converter —Å–æ–∑–¥–∞–Ω —Å `do_ocr=False`, OCR –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.
   
   **–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–≤–∞—Ç—å converter –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫

2. **Layout Analysis –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ** (—Å—Ç—Ä–æ–∫–∏ 260-262):
   ```python
   if not result.get("layout"):
       result["layout"] = self._extract_layout(result)
   ```
   **–ü—Ä–æ–±–ª–µ–º–∞:** Layout Analysis –≤ Docling –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–π pipeline, –∞ –Ω–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ fallback –º–µ—Ç–æ–¥—ã
   
   **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Layout Analysis –∏–∑ Docling

3. **–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞–ø—Ä—è–º—É—é**:
   - –í `process()` –Ω–µ—Ç route –¥–ª—è `image_ocr`
   - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPEG/PNG) –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
   
   **–ü—Ä–æ–±–ª–µ–º–∞:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –∞—Ä—Ö–∏–≤–æ–≤ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã

4. **–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ mixed route**:
   - –í `docling/main.py` –µ—Å—Ç—å –ª–æ–≥–∏–∫–∞ –¥–ª—è mixed route (—Å—Ç—Ä–æ–∫–∏ 205-219), –Ω–æ –æ–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç route –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
   - –ù–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
   
   **–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è –∞—Ä—Ö–∏–≤–æ–≤ —Å DOCX + JPEG —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è

5. **Table Extraction –Ω–µ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:
   - –í Docling Table Extraction –≤—Å—Ç—Ä–æ–µ–Ω, –Ω–æ –≤ fallback –º–µ—Ç–æ–¥–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ pdfplumber
   - –î–ª—è DOCX –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è python-docx, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Docling
   
   **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ç–∞–±–ª–∏—Ü –º–µ–∂–¥—É Docling –∏ fallback

6. **–ù–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞**:
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ failed, –Ω–æ –Ω–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
   
   **–ü—Ä–æ–±–ª–µ–º–∞:** –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–µ—Ç–µ–≤—ã–µ) –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–æ–ª–Ω–æ–º—É –ø—Ä–æ–≤–∞–ª—É

---

## üöÄ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –£–ª—É—á—à–µ–Ω–∏–µ 1: –£–ª—É—á—à–µ–Ω–∏–µ PDF text layer detection

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã—Ö 3 —Å—Ç—Ä–∞–Ω–∏—Ü –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π

**–†–µ—à–µ–Ω–∏–µ:**

```python
def detect_pdf_text_layer(file_path: Path, max_pages_to_check: int = 10) -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–ª–æ—è –≤ PDF.
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ max_pages_to_check —Å—Ç—Ä–∞–Ω–∏—Ü –∏–ª–∏ 10% –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.
    """
    try:
        reader = PdfReader(str(file_path))
        total_pages = len(reader.pages)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º—É–º 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –º–∞–∫—Å–∏–º—É–º max_pages_to_check
        # –∏–ª–∏ 10% –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
        pages_to_check = min(
            max(3, int(total_pages * 0.1)),
            max_pages_to_check,
            total_pages
        )
        
        text_length = 0
        pages_with_text = 0
        
        for i, page in enumerate(reader.pages[:pages_to_check]):
            text = page.extract_text()
            if text:
                text_length += len(text.strip())
                if len(text.strip()) > 10:
                    pages_with_text += 1
        
        # –ï—Å–ª–∏ –Ω–∞ 30%+ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –µ—Å—Ç—å —Ç–µ–∫—Å—Ç - —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –µ—Å—Ç—å text layer
        has_text_layer = (pages_with_text / pages_to_check) >= 0.3
        
        return has_text_layer, {
            "total_pages": total_pages,
            "pages_checked": pages_to_check,
            "pages_with_text": pages_with_text,
            "total_text_length": text_length,
            "has_text_layer": has_text_layer
        }
    except Exception as e:
        # –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –Ω—É–∂–µ–Ω OCR
        return False, {"error": str(e), "assumed_scan": True}
```

### –£–ª—É—á—à–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPEG/PNG) –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ Docling

**–†–µ—à–µ–Ω–∏–µ:**

–í `docling/processor.py` –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥:

```python
def _process_image_ocr(self) -> Dict[str, Any]:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ OCR."""
    start_time = time.time()
    
    if DOCLING_AVAILABLE and self.converter:
        # Docling –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é
        try:
            result = self.converter.convert(str(self.file_path))
            doc_json = result.document.export_to_dict()
            
            text_content = []
            tables = []
            
            for item in doc_json.get("content", []):
                if item.get("type") == "text":
                    text_content.append(item.get("text", ""))
                elif item.get("type") == "table":
                    tables.append(item)
            
            self.metrics["processing_times"]["ocr"] = time.time() - start_time
            self.metrics["file_stats"]["tables_extracted"] = len(tables)
            
            return {
                "text": "\n".join(text_content),
                "tables": tables,
                "metadata": doc_json.get("metadata", {}),
                "layout": doc_json.get("layout", {}),
                "method": "docling_image_ocr"
            }
        except Exception as e:
            logger.warning(f"Docling image OCR failed: {e}, using fallback")
            return self._process_image_ocr_fallback()
    else:
        return self._process_image_ocr_fallback()

def _process_image_ocr_fallback(self) -> Dict[str, Any]:
    """Fallback OCR –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ pytesseract."""
    start_time = time.time()
    
    try:
        image = Image.open(str(self.file_path))
        text = pytesseract.image_to_string(image, lang='rus+eng')
        
        self.metrics["processing_times"]["ocr"] = time.time() - start_time
        
        return {
            "text": text,
            "tables": [],
            "metadata": {"image_format": image.format},
            "method": "pytesseract_image_fallback"
        }
    except Exception as e:
        logger.error(f"Image OCR fallback failed: {e}")
        raise
```

–ò –≤ `process()` –¥–æ–±–∞–≤–∏—Ç—å:

```python
elif self.route == "image_ocr":
    result = self._process_image_ocr()
```

### –£–ª—É—á—à–µ–Ω–∏–µ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ mixed route

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**

–í `docling/main.py` –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:

```python
def merge_mixed_results(processing_results: List[Dict[str, Any]]) -> Dict[str, Any]:
    """
    –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ mixed route.
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: DOCX —Ç–µ–∫—Å—Ç > OCR —Ç–µ–∫—Å—Ç > –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    """
    merged = {
        "text": [],
        "tables": [],
        "metadata": {},
        "layout": {"pages": [], "sections": []},
        "files_processed": []
    }
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: —Å–Ω–∞—á–∞–ª–∞ DOCX, –ø–æ—Ç–æ–º PDF, –ø–æ—Ç–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    sorted_results = sorted(
        processing_results,
        key=lambda x: (
            0 if x.get("file_type") == "docx" else
            1 if x.get("file_type") == "pdf" else 2
        )
    )
    
    for result in sorted_results:
        if result.get("success"):
            file_type = result.get("file_type", "unknown")
            file_name = result.get("file_name", "unknown")
            
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ç–µ–∫—Å—Ç
            if result.get("text"):
                merged["text"].append(f"\n--- {file_name} ({file_type}) ---\n")
                merged["text"].append(result["text"])
            
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—ã
            if result.get("tables"):
                merged["tables"].extend(result["tables"])
            
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            if result.get("metadata"):
                merged["metadata"][file_name] = result["metadata"]
            
            merged["files_processed"].append({
                "file_name": file_name,
                "file_type": file_type,
                "status": "success"
            })
    
    merged["text"] = "\n".join(merged["text"])
    
    return merged
```

### –£–ª—É—á—à–µ–Ω–∏–µ 4: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Docling Converter

**–ü—Ä–æ–±–ª–µ–º–∞:** Converter —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**

```python
def _get_docling_converter(self, needs_ocr: bool = False) -> Optional[DocumentConverter]:
    """–°–æ–∑–¥–∞–µ—Ç Docling converter —Å –Ω—É–∂–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏."""
    if not DOCLING_AVAILABLE:
        return None
    
    try:
        return DocumentConverter(
            format_options={
                InputFormat.PDF: PdfPipelineOptions(
                    do_ocr=needs_ocr,
                    do_table_structure=True
                )
            }
        )
    except Exception as e:
        logger.warning(f"Could not create Docling converter: {e}")
        return None

# –í –º–µ—Ç–æ–¥–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
def _process_pdf_ocr(self) -> Dict[str, Any]:
    start_time = time.time()
    
    converter = self._get_docling_converter(needs_ocr=True)
    if converter:
        result = converter.convert(str(self.file_path))
        # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
```

### –£–ª—É—á—à–µ–Ω–∏–µ 5: Retry –º–µ—Ö–∞–Ω–∏–∑–º

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**

```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10)
)
def process_with_retry(self) -> Dict[str, Any]:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–∞–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö."""
    return self.process()
```

### –£–ª—É—á—à–µ–Ω–∏–µ 6: –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ DOC ‚Üí DOCX –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ DOCX –∫ –º–æ–º–µ–Ω—Ç—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Docling

**–†–µ—à–µ–Ω–∏–µ:**

–í `router/main.py` –¥–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—ã–π –≤—ã–∑–æ–≤ LibreOffice:

```python
def convert_doc_to_docx(doc_path: Path, output_dir: Path) -> Optional[Path]:
    """–Ø–≤–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç DOC –≤ DOCX —á–µ—Ä–µ–∑ LibreOffice."""
    try:
        docx_path = output_dir / f"{doc_path.stem}.docx"
        
        # –í—ã–∑—ã–≤–∞–µ–º LibreOffice –Ω–∞–ø—Ä—è–º—É—é
        result = subprocess.run(
            [
                "soffice",
                "--headless",
                "--convert-to", "docx",
                "--outdir", str(output_dir),
                str(doc_path)
            ],
            capture_output=True,
            timeout=60,
            check=True
        )
        
        if docx_path.exists():
            return docx_path
        return None
    except Exception as e:
        logger.error(f"DOC conversion failed: {e}")
        return None
```

---

## üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `docling/main.py` (—Å—Ç—Ä–æ–∫–∏ 223-275), –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –Ω–∞–≥—Ä—É–∑–∫–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –∫—ç—à–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤
- **–ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å batch processing —Å –æ—á–µ—Ä–µ–¥—è–º–∏

### 2. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

- **Retry –º–µ—Ö–∞–Ω–∏–∑–º:** –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
- **Graceful degradation:** –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Docling –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback –º–µ—Ç–æ–¥—ã
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —á–∞—Å—Ç–æ—Ç–µ –æ—à–∏–±–æ–∫

### 3. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

- **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:** Docker Compose —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `--scale`
- **–û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á:** –î–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–æ–±–∞–≤–∏—Ç—å Redis + RQ/Celery
- **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –†–∞–∑–¥–µ–ª–∏—Ç—å Preprocessor –∏ Docling –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –¥–æ—Ä–∞–±–æ—Ç–∫–∏

1. **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (JPEG/PNG) —á–µ—Ä–µ–∑ route `image_ocr`
   - ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è mixed route
   - ‚úÖ –£–ª—É—á—à–∏—Ç—å PDF text layer detection (–±–æ–ª—å—à–µ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
   - ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Docling Converter

2. **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
   - ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - ‚ö†Ô∏è –£–ª—É—á—à–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é manifest –º–µ–∂–¥—É MongoDB –∏ JSON
   - ‚ö†Ô∏è –Ø–≤–Ω—ã–π –≤—ã–∑–æ–≤ LibreOffice –¥–ª—è DOC –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏

3. **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
   - üìù –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è)
   - üìù –£–ª—É—á—à–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   - üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API endpoints

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–∞–π–ø–ª–∞–π–Ω –≤ —Ü–µ–ª–æ–º —Ö–æ—Ä–æ—à–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π:

1. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å route `image_ocr`
2. **Mixed route** - –Ω—É–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
3. **PDF detection** - —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É text layer
4. **Docling Converter** - —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è —ç—Ç–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –ø–∞–π–ø–ª–∞–π–Ω –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –¥–ª—è –≤—Å–µ—Ö –∑–∞—è–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

