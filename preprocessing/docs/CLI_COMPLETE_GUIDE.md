# ПОЛНОЕ РУКОВОДСТВО ПО CLI ПРЕПРОЦЕССИНГА ДОКУМЕНТОВ

## Обзор

CLI (Command Line Interface) для препроцессинга документов предоставляет полный набор инструментов для управления всеми этапами обработки документов в системе Winners223.

## Запуск CLI

### Через Docker Compose
```bash
cd /root/winners_preprocessor/preprocessing
docker-compose up -d
docker-compose exec cli python3 cli.py
```

### Через Python (локально)
```bash
cd /root/winners_preprocessor/preprocessing
python3 cli.py
```

## Структура меню

CLI содержит **27 пунктов меню**, разделенных на категории:

### 1. ЗАГРУЗКА И ПОДГОТОВКА ДАННЫХ
- **1. Синхронизация протоколов из MongoDB** - Загрузка протоколов из удаленной MongoDB в локальную
- **2. Скачивание протоколов за дату** - Скачивание документов через VPN
- **3. Проверка доступности файлов в INPUT_DIR** - Проверка входных файлов

### 2. ТЕСТИРОВАНИЕ ЭТАПОВ ПРЕПРОЦЕССИНГА
- **4. ТЕСТ 1: Определение типа файла** - Тест детекции типов файлов
- **5. ТЕСТ 2: Распаковка архивов** - Тест распаковки ZIP/RAR/7z
- **6. ТЕСТ 3: Нормализация unit'ов** - Тест создания unit структур
- **7. ТЕСТ 4: Создание manifest'ов** - Тест генерации метаданных
- **8. ТЕСТ 5: Docling обработка** - Тест отправки в Docling pipeline

### 3. ПОШАГОВАЯ ОБРАБОТКА
- **9. ШАГ 1: Сканирование и детекция типов файлов** - Детекция типов всех файлов
- **10. ШАГ 2: Классификация файлов по категориям** - Распределение по категориям
- **11. ШАГ 3: Проверка дубликатов** - Поиск и удаление дубликатов
- **12. ШАГ 4: Определение mixed units** - Анализ смешанных документов
- **13. ШАГ 5: Распределение по pending директориям** - Распределение файлов
- **14. ПОЛНАЯ ОБРАБОТКА: Все шаги (1-5)** - Полный pipeline обработки

### 4. ПОЛНОЕ ТЕСТИРОВАНИЕ PIPELINE
- **15. ПОЛНЫЙ ТЕСТ: Весь pipeline (шаги 1-5)** - Комплексное тестирование
- **16. ИНТЕГРАЦИОННЫЙ ТЕСТ: Router API** - Тест API endpoints

### 5. РАСШИРЕННАЯ СТАТИСТИКА
- **17. Просмотр структуры pending директорий** - Структура pending/*
- **18. Детальная статистика по категориям** - Статистика по типам файлов
- **19. Отчет по обработанным units** - Анализ normalized units

### 6. MERGE И ФИНАЛИЗАЦИЯ
- **20. Merge (DRY RUN)** - Планирование merge операций
- **21. Merge (РЕАЛЬНЫЙ)** - Выполнение merge в ready_docling

### 7. МОНИТОРИНГ И СТАТИСТИКА
- **22. Просмотр текущих метрик сессии** - Метрики обработки
- **23. Просмотр логов обработки** - Логи операций
- **24. Статус MongoDB подключений** - Проверка БД

### 8. СЛУЖЕБНЫЕ ФУНКЦИИ
- **25. Очистка тестовых данных** - Удаление тестовых файлов
- **26. Создание тестовых файлов** - Генерация тестовых данных
- **27. Проверка инфраструктуры** - Диагностика системы

## Подробное описание функций

### 1. Синхронизация протоколов из MongoDB

**Назначение:** Синхронизация протоколов из удаленной MongoDB в локальную базу данных.

**Действия:**
- Проверка подключения к удаленной MongoDB
- Проверка подключения к локальной MongoDB
- Выбор даты для синхронизации (вчера по умолчанию)
- Установка лимита протоколов
- Запуск синхронизации

**Пример использования:**
```
=== СИНХРОНИЗАЦИЯ ПРОТОКОЛОВ ИЗ УДАЛЁННОЙ MONGODB ===

1. Проверка подключения к удалённой MongoDB...
✓ Подключение к удалённой MongoDB успешно

2. Проверка подключения к локальной MongoDB...
✓ Подключение к локальной MongoDB успешно

3. Выбор даты для синхронизации:
  1. Вчерашний день (по умолчанию)
  2. Указать дату вручную (YYYY-MM-DD)
  Выберите [1-2] или Enter для вчерашнего дня: 1

4. Лимит протоколов для синхронизации (по умолчанию: 200): 500

5. Запуск синхронизации...
   Дата: 2024-12-16
   Лимит: 500

✓ Синхронизация завершена успешно!
   Просмотрено: 450
   Вставлено: 380
   Пропущено: 70
```

### 2. Скачивание протоколов через VPN

**Назначение:** Скачивание документов из локальной MongoDB через VPN.

**Требования:** Активное VPN подключение через route-up-zakupki.sh

**Действия:**
- Проверка доступности zakupki.gov.ru через VPN
- Запрос лимита протоколов
- Атомарное резервирование протоколов
- Параллельное скачивание документов

**Пример использования:**
```
=== СКАЧИВАНИЕ ПРОТОКОЛОВ ИЗ MONGODB (С VPN) ===

1. Проверка доступности zakupki.gov.ru через VPN...
✓ zakupki.gov.ru доступен через VPN

2. Лимит протоколов/units для скачивания (по умолчанию: 200): 100

3. Запуск скачивания...
   Лимит: 100
   Директория: /app/data/input

✓ Скачивание завершено!
   Время: 45.2 сек
   Протоколы обработано: 100
   Документы скачано: 850
   Ошибок: 12
```

### 9-14. Пошаговая обработка

#### ШАГ 1: Сканирование и детекция типов файлов
Сканирует все файлы в INPUT_DIR и определяет их типы (PDF, DOCX, ZIP и т.д.).

#### ШАГ 2: Классификация файлов по категориям
Распределяет файлы по категориям:
- **direct**: PDF, DOCX, TXT
- **convert**: DOC, XLS, PPT
- **extract**: ZIP, RAR, 7z
- **special**: другие форматы

#### ШАГ 3: Проверка дубликатов
Находит дублированные файлы по SHA256 хэшам.

#### ШАГ 4: Определение mixed units
Анализирует units с файлами разных типов.

#### ШАГ 5: Распределение по pending директориям
Копирует файлы в соответствующие поддиректории pending/*.

#### ПОЛНАЯ ОБРАБОТКА
Выполняет все шаги последовательно.

### 17-19. Расширенная статистика

#### Просмотр структуры pending директорий
Показывает количество файлов в каждой категории pending/*.

#### Детальная статистика по категориям
Отображает статистику по расширениям файлов, размерам и т.д.

#### Отчет по обработанным units
Анализирует units в normalized/, показывает наличие manifest.json, ошибки и т.д.

### 20-21. Merge операции

#### Merge (DRY RUN)
Показывает планируемые операции перемещения файлов из pending/ в ready_docling/.

#### Merge (РЕАЛЬНЫЙ)
Выполняет фактическое перемещение файлов с подтверждением.

## Диагностика и troubleshooting

### Проблема: "Модули скачивания не доступны"
**Решение:** Проверьте, что файлы protocol_sync.py и downloader/ скопированы в preprocessing/router/

### Проблема: "MongoDB не настроена или недоступна"
**Решение:**
1. Проверьте переменные окружения MONGO_*
2. Убедитесь, что MongoDB контейнер запущен
3. Проверьте подключение: `docker-compose ps`

### Проблема: "zakupki.gov.ru недоступен"
**Решение:**
1. Проверьте VPN подключение
2. Убедитесь, что route-up-zakupki.sh выполнен
3. Проверьте маршрут: `ip route show | grep zakupki`

### Проблема: "SyntaxError в cli.py"
**Решение:** Перезапустите CLI или проверьте версию Python (3.8+)

## Рабочие процессы

### Полный pipeline обработки
1. Синхронизировать протоколы (п.1)
2. Скачать документы (п.2)
3. Выполнить полную обработку (п.14)
4. Проверить статистику (п.17-19)
5. Выполнить merge (п.21)

### Тестирование системы
1. Создать тестовые файлы (п.26)
2. Протестировать каждый этап (п.4-8)
3. Выполнить полный тест (п.15)
4. Очистить тестовые данные (п.25)

### Мониторинг работы
1. Проверить инфраструктуру (п.27)
2. Посмотреть метрики (п.22)
3. Проверить логи (п.23)
4. Посмотреть статистику (п.17-19)

## Горячие клавиши

- **0**: Выход
- **Enter**: Продолжить после выполнения команды

## Логи и отладка

Все операции логируются. Для просмотра логов используйте п.23 "Просмотр логов обработки".

Для детальной отладки запустите CLI с переменной окружения:
```bash
PYTHONPATH=/app python3 -c "import logging; logging.basicConfig(level=logging.DEBUG); from cli import main; main()"
```

## Производительность

- **Синхронизация MongoDB**: 1000+ протоколов/минуту
- **Скачивание через VPN**: 50-100 файлов/минуту (зависит от VPN)
- **Обработка файлов**: 100+ файлов/минуту
- **Docling pipeline**: 10-20 файлов/минуту

## Безопасность

- Все сетевые запросы идут через VPN (только zakupki.gov.ru)
- Файлы сканируются на вредоносный код перед обработкой
- Архивы проверяются на zip bomb атаки
- Доступ к MongoDB через аутентификацию
