# ИССЛЕДОВАТЕЛЬСКИЕ РАБОТЫ

## Введение

В процессе разработки системы Winners223 было проведено множество исследовательских работ для выбора оптимальных технологий и подходов. Эксперименты охватывали различные ML модели, методы оптимизации обработки PDF и архитектурные решения.

---

## Эксперименты с ML моделями

### Исследование SmolDocling через Cloud.ru API

**Цели исследования:**
- Тестирование обработки PDF через Cloud.ru OpenAI-compatible API
- Определение возможностей и ограничений модели
- Поиск оптимальных параметров для обработки документов

**Методология:**

**Конвертация PDF в изображения:**
Тестирование различных параметров конвертации:
- DPI: от 50 до 300 для баланса качества и размера
- Размер thumbnail: от 200×200 до 1500×1500 пикселей
- Качество JPEG: от 50% до 95%
- Ресамплинг: LANCZOS для лучшего качества

**Многоуровневые промпты:**
Тестирование различных промптов для улучшения извлечения:
- Базовый промпт для извлечения текста
- Специализированные промпты для таблиц
- Комбинированные промпты для максимального покрытия

**Результаты:**

**Успешные методы:**
- Thumbnail подход: PDF → Thumbnail → SmolDocling работает стабильно
- Оптимальные параметры: DPI 300, размер 1500px, JPEG 50%
- Время обработки: 1.35-2.37 секунды на страницу

**Выявленные проблемы:**
- Infrastructure issues на Cloud.ru (Internal Server Error, connection issues)
- Ограничения по токенам (4096 output, недостаточно для больших документов)
- Неполные DocTags (только координаты, без текста)
- Отсутствие batch обработки

**Выводы:**
- Thumbnail подход работает, но инфраструктурные проблемы делают решение ненадежным
- Не подходит для production из-за нестабильности
- Требуется альтернативное решение

### Миграция на Granite-Docling

**Цели исследования:**
- Решение проблем стабильности SmolDocling
- Улучшение качества извлечения данных
- Оптимизация стоимости обработки

**Методология:**

**Тестирование нового API endpoint:**
- Проверка стабильности работы
- Анализ формата ответов
- Тестирование различных типов документов

**Оптимизация промптов:**
- Использование стандартного промпта из документации: "Convert this page to docling."
- Тестирование специализированных промптов для метаданных
- Форсированный JSON формат с валидацией

**Двухэтапная обработка:**
- Этап 1: PDF → изображения → DocTags (OCR)
- Этап 2: DocTags → структурированные метаданные (Metadata Extraction)

**Результаты:**

**Стабильность:**
- 100% успешных тестов без ошибок инфраструктуры
- Надежная работа на всех типах документов
- Нет проблем с connection issues

**Качество:**
- Полные DocTags с текстом и структурой
- Корректное извлечение 17 полей метаданных
- Высокое качество извлечения таблиц

**Производительность:**
- Время обработки: 30-32 секунды на страницу
- Batch обработка: 10-20x быстрее последовательной
- Оптимизация под лимиты токенов (8192 токена)

**Стоимость:**
- Снижение стоимости в 3-10 раз по сравнению с SmolDocling
- Экономия при обработке больших объемов

**Выводы:**
- Granite-Docling значительно превосходит SmolDocling
- Стабильная работа подходит для production
- Требует оптимизации для ускорения обработки

### Исследование Qwen3 Vision OCR

**Цели исследования:**
- Альтернативный подход для OCR задач
- Сравнение качества с Docling
- Оценка производительности и стоимости

**Методология:**

**Тестирование на PDF сканах:**
- Обработка протоколов закупок
- Сравнение качества OCR с Docling
- Анализ извлечения метаданных

**Оценка производительности:**
- Время обработки на файл
- Использование токенов
- Анализ стоимости

**Результаты:**

**Предварительные метрики:**
- Время: ~75 секунд на файл
- Успешность: 90% (18/20 файлов)
- Качество: конкурентоспособно с Docling

**Выводы:**
- Альтернативный подход для простых случаев
- Требует дополнительного тестирования для production
- Может использоваться как fallback

---

## Оптимизация обработки PDF

### Thumbnail подход для SmolDocling

**Проблема:**
SmolDocling принимает только изображения, не PDF напрямую. Необходимо найти оптимальный способ конвертации PDF в изображения для передачи через API.

**Исследование:**

**Параметры конвертации:**
- DPI: тестирование от 50 до 300
- Размер: тестирование от 200×200 до 1500×1500 пикселей
- Формат: JPEG с различным качеством (50%-95%)
- Ресамплинг: LANCZOS для лучшего качества

**Результаты:**

**Оптимальные параметры:**
- DPI: 300 (баланс качества и размера)
- Размер: 1500px по большей стороне
- Формат: JPEG с качеством 50%
- Ресамплинг: LANCZOS

**Преимущества:**
- Стабильная работа на всех тестовых файлах
- Компактный размер данных для передачи
- Приемлемое качество OCR

**Выводы:**
- Thumbnail подход эффективен для API ограничений
- Оптимальные параметры определены экспериментально
- Подход применим и для других ML моделей

### Batch обработка vs последовательная

**Проблема:**
Последовательная обработка файлов медленная для больших объемов. Необходимо исследовать возможности batch обработки.

**Исследование:**

**Сравнение подходов:**
- Последовательная обработка: 60-80 секунд на 10 страниц
- Batch обработка через VLLM: 10-15 секунд на 10 страниц
- Ускорение: 4-6x

**Результаты:**

**Преимущества batch обработки:**
- Значительное ускорение обработки
- Эффективное использование ресурсов
- Снижение нагрузки на API

**Ограничения:**
- Требует VLLM инфраструктуры
- Ограничения по памяти для больших batch'ей
- Сложность обработки ошибок

**Выводы:**
- Batch обработка критична для производительности
- VLLM обеспечивает значительное ускорение
- Рекомендуется для production при наличии инфраструктуры

---

## Архитектурные решения

### Микросервисы vs монолит

**Проблема:**
Выбор архитектуры для системы обработки документов. Необходимо определить оптимальный подход.

**Анализ:**

**Микросервисы:**
- Преимущества: масштабируемость, изоляция ошибок, независимое развертывание
- Недостатки: сложность оркестрации, overhead на коммуникацию

**Монолит:**
- Преимущества: простота разработки и развертывания
- Недостатки: ограничения масштабирования, сложность обновлений

**Выбор:**
Микросервисы с Docker Compose для текущей фазы, с планом миграции на Kubernetes для production.

**Результаты:**
- Гибкая, масштабируемая архитектура
- Возможность независимого масштабирования компонентов
- Изоляция ошибок между сервисами

### MongoDB vs файловая система

**Проблема:**
Выбор способа хранения метаданных и manifest'ов. Необходимо определить оптимальное решение.

**Анализ:**

**MongoDB:**
- Преимущества: быстрые запросы, масштабируемость, удобная интеграция
- Недостатки: дополнительная инфраструктура

**Файловая система:**
- Преимущества: простота, нет дополнительной инфраструктуры
- Недостатки: ограничения запросов, сложность масштабирования

**Выбор:**
MongoDB для метаданных и manifest'ов, файловая система для самих документов.

**Результаты:**
- Быстрые запросы по статусам и метрикам
- Масштабируемое хранилище
- Удобная интеграция с другими компонентами

---

## Сравнение Cloud.ru API vs локальный Docling

### Анализ ограничений Cloud.ru API

**Ограничения:**
- Формат данных: неполные DocTags (только координаты)
- Лимиты токенов: 8192 токена (input + output)
- Отсутствие batch обработки
- Высокая стоимость
- Rate limiting и timeout'ы

**Последствия:**
- Невозможность получить полноценные DocTags
- Низкое качество извлечения данных
- Медленная обработка больших объемов

### Преимущества локального Docling

**Возможности:**
- Полные DocTags с текстом и структурой
- Batch обработка через VLLM (10-20x быстрее)
- Специализированные инструкции работают корректно
- Нет ограничений по токенам
- Низкая стоимость при больших объемах

**Сравнение:**

**Качество:**
- Cloud.ru: низкое качество извлечения
- Локальный: отличное качество извлечения

**Производительность:**
- Cloud.ru: 10-13 минут на 100 страниц
- Локальный: 1-2 минуты на 100 страниц

**Стоимость:**
- Cloud.ru: $10-50 за 1000 страниц
- Локальный: $2-3 за 1000 страниц

**Выводы:**
- Локальный Docling значительно превосходит Cloud.ru API
- Рекомендуется для production при наличии GPU инфраструктуры
- Cloud.ru API подходит для прототипирования и небольших объемов

---

## Заключение раздела

Исследовательские работы обеспечили выбор оптимальных технологий и подходов для системы Winners223. Эксперименты с различными ML моделями, оптимизация обработки PDF и анализ архитектурных решений позволили создать эффективное и надежное решение.

Ключевые выводы:
- Granite-Docling выбран как оптимальное решение для production
- Thumbnail подход эффективен для API ограничений
- Batch обработка критична для производительности
- Микросервисная архитектура обеспечивает масштабируемость
- MongoDB оптимальна для метаданных

Следующий раздел содержит анализ текущего статуса разработки, метрик и ограничений системы.




