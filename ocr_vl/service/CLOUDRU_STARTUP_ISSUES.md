# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º –∑–∞–ø—É—Å–∫–∞ –Ω–∞ Cloud.ru ML Inference

**–î–∞—Ç–∞:** 05.12.2025  
**–û–±—Ä–∞–∑:** `paddleocr-vl-service:latest`

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ:

1. ‚úÖ **FastAPI —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8081
2. ‚úÖ **Health check –æ—Ç–≤–µ—á–∞–µ—Ç** - HTTP 200 OK
3. ‚úÖ **–ò–º–ø–æ—Ä—Ç PaddleOCR-VL —É—Å–ø–µ—à–µ–Ω** - –±–µ–∑ –æ—à–∏–±–æ–∫ torch/NCCL
4. ‚úÖ **–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç** - –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∑–∞–ø–∏—Å–∏
5. ‚úÖ **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã** - `/docs`, `/redoc`, `/openapi.json`
6. ‚úÖ **Torch —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω** - –≤–µ—Ä—Å–∏—è 2.4.1+cu121 (–ª–æ–∫–∞–ª—å–Ω–æ –±–µ–∑ CUDA)

## üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º –Ω–∞ Cloud.ru

### 1. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ torch —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ torch —Å `--force-reinstall` –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
- –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç

**–†–µ—à–µ–Ω–∏–µ (–ø—Ä–∏–º–µ–Ω–µ–Ω–æ):**
- –£–±—Ä–∞–Ω–∞ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ torch
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è torch –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ (–∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º)
- –¢–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è PaddlePaddle –∏ PaddleOCR

### 2. –ü—Ä–æ–±–ª–µ–º–∞ —Å NCCL –≤ –±–∞–∑–æ–≤–æ–º –æ–±—Ä–∞–∑–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ `paddlex-genai-vllm-server` –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –≤–µ—Ä—Å–∏–∏ NCCL
- –û—à–∏–±–∫–∞: `undefined symbol: ncclCommWindowRegister`

**–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
1. –ù–µ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å torch (–ø—Ä–∏–º–µ–Ω–µ–Ω–æ)
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ–±—Ö–æ–¥–∞ –ø—Ä–æ–±–ª–µ–º
3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å PaddleOCR —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ GPU

### 3. Health check —Ç–∞–π–º–∞—É—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, health check –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –Ω–µ—É–¥–∞—á–µ–π
- ML Inference –º–æ–∂–µ—Ç —É–±–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

**–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ Cloud.ru:**
```
Liveness Probe:
  - Initial Delay: 60 —Å–µ–∫
  - Period: 30 —Å–µ–∫
  - Failure Threshold: 3

Readiness Probe:
  - Initial Delay: 90 —Å–µ–∫
  - Period: 15 —Å–µ–∫
  - Failure Threshold: 3
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –£–≤–µ–ª–∏—á–∏—Ç—å `initialDelaySeconds` –¥–æ 180-240 —Å–µ–∫—É–Ω–¥
- –£–≤–µ–ª–∏—á–∏—Ç—å `failureThreshold` –¥–æ 10-15 –¥–ª—è startup probe

### 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PaddleOCR-VL

**–ü—Ä–æ–±–ª–µ–º–∞:**
- PaddleOCR-VL –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ (–ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
- –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ, –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—à–∏–±–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
- Health check –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PaddleOCR
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º OCR –∑–∞–ø—Ä–æ—Å–µ

### 5. –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –±–µ–∑ `tempfile.NamedTemporaryFile`
- –§–∞–π–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `Path` –∏ `open()`

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–ë—ã–ª–æ:**
```dockerfile
RUN python3 -m pip uninstall -y torch torchvision torchaudio || true && \
    python3 -m pip install --no-cache-dir torch==2.4.1+cu121 ...
```

**–°—Ç–∞–ª–æ:**
```dockerfile
# –ò—Å–ø–æ–ª—å–∑—É–µ–º torch –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ PaddlePaddle –∏ PaddleOCR
RUN python3 -m pip install --no-cache-dir \
    paddlepaddle-gpu==3.2.1 \
    -i https://www.paddlepaddle.org.cn/packages/stable/cu126/
```

### 2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —à–∞–≥–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ `/app/temp` –∏ `/app/output` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

## üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Cloud.ru

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Health Check

**Startup Probe:**
```yaml
startupProbe:
  httpGet:
    path: /health
    port: 8081
  initialDelaySeconds: 0
  periodSeconds: 15
  timeoutSeconds: 10
  failureThreshold: 40  # –î–æ 10 –º–∏–Ω—É—Ç –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
  successThreshold: 1
```

**Liveness Probe:**
```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8081
  initialDelaySeconds: 180  # –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3
```

**Readiness Probe:**
```yaml
readinessProbe:
  httpGet:
    path: /health
    port: 8081
  initialDelaySeconds: 240  # –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 90
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö:**

‚úÖ **–•–æ—Ä–æ—à–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:**
- `PaddleOCRVL imported successfully`
- `TEMP_DIR is writable: /app/temp`
- `OUTPUT_DIR is writable: /app/output`
- `Application startup complete`
- `Uvicorn running on http://0.0.0.0:8081`

‚ùå **–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:**
- `ImportError: torch` - –ø—Ä–æ–±–ª–µ–º–∞ torch/NCCL
- `undefined symbol: ncclCommWindowRegister` - –ø—Ä–æ–±–ª–µ–º–∞ NCCL
- `Permission denied` - –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- `Failed to initialize PaddleOCR-VL` - –ø—Ä–æ–±–ª–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health check:
   ```bash
   curl -H "Authorization: Bearer API_KEY" https://endpoint/health
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–π endpoint:
   ```bash
   curl -H "Authorization: Bearer API_KEY" https://endpoint/
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Swagger UI:
   ```
   https://endpoint/docs
   ```

4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π OCR –∑–∞–ø—Ä–æ—Å:
   ```bash
   curl -X POST -H "Authorization: Bearer API_KEY" \
     -F "file=@test.jpg" https://endpoint/ocr
   ```

## üéØ –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã health check** - –¥–∞—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
2. **–ù–µ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å torch** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏** - –∏—Å–∫–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ** - —Å–Ω–∞—á–∞–ª–∞ health check, –ø–æ—Ç–æ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å, –ø–æ—Ç–æ–º OCR

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –û–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
2. ‚è≥ –ó–∞–ø—É—à–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–∑ –≤ Artifact Registry
3. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞ Cloud.ru ML Inference
4. ‚è≥ –£–≤–µ–ª–∏—á–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã health check
5. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ –∏ –ø–µ—Ä–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

