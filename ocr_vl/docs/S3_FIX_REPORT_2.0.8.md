# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ S3 –∑–∞–≥—Ä—É–∑–∫–∏ - –≤–µ—Ä—Å–∏—è 2.0.8

**–î–∞—Ç–∞:** 2025-12-10  
**–í–µ—Ä—Å–∏—è:** 2.0.8  
**Digest:** `sha256:54c69214f8e08d77ed25d606b10531c22cd51e28d60a432f385248b0b2d05032`

---

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `upload_to_cloudru()`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö URL (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `bucket.s3.cloud.ru`)
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ (–¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ (ClientError, BotoCoreError)

### 2. –£–ª—É—á—à–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è S3 –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `USE_CLOUDRU_S3` –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è S3
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ `ACCESS_KEY` (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ tenant_id:key_id)
- ‚úÖ –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ bucket –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### 3. –§–æ—Ä–º–∞—Ç –ø—É–±–ª–∏—á–Ω—ã—Ö URL
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Cloud.ru:
```
https://bucket-winners223.s3.cloud.ru/ocr-results/<filename>
```

---

## üìã –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Docker Run

### ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –§–æ—Ä–º–∞—Ç `CLOUDRU_S3_ACCESS_KEY`

**Cloud.ru —Ç—Ä–µ–±—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç `tenant_id:key_id`** (—Å –¥–≤–æ–µ—Ç–æ—á–∏–µ–º):

```bash
USE_CLOUDRU_S3=true
CLOUDRU_S3_ENDPOINT=https://s3.cloud.ru
CLOUDRU_S3_BUCKET=bucket-winners223
CLOUDRU_S3_REGION=ru-central-1
CLOUDRU_S3_ACCESS_KEY=502f76f0-9017-493d-bda4-9e1bb278da84:ce94860ccc8780b2bc5f00f31459d24e
CLOUDRU_S3_SECRET_KEY=759469c88d6e450b584e2487c5174770
LOG_LEVEL=DEBUG
```

### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
```bash
CLOUDRU_S3_ACCESS_KEY=ce94860ccc8780b2bc5f00f31459d24e  # –¢–û–õ–¨–ö–û key_id - –ù–ï –†–ê–ë–û–¢–ê–ï–¢!
```

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
```bash
CLOUDRU_S3_ACCESS_KEY=502f76f0-9017-493d-bda4-9e1bb278da84:ce94860ccc8780b2bc5f00f31459d24e
#                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#                                     tenant_id                                 key_id
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Cloud.ru ML Inference

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–∑
- URI –æ–±—Ä–∞–∑–∞: `docling-granite-258m.cr.cloud.ru/paddleocr-vl-service:2.0.8`
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `:latest` (—É–∂–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ 2.0.8)

### –®–∞–≥ 2: –ó–∞–¥–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í —Ä–∞–∑–¥–µ–ª–µ **"Environment Variables"** –¥–æ–±–∞–≤—å—Ç–µ:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è |
|------------|----------|--------------|
| `USE_CLOUDRU_S3` | `true` | ‚úÖ –î–∞ |
| `CLOUDRU_S3_ENDPOINT` | `https://s3.cloud.ru` | ‚úÖ –î–∞ |
| `CLOUDRU_S3_BUCKET` | `bucket-winners223` | ‚úÖ –î–∞ |
| `CLOUDRU_S3_REGION` | `ru-central-1` | ‚úÖ –î–∞ |
| `CLOUDRU_S3_ACCESS_KEY` | `502f76f0-9017-493d-bda4-9e1bb278da84:ce94860ccc8780b2bc5f00f31459d24e` | ‚úÖ –î–∞ |
| `CLOUDRU_S3_SECRET_KEY` | `759469c88d6e450b584e2487c5174770` | ‚úÖ –î–∞ |
| `LOG_LEVEL` | `DEBUG` | ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. Health Check
```bash
curl -X GET "https://08d022b0-2b04-4a35-adb0-10b35daafed5.modelrun.inference.cloud.ru/health" \
  -H "x-api-key: <API_KEY>"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "status": "healthy",
  "paddleocr": "ready",
  "s3_storage": "configured",  // ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å "configured"
  ...
}
```

### 2. –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

```bash
curl -X POST "https://08d022b0-2b04-4a35-adb0-10b35daafed5.modelrun.inference.cloud.ru/ocr" \
  -H "x-api-key: <API_KEY>" \
  -F "file=@test_images/page_0001 (3).png" \
  -F "return_content=false"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "status": "success",
  "elapsed_sec": 132.057,
  "local_files": {
    "markdown": "/app/output/...",
    "json": "/app/output/..."
  },
  "s3_files": {
    "status": "uploaded",  // ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å "uploaded"
    "markdown": "https://bucket-winners223.s3.cloud.ru/ocr-results/...",
    "json": "https://bucket-winners223.s3.cloud.ru/ocr-results/...",
    "s3_path_markdown": "s3://bucket-winners223/ocr-results/...",
    "s3_path_json": "s3://bucket-winners223/ocr-results/..."
  }
}
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ S3

### 1. –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –∏–∑ S3

```bash
# –ß–µ—Ä–µ–∑ curl (bucket –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É–±–ª–∏—á–Ω—ã–º –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å presigned URL)
curl -O "https://bucket-winners223.s3.cloud.ru/ocr-results/<filename>.md"

# –ß–µ—Ä–µ–∑ Python (boto3)
python3 - <<'PY'
import boto3

s3 = boto3.client(
    's3',
    endpoint_url='https://s3.cloud.ru',
    aws_access_key_id='502f76f0-9017-493d-bda4-9e1bb278da84:ce94860ccc8780b2bc5f00f31459d24e',
    aws_secret_access_key='759469c88d6e450b584e2487c5174770',
    region_name='ru-central-1'
)

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ ocr-results
objects = s3.list_objects_v2(Bucket='bucket-winners223', Prefix='ocr-results/')
for obj in objects.get('Contents', []):
    print(f"{obj['Key']} - {obj['Size']} bytes - {obj['LastModified']}")

# –°–∫–∞—á–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
s3.download_file('bucket-winners223', 'ocr-results/<filename>.md', 'downloaded.md')
PY
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

**Markdown —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:**
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
- ‚úÖ –¢–∞–±–ª–∏—Ü—ã –≤ markdown —Ñ–æ—Ä–º–∞—Ç–µ
- ‚úÖ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏
- ‚úÖ –§–æ—Ä–º—É–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

**JSON —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:**
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–ª–æ–∫–æ–≤
- ‚úÖ –¢–∏–ø—ã –±–ª–æ–∫–æ–≤ (text, table, title, etc.)
- ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

---

## üîç –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: `s3_storage: "not_configured"` –≤ health check

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. `USE_CLOUDRU_S3` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `true`
2. –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞–∫–æ–π-—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `ACCESS_KEY`

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å, –∫–∞–∫–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `ACCESS_KEY` –≤ —Ñ–æ—Ä–º–∞—Ç–µ `tenant_id:key_id`

### –ü—Ä–æ–±–ª–µ–º–∞ 2: `"status": "failed"` –≤ `s3_files`

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `ACCESS_KEY` (–Ω–µ `tenant_id:key_id`)
2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ —É —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
3. Bucket –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç `ACCESS_KEY`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ bucket –≤ Cloud.ru Console

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –§–∞–π–ª—ã –Ω–µ –≤–∏–¥–Ω—ã –ø–æ –ø—É–±–ª–∏—á–Ω–æ–º—É URL

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. Bucket –Ω–µ –∏–º–µ–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç URL

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å boto3 –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (—Å–º. –ø—Ä–∏–º–µ—Ä –≤—ã—à–µ)
- –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ bucket (bucket policy)

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–° `LOG_LEVEL=DEBUG` –≤ –ª–æ–≥–∞—Ö –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
INFO: Initializing S3 client...
DEBUG: S3 endpoint: https://s3.cloud.ru
DEBUG: S3 bucket: bucket-winners223
DEBUG: ACCESS_KEY format: tenant_id:key_id  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
INFO: ‚úÖ S3 client initialized successfully
INFO: ‚úÖ S3 bucket access verified
INFO: S3 upload started: bucket=bucket-winners223
DEBUG:   Markdown: /app/output/... -> s3://bucket-winners223/ocr-results/... (1234 bytes)
DEBUG:   JSON: /app/output/... -> s3://bucket-winners223/ocr-results/... (5678 bytes)
INFO: ‚úÖ Markdown uploaded: s3://bucket-winners223/ocr-results/...
INFO: ‚úÖ JSON uploaded: s3://bucket-winners223/ocr-results/...
INFO: S3 upload completed successfully
```

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- [ ] –û–±—Ä–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –≤–µ—Ä—Å–∏–∏ 2.0.8
- [ ] –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–¥–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] `CLOUDRU_S3_ACCESS_KEY` –≤ —Ñ–æ—Ä–º–∞—Ç–µ `tenant_id:key_id`
- [ ] `USE_CLOUDRU_S3=true`
- [ ] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] Health check –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `"s3_storage": "configured"`
- [ ] –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ `s3_files.status` = `"uploaded"`
- [ ] –§–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ URL –≤ S3
- [ ] –ö–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ (Markdown –∏ JSON)

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ S3: `S3_CONFIGURATION_GUIDE.md`

---

**–û–±—Ä–∞–∑ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ

