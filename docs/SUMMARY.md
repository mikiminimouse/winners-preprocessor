# Сводка реализации Docker пайплайна для Docling

## Что было создано

### 1. Docker Compose конфигурация (`docker-compose.yml`)

Сервисы:
- **docling** - основной сервис обработки документов (использует Docling OCR)
- **libreoffice** - автоматическая конвертация DOC → DOCX
- **router** - FastAPI сервис для классификации и предобработки
- **scheduler** - APScheduler для автозапуска обработки
- **postgres** - опциональная БД для метаданных

### 2. Router/Preprocessor (`router/`)

**Функциональность:**
- Определение типа файла через magic bytes и mimetype
- Распознавание фейковых DOC (архивы, HTML)
- Безопасная распаковка архивов (ZIP, RAR) с защитой от zip bomb
- Классификация PDF (текстовый слой vs скан)
- Создание manifest.json для связывания файлов из архивов
- Нормализация unit'ов для Docling

**API Endpoints:**
- `GET /health` - проверка здоровья
- `POST /upload` - загрузка файла
- `POST /webhook` - webhook для внешних триггеров
- `POST /process_now` - немедленная обработка всех файлов
- `GET /status/{unit_id}` - статус обработки

### 3. Scheduler (`scheduler/`)

**Функциональность:**
- Периодический запуск обработки через APScheduler
- Настраиваемое расписание через переменные окружения (cron format)
- Автоматический вызов router API

### 4. Документация

- `README.md` - основная документация
- `DEPLOY.md` - инструкция по развертыванию
- `ARCHITECTURE.md` - детальное описание архитектуры
- `.env.example` - пример конфигурации

### 5. Структура директорий

```
winners_preprocessor/
├── docker-compose.yml
├── router/              # FastAPI сервис
├── scheduler/           # APScheduler
├── input/              # Входные файлы
├── output/             # Результаты
├── temp/               # Временные файлы
├── extracted/          # Распакованные архивы
├── normalized/         # Нормализованные unit'ы
└── archive/            # Оригинальные архивы
```

## Ключевые особенности реализации

### 1. Определение типов файлов

- Используется `python-magic` для определения MIME типа
- Проверка magic bytes для распознавания фейковых DOC
- Автоматическое определение PDF text vs scan через `pypdf`

### 2. Обработка архивов

- Безопасная распаковка с лимитами (размер, количество файлов)
- Санитизация имен файлов (защита от path traversal)
- Сохранение связи файлов через manifest.json

### 3. Конвертация DOC → DOCX

- Автоматическая конвертация через LibreOffice headless
- Мониторинг директорий на наличие .doc файлов
- Ожидание завершения конвертации перед передачей в Docling

### 4. Manifest система

- Каждый unit имеет manifest.json с метаданными
- Связывание файлов из архивов через archive_id
- Отслеживание статуса обработки

### 5. Маршрутизация обработки

Поддерживаемые routes:
- `pdf_text` - PDF с текстовым слоем
- `pdf_scan` - PDF скан (требует OCR)
- `docx` - DOCX файлы
- `image_ocr` - изображения (JPEG, PNG)
- `html_text` - HTML файлы
- `mixed` - смешанные документы (например, DOCX + изображение)

## Использование Docling OCR

- Заменен Tesseract на Docling OCR как основной движок
- Лучшее качество на сложных/шумных сканах
- Интеграция с Layout и Table Extraction
- CPU-оптимизированные модели для DigitalOcean

## Безопасность

1. Защита от zip bomb (лимиты на размер и количество файлов)
2. Санитизация имен файлов
3. Изоляция контейнеров через Docker network
4. HMAC подпись для webhook (опционально)

## Масштабирование

- Горизонтальное масштабирование через `docker-compose scale`
- Опциональная PostgreSQL для больших объемов
- Возможность добавления Redis для очереди задач
- Поддержка внешнего GPU сервера для LLM fallback

## Следующие шаги

1. **Настройка Docling образа:**
   - Замените `ibm/docling:latest` на ваш реальный образ
   - Или создайте кастомный Dockerfile для Docling

2. **Тестирование:**
   - Загрузите тестовые файлы разных форматов
   - Проверьте обработку архивов
   - Убедитесь, что manifest создается корректно

3. **Интеграция с реальным Docling API:**
   - Адаптируйте `trigger_docling()` под реальный API
   - Настройте обработку результатов

4. **Мониторинг:**
   - Добавьте Prometheus/Grafana для метрик
   - Настройте алерты на ошибки

5. **Оптимизация:**
   - Настройте OCR_THREADS под ваше железо
   - Оптимизируйте расписание scheduler
   - Добавьте кэширование при необходимости

## Важные замечания

1. **Docling образ:** Убедитесь, что используете правильный образ Docling или создайте свой на основе `docling_api_example.py`

2. **LibreOffice:** Может потребоваться настройка для работы с некоторыми форматами DOC

3. **7z для RAR:** Убедитесь, что `p7zip-full` установлен в router контейнере (уже включено в Dockerfile)

4. **Права доступа:** Проверьте права на директории input/, output/, etc.

5. **Ресурсы:** Мониторьте использование CPU/RAM, особенно при обработке больших файлов

## Поддержка форматов

✅ PDF (text layer)
✅ PDF (scan)
✅ DOC (старый формат)
✅ DOCX
✅ ZIP архивы
✅ RAR архивы (через 7z)
✅ JPEG/PNG изображения
✅ HTML (в т.ч. фейковые DOC)
✅ Смешанные документы (DOCX + изображение)

## Производительность

- Обработка 100 файлов: ~3-6 минут (зависит от размера и типа)
- CPU использование: 2 vCPU достаточно для базовой обработки
- RAM: 8GB достаточно для большинства случаев
- Масштабирование: горизонтальное через scale



