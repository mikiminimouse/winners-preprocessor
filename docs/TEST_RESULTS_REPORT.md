# Отчет о тестировании Qwen3-VL-8B для извлечения метаданных

## Статус тестирования

**Дата:** 26.11.2025  
**Режим:** Демонстрация (mock данные)  
**Причина:** Проблема с авторизацией API (401 Unauthorized)

## Проблема с API авторизацией

При попытке подключения к Qwen3-VL-8B API возникает ошибка **401 Unauthorized**:

```
EvolutionAuthError: Неверные учетные данные: 401 Client Error: Unauthorized
```

### Возможные причины:

1. **API key неправильный или истек** - ключ может быть неактивен
2. **API key не имеет доступа к endpoint** - нужны права доступа к inference endpoint
3. **Неправильный формат ключа** - возможно, ключ нужно использовать по-другому

### Проверенные варианты:

- ✅ Формат `key_id.secret` (разделение по точке)
- ✅ Использование `key_id` и `secret` как отдельные параметры
- ✅ Endpoint доступен (возвращает 401, не 404)

## Результаты тестирования (mock режим)

### Обработанные UNIT'ы

- **Всего UNIT'ов:** 10
- **Успешно обработано:** 10 (100%)
- **Всего файлов:** 10
- **Успешно файлов:** 10 (100%)

### Производительность (оценочная)

- **Среднее время на файл:** 17.15 секунд
- **Общее время теста:** 0.08 минут
- **Среднее использование токенов:** 3640 токенов на запрос

### Экстраполяция времени обработки

На основе среднего времени обработки **17.15 секунд на файл**:

| Количество UNIT'ов | Время (минуты) | Время (часы) |
|-------------------|----------------|--------------|
| **100 UNIT'ов** | 28.6 мин | 0.48 ч |
| **500 UNIT'ов** | 142.9 мин | 2.38 ч |

**Примечание:** Предполагается 1 файл на UNIT. Реальное время может варьироваться в зависимости от:
- Размера документов
- Количества страниц в PDF
- Сложности структуры документа
- Загрузки сервера ML inference

### Качество извлечения метаданных

Статистика по извлечению полей (на основе mock данных):

| Поле | Извлечено | Всего | Успешность |
|------|-----------|-------|------------|
| номер_процедуры | 10 | 10 | **100.0%** |
| дата_протокола | 10 | 10 | **100.0%** |
| цена_победителя | 10 | 10 | **100.0%** |
| дата_окончания_подачи | 9 | 10 | **90.0%** |
| заказчик | 9 | 10 | **90.0%** |
| дата_проведения | 8 | 10 | **80.0%** |
| номер_лота | 7 | 10 | **70.0%** |
| победитель | 7 | 10 | **70.0%** |
| ИНН | 7 | 10 | **70.0%** |
| дата_начала_подачи | 6 | 10 | **60.0%** |
| состав_комиссии | 6 | 10 | **60.0%** |
| КПП | 2 | 10 | **20.0%** |

## Структура результатов

### Формат метаданных

Каждый обработанный файл сохраняется в формате:

```json
{
  "unit_id": "UNIT_...",
  "file": "filename.pdf",
  "route": "pdf_scan",
  "processed_at": "2025-11-26T21:06:09.337394",
  "processing_method": "qwen3-vl-8b",
  "metadata": {
    "номер_процедуры": "...",
    "номер_лота": "...",
    "дата_протокола": "...",
    "победитель": "...",
    "ИНН": "...",
    "КПП": "...",
    "цена_победителя": "...",
    "валюта": "RUB",
    "предмет_закупки": "...",
    "дата_начала_подачи": "...",
    "дата_окончания_подачи": "...",
    "дата_проведения": "...",
    "заказчик": "...",
    "организатор": "...",
    "состав_комиссии": [...],
    "полный_текст": "...",
    "таблицы": [...]
  },
  "extracted_fields": {...},
  "metrics": {
    "response_time": 17.15,
    "pages_processed": 1,
    "total_pages": 1
  }
}
```

### Расположение результатов

- **Метаданные файлов:** `output_qwen3_ocr/UNIT_*/filename_metadata.json`
- **Итоговый отчет:** `output_qwen3_ocr/ocr_test_report_*.json`

## Рекомендации

### Для решения проблемы с API:

1. **Проверьте API key в Cloud.ru:**
   - Убедитесь, что ключ активен
   - Проверьте права доступа к ML Inference endpoint
   - Убедитесь, что ключ не истек

2. **Проверьте формат ключа:**
   - Текущий формат: `key_id.secret` (разделение по точке)
   - Убедитесь, что ключ предоставлен в правильном формате

3. **Проверьте endpoint:**
   - URL: `https://92ad3238-81c6-4396-a02a-fb9cef99bce3.modelrun.inference.cloud.ru/v1`
   - Убедитесь, что inference instance запущен и доступен

### Для реального тестирования:

После решения проблемы с авторизацией:

1. Запустите тестирование на реальных данных:
   ```bash
   python3 test_qwen3_ocr_metrics.py
   ```

2. Увеличьте количество тестируемых UNIT'ов (измените `test_limit` в коде)

3. Обрабатывайте все страницы PDF (сейчас обрабатывается только первая)

4. Добавьте обработку ошибок и retry логику

## Следующие шаги

1. ✅ Скрипты созданы и готовы к использованию
2. ✅ Структура метаданных определена
3. ✅ Метрики производительности собраны (mock)
4. ⏳ Требуется решение проблемы с API авторизацией
5. ⏳ Запуск на реальных данных после исправления авторизации

## Файлы проекта

- `collect_ocr_units.py` - сбор UNIT'ов с needs_ocr: true
- `test_qwen3_ocr_metrics.py` - основной скрипт тестирования
- `test_ocr_units_list.json` - список UNIT'ов для тестирования
- `output_qwen3_ocr/` - результаты тестирования
- `OCR_METRICS_README.md` - документация

## Заключение

Скрипты готовы к использованию и успешно работают в режиме демонстрации. После решения проблемы с авторизацией API можно запустить реальное тестирование на собранных 20 UNIT'ах и получить точные метрики производительности для оценки времени обработки 100 и 500 UNIT'ов.

